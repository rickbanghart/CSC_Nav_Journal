package Apache::Promse;
use Apache::Authenticate;
use DBI;
use Math::Trig qw(great_circle_distance deg2rad acos);
use Net::LDAP;
use Net::HTTP;
require Exporter;
use strict;
# a new comment
# define globals here
my %env;
my %config;
my $earth_radius = 3959;
open IN, '< /etc/httpd/conf/promse.conf';
&logthis('starting Promse');
while (<IN>) {
    $_=~ /^(.*?)(,)(.*?)$/;
    $config{$1}=$3;
    # &logthis("key is $1, value is $3");
}
my $timeout;
my $upload_dir;
sub logthis {
    my $message=shift;
    # my $execdir=$perlvar{'lonDaemons'};
    my $now=time;
    my $local=localtime($now);
    if (open(my $fh,">>/etc/httpd/logs/promse.log")) {
	print $fh "$local ($$): $message\n";
	close($fh);
    }
    return 1;
}
sub login_form {
    my ($r) = @_;
    $r->print('<div id="interiorHeader">');
    $r->print('<h2>Professional Development: Virtual Professional Development</h2>');
    $r->print('<h3>PROM/SE Login</h3>');
    $r->print('</div>');
    $r->print('<form name="form1" method="post" action="home">'."\n");
    $r->print('<fieldset>');
    $r->print('<label>User Name</label>');
    $r->print('<h6 align =right><a href="/webpages/llab_intro_Dec_05.html">Info for LessonLab users</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</h6>');
    $r->print('<input name="username" type="text" id="username" value="" size="25">');
    $r->print('<label>Password</label>');
    $r->print('<input name="password" type="password" id="password2" value="" size="25">');
    $r->print('<label><a href="/promse/register?target=new">Forgot your password?</a></label><br>');
    $r->print('<label>New to PRO/MSE VPD? Please click to <a href="/promse/register?target=new">register</a></label>');
    $r->print('<label>Please login</label>');
    $r->print('<p><input name="login" type="submit" id="login"  value="  LOGIN  " size ="25">');
    $r->print('</fieldset>');
    $r->print('<br><br>');    
}    
sub update_record {
    # assumes that it's ok to add this record
    # all referential integrity checks come 
    # before here
    my ($table, $id, $fields) = @_;
    my $qry;
    # hash contains field names as keys, hash values as field values
    # field values are "ready to go" (properly quoted or not depending
    # on data type)
    my $values_list = '';
    my $where_clause = ' WHERE ';
    # my $dbh = $Apache::Promse::env('dbh');
    # my $dbh = &db_connect();
    foreach my $field (keys %$fields) {
        $values_list .= $field.' = '.$$fields{$field}.', ';
    }
    foreach my $id_field (keys %$id) {
        $where_clause .= $id_field.' = '.$$id{$id_field}.' and ';
    }
    $values_list =~ s/, $//;
    $where_clause =~ s/ and $//;
    $qry = "update $table set $values_list $where_clause ";
    &logthis($qry);
    $Apache::Promse::env{'dbh'}->do($qry);
#    print "<br>".$qry."<br>";
    return $Apache::Promse::env{'dbh'}->errstr;
#    return $qry;
}
sub javascript {
    my ($r) = @_;
    $r->print(qq~
    function onloadFunctions(section,page){
//Highlight the current section in the persistent menu
    document.getElementById('nav'+ section).className='active'

if (page!='NULL') {
//Highlight the current page in interior menu
    liPage=document.getElementById(page);
    liPage.firstChild.className= "active"


//Highlight menu items that have submenus with down arrow
    var ULs = document.getElementsByTagName('UL');

    for (var i=0;i<ULs.length;i++) {
        if (ULs[i].id.indexOf('subMenu')!=-1) {
            ULs[i].parentNode.firstChild.className="expandActive"
        }
    }

//Display nested ULs if parent or member li is active and highlight parent with down arrow

    for (i=0; i<liPage.childNodes.length; i++) {
      var node=liPage.childNodes[i];

        if (node.nodeName=="UL"){
        liPage.firstChild.className="subMenuActive"
        //node.style.display="block"
		node.className="show"
        }
    }

    if (liPage.parentNode.parentNode.nodeName=="LI") {
        //liPage.parentNode.style.display="block"
		liPage.parentNode.className="show"
        liPageGrandParent=liPage.parentNode.parentNode
        liPageGrandParent.firstChild.className= "subMenuActive"
    }


}


// set minumum height for IE.
      var wrapperColumnHeight=document.getElementById('wrapperColumn').offsetHeight;

        if (document.all && wrapperColumnHeight<347) {
               document.getElementById('wrapperColumn').style.height=37.5 + 'em';
            }




/*This script is a fix for IE not recognizing the css hover for elements other then links
        See http://www.alistapart.com/articles/dropdowns/ for reference */

    //First check to see if browser is IE
     if (document.all&&document.getElementById) {
        //loop through each li in the parent ul
        navRoot = document.getElementById("navPersistent");
            for (i=0; i<navRoot.childNodes.length; i++) {
            node = navRoot.childNodes[i];
                if (node.nodeName=="LI") {
            //change name of class for li depending on mouseover state
                    node.onmouseover=function() {
                        this.className+="over";
                    }
                    node.onmouseout=function() {
                        this.className=this.className.replace("over", "");
                    }
                }
            }
      }
}

function toggleHomeIntro(showID,hideID,hideID2){
    document.getElementById('dd'+ showID).style.left=0
    if (hideID) {
        document.getElementById('dd'+ hideID).style.left='-9999px'
    }
    if (hideID2) {
        document.getElementById('dd'+ hideID2).style.left='-9999px'
    }

    dlRoot = document.getElementById("homeIntroSectionMenu");
    for (i=0; i<dlRoot.childNodes.length; i++) {
       node = dlRoot.childNodes[i];
		if (node.id=='dt'+ showID) {
			node.firstChild.className="active"
		}
		if (node.id=='dt'+ hideID || node.id=='dt'+ hideID2){
			node.firstChild.className=""
		}
	}
}
~);
    return 'ok';
}

sub save_record {
    # assumes that it's ok to add this record
    # all referential integrity checks come 
    # before here
    my ($table, $fields, $id) = @_;
    my $qry;
    # hash contains field names as keys, hash values as field values
    # field values are "ready to go" (properly quoted or not depending
    # on data type)
    my $field_list='';
    my $value_list='';
    # my $dbh = &db_connect();
    $field_list = join ',', (keys(%$fields));
    $value_list = join ',', (values(%$fields));
    $qry = 'insert into '.$table.' ('.$field_list.') values ('.$value_list.')';
    $Apache::Promse::env{'dbh'}->do($qry);
    &logthis($qry);
    if (defined $id) {
        $qry = "select LAST_INSERT_ID() as my_id";
        my $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
        $sth->execute();
        my $row = $sth->fetchrow_hashref;
        my $record_id = $$row{'my_id'};
        return $record_id;
    } else {
        return $Apache::Promse::env{'dbh'}->errstr;
    }
}

sub mentor_menus {
    my ($r) = @_;
    my $url = "mentor?token=".$Apache::Promse::env{'token'}.";target=resource";
    my $menu = $r->param('menu');
    print '<p style="content"><span>';
    if ($menu eq 'browse') {
        print '<a href="'.$url.'&menu=browse;sortfield=date" ><strong style="content">[ Browse ]</strong></a>';
    } else {
        print '<a href="'.$url.'&menu=browse;sortfield=date">[ Browse ]</a>';
    }
    if ($menu eq 'upload') {
        print '<a href="'.$url.'&menu=upload;sortfield=date" ><strong style="content">[ Upload ]</strong></a>';
    } else {
        print '<a href="'.$url.'&menu=upload;sortfield=date">[ Upload ]</a>';
    }
    
    print '</span></p>';
    return 'ok';
}
sub resource_menu {
    my ($r) = @_;
    my $url = &get_base_url($r);
    $url = $url."?token=".$Apache::Promse::env{'token'}.";target=resource";
    my $menu = $r->param('menu');
    print '<p style="content"><span>';
    if ($menu eq 'browse') {
        print '<a href="'.$url.'&menu=browse;sortfield=date" ><strong style="content">[ Browse ]</strong></a>';
    } else {
        print '<a href="'.$url.'&menu=browse;sortfield=date">[ Browse ]</a>';
    }
    if ($menu eq 'upload') {
        print '<a href="'.$url.'&menu=upload;sortfield=date" ><strong style="content">[ Upload ]</strong></a>';
    } else {
        print '<a href="'.$url.'&menu=upload;sortfield=date">[ Upload ]</a>';
    }
    
    print '</span></p>';
    return 'ok';
}
sub question_menu {
    my ($r) = @_;
    my $url;
    $url = "apprentice?token=".$Apache::Promse::env{'token'}.";target=questions";
    my $menu = $r->param('menu');
    print '<p style="content"><span>';
    if ($menu eq 'inbox') {
        print '<a href="'.$url.'&menu=inbox;sortfield=date" ><strong style="content">[ Answers to my Questions ]</strong></a>';
    } else {
        print '<a href="'.$url.'&menu=inbox;sortfield=date">[ Answers to my Questions ]</a>';
    }
    print '     ';
    if ($menu eq 'outbox') {
        print '<a href="'.$url.'&menu=outbox;sortfield=date"><strong>[ Questions I have asked ]</strong></a>';
    } else {
        print '<a href="'.$url.'&menu=outbox;sortfield=date">[ Questions I have asked ]</a>';
    }
    print '     ';
    if ($menu eq 'compose') {
        print '<a href="'.$url.'&menu=compose&step=1"><strong>[ Ask a Question ]</strong></a>';
    } else {
        print '<a href="'.$url.'&menu=compose&step=1">[ Ask a Question ]</a>';
    }
    print '     ';
#disabled drafts    
#    if ($menu eq 'drafts') {
#        print '<a href="'.$url.'&menu=drafts;sortfield=date"><strong>[ Draft a Question ]</strong></a>';
#    } else {
#        print '<a href="'.$url.'&menu=drafts;sortfield=date">[ Draft a Question ]</a>';
#   }
    print '</span></p>';
    return 'ok';
}
sub message_menus {
    my ($r) = @_;
    my $url = $r->self_url();
    if ($url =~ /apprentice\?/) {
        $url = "aprentice?token=".$Apache::Promse::env{'token'}.";target=message";
    } else {
        $url = "home?token=".$Apache::Promse::env{'token'}.";target=message";
    }
    my $menu = $r->param('menu');
    print '<p style="content"><span>';
    if ($menu eq 'inbox') {
        print '<a href="'.$url.'&menu=inbox;sortfield=date" ><strong style="content">[ Inbox ]</strong></a>';
    } else {
        print '<a href="'.$url.'&menu=inbox;sortfield=date">[ Inbox ]</a>';
    }
    if ($menu eq 'outbox') {
        print '<a href="'.$url.'&menu=outbox;sortfield=date"><strong>[ Outbox ]</strong></a>';
    } else {
        print '<a href="'.$url.'&menu=outbox;sortfield=date">[ Outbox ]</a>';
    }
    if ($menu eq 'compose') {
        print '<a href="'.$url.'&menu=compose"><strong>[ Compose ]</strong></a>';
    } else {
        print '<a href="'.$url.'&menu=compose">[ Compose ]</a>';
    }
    if ($menu eq 'drafts') {
        print '<a href="'.$url.'&menu=drafts;sortfield=date"><strong>[ Drafts ]</strong></a>';
    } else {
        print '<a href="'.$url.'&menu=drafts;sortfield=date">[ Drafts ]</a>';
    }
    if ($menu eq 'address') {
        print '<a href="'.$url.'&menu=address"><strong>[ Address Book ]</strong></a>';
    } else {
        print '<a href="'.$url.'&menu=address">[ Address Book ]</a>';
    }
    print '</span></p>'."\n";
    return 'ok';
}
sub discussion {
    my ($r) = @_;
       
}
sub top_searches {
    my ($r) = @_;
    $r->print('<h4>Top Searches</h4>'."\n");
    $r->print('<div id="lookupScroller">'."\n");
    $r->print('<strong>Fractions</strong>'."\n");
    $r->print('<p class="content">Over the past month, fractions has been the most popular search topic.</p>'."\n");
    $r->print('<a href = "home?token='.$Apache::Promse::env{'token'}.'&target=mentorquestions&mentorid=1">See the top ten search terms.</a>'."\n");
    $r->print('</div>'."\n");
 
    return 'ok';
}
sub top_questions {
    my ($r) = @_;
    $r->print('<h4>Top Question</h4>'."\n");
    $r->print('<div id="lookupScroller">'."\n");
    $r->print('<strong>Statistics and Probability</strong>');
    $r->print('<p class="content">The current top question is about teaching basic probability concepts to 4th grade students.</p>'."\n");
    $r->print('<a href = "home?token='.$Apache::Promse::env{'token'}.'&target=mentorquestions&mentorid=1">See the top question.</a>');
    $r->print('</div>'."\n");
    return 'ok';
}
sub top_forum {
#print qq~            
#            <strong>TOP 5 FORUM TOPICS</strong></p>
#            <p class="content">Here are the top 5 topics on the PROM/SE forum:</p>
#              <span> Will appear here</span>
#            
#~;   
}         
sub matrix {
    my ($r) = @_;
    $r->print('<div id="floatLeft">'."\n");
    $r->print('<table><caption>Topic/Resource Matrix</caption>');
    $r->print('<thead><th scope="col">Topic</th><th>K-4</th>'."\n");
    $r->print('<th>5-6</th><th>7-8</th><th>9-12</th><th>College</th></tr>');
    $r->print('</thead><tbody>');
    $r->print('<tr<td  scope="row">Number and Operations</td><td>Expand</td><td>Expand</td><td>Expand</td><td>Expand</td><td>Expand</td></tr>');
    $r->print('<tr><td  scope="row">Fractions</td><td>Expand</td><td>Expand</td><td>Expand</td><td>Expand</td><td>Expand</td></tr>');
    $r->print('<tr><td scope="row">Geometry and Measurement</td><td>Expand</td><td>Expand</td><td>Expand</td><td>Expand</td><td>Expand</td></tr>');
    $r->print('<tr><td scope="row">Rational Number Systems</td><td>Expand</td><td>Expand</td><td>Expand</td><td>Expand</td><td>Expand</td></tr>');
    $r->print('<tr><td scope="row">Ration and Proportion</td><td>Expand</td><td>Expand</td><td>Expand</td><td>Expand</td><td>Expand</td></tr>');
    $r->print('<tr><td scope="row">Equations and Lines</td><td>Expand</td><td>Expand</td><td>Expand</td><td>Expand</td><td>Expand</td></tr>');
    $r->print('<tr><td scope="row">Geometry</td><td>Expand</td><td>Expand</td><td>Expand</td><td>Expand</td><td>Expand</td></tr>');
    $r->print('<tr><td scope="row">Mathematics of Change</td><td>Expand</td><td>Expand</td><td>Expand</td><td>Expand</td><td>Expand</td></tr>');
    $r->print('<tr><td scope="row">Probability & Statistics</td><td>');
    $r->print('Expand</td><td>Expand</td><td>Expand</td><td>Expand</td><td>Expand</td></tr>');
    $r->print('<tr class="bottomRow"><td colspan=6></td>');
    $r->print('</tbody>');
    $r->print('</table>');
    $r->print('</div>'."\n");
    return 'ok';
}
  

sub top_help {
    my ($r) = @_;
    print qq~ 
      <div id="floatRight">
        <table><caption>Help Topics</caption>
            <thead>
            <tr>
            <th scope="col">Role</th>
            <th scope="col">Topic</th>
            </tr>
        </thead>
        <tbody >
    ~;
    $r->print('<tr><td scope="row">Apprentice</td><td><a href="home?token='.$Apache::Promse::env{'token'}.'&target=help&topic=preferences">Setting Preferences</a></td></tr>');
    $r->print('<tr><td scope="row">Apprentice</td><td><a href="home?token='.$Apache::Promse::env{'token'}.'&target=help&topic=finding">Finding Resources</a></td></tr>');
    $r->print('<tr><td scope="row">Apprentice</td><td><a href="home?token='.$Apache::Promse::env{'token'}.'&target=help&topic=requirements">System Requirements</a></td></tr>');
    $r->print('<tr><td scope="row">Apprentice</td><td><a href="home?token='.$Apache::Promse::env{'token'}.'&target=help&topic=passwords">Passwords</a></td></tr>');
    $r->print('<tr><td scope="row">Mentor</td><td><a href="home?token='.$Apache::Promse::env{'token'}.'&target=help&topic=answering">Answering Questions</a></td></tr>');
    print qq~ 			
			<tr class="bottomRow">

            <td colspan="2">
            </td>
            </tr>
			</tbody>
            </table>
        </div>
   
              
~;
}
sub mentor_of_month {
    my ($r)=@_;
    my $qry = "";
    my $sth;
    $qry = "select t2.user_id, sum(rating) as rating, lastname, firstname 
            FROM answer_ratings t1, answers t2, users t3 
            WHERE t2.user_id = t3.id and t1.answer_id = t2.answer_id group by t2.user_id order by rating desc limit 5";
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    $r->print('<h4>Meet PROMSE Mentors</h4>');
    $r->print('<div id="lookupScroller">'."\n".'<strong>Top-rated Mentor</strong>');
    if ($sth->rows) {
        while (my $row = $sth->fetchrow_hashref()) {
            $r->print('<p class="content">'.$$row{'firstname'}.' '.$$row{'lastname'}.' is the top-rated mentor this month, based on the evaluation of answers given.<br>');
            $r->print('<a href = "home?token='.$r->param('token').'&target=mentorquestions&mentorid='.$$row{'user_id'}.'">See the top responses.</a>');
        }
    } else {
        $r->print('<span>No mentors have answered questions yet.</span>'."\n");
    }
    $r->print('</div>'."\n");
    return 'ok';
}
sub db_connect {
    my $dsn = "DBI:mysql:database=promse;host=localhost;port=3306";
    my $dbh = DBI->connect($dsn, 'root', 'pt3linux') or &logthis ("can't connect to db");
    return $dbh;    
}
sub locations {
    my ($r) = @_;
    my $district_id = $r->param('districtid');
    my $qry = "select district_name from districts where district_id = $district_id";
    my $sth;
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    my $row = $sth->fetchrow_hashref;
    my $district_name = $$row{'district_name'};
    $qry = "select school from locations where district_id = $district_id order by school ";
    
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    $r->print('<p class="content"><strong>Locations in '.$district_name.':</strong></p><span><blockquote>');
    while ($row=$sth->fetchrow_hashref) {
          $r->print ($$row{'school'}.'<br>');
    }    
    $r->print('</blockquote></span>');
    return 'ok';
}
sub districts {
    my ($r) = @_;
    my $partner_id = $r->param('partnerid');
    my $sth;
    my $sth2;
    my $qry;
    my $partner_name;
    if (defined $r->param('districtid') ){
        &locations($r);
        return 'ok';
    } else {  
        if ($partner_id eq 'all') {  
            $qry = "select partner_name, partner_id from partners order by partner_name";
        } else {
            $qry = "select partner_name, partner_id from partners where partner_id = $partner_id";
        }
        $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
        my $num_rows = $sth->execute();
        while (my $partner = $sth->fetchrow_hashref()) {
            $partner_name = $$partner{'partner_name'};
            $partner_id = $$partner{'partner_id'};
            $qry = "select district_id, district_name, county, county_num, agency_type, students, free_lunch, reduced_lunch from districts where partner_id = $partner_id order by district_name";
            $sth2 = $Apache::Promse::env{'dbh'}->prepare($qry);
            $sth2->execute();
            $r->print('<p class="content"><strong>Districts in '.$partner_name.':</strong></p><span><blockquote>');
            while (my $row=$sth2->fetchrow_hashref) {  
                $r->print('<a href=admin?target=partners&districtid='.$$row{'district_id'}.'&partnerid='.$partner_id.'&token='.$Apache::Promse::env{'token'}.'>');
                $r->print($$row{'district_name'}.', '.$$row{'county'}.'('.$$row{'county_num'}.')</a><br>');
            }
            $r->print('</span></blockquote>');
        }
    }
    return 'ok';
}
sub associates {
    my ($r) = @_;
    my $qry = "select * from associates order by last_name, first_name";
    my $sth;
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    my $result = $sth->execute();
    $r->print('<p class="content"><strong>Associates:</strong></p><span><blockquote>');
    while (my $row = $sth->fetchrow_hashref()) {
        if ($$row{'last_name'} eq '') {
            # $r->print('unassigned<br />');
        } else {
            $r->print ('<a href="admin?token='.$Apache::Promse::env{'token'}.'&target=partners&associd='.$$row{'associate_id'}.'&subtarget=edit">'.$$row{'last_name'}.', '.$$row{'first_name'}.'</a><br />');
        }
    }
    $r->print('</blockquote></span>');
    return 'ok';
}

sub partner_menu {
    my ($r) = @_;
    my $base_url = "admin?token=".$Apache::Promse::env{'token'}."&target=partners";
    $r->print('<span>[ <a href="'.$base_url.'">Partners</a> ][ <a href="'.$base_url.'&partnerid=all">Districts</a> ][ <a href="'.$base_url.'&partnerid=all&districtid=all">Locations</a> ][ <a href="'.$base_url.'&subtarget=associates">Associates</a> ]<br /></span><hr>');
    return 'ok';
}
 
sub partner_forms {
    my ($r) = @_;
    my $assoc_id = $r->param('associd');
    my $qry = "select * from associates where associate_id = $assoc_id";
    my $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    my $row = $sth->fetchrow_hashref();
    $r->print('<span>');
    $r->print('<table><form method="post" action="admin">');
    foreach my $field (sort (keys(%$row))) {
        $r->print('<tr><td>');
        if ($field eq 'associate_id') {
            $r->print($field.'</td><td>'.$$row{$field}.'<input type="hidden" name="'.$field.'" value="'.$$row{$field}.'"></td></tr>');
        } else {
            $r->print($field.'</td><td><input type="text" name="'.$field.'" value="'.$$row{$field}.'"></td></tr>');
        }
    }
    $qry  = "select * from locations, assoc_locs where assoc_id = $assoc_id and location_id = loc_id";
    
    $r->print('</table><input type="submit"></form></span>');
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    
    $r->print('<p><span><strong>Associate is located:</strong></p><p>');
    while (my $loc_hashref = $sth->fetchrow_hashref()) {
        $r->print($$loc_hashref{'school'}.'('.$$loc_hashref{'Grade_range'}.') <br>');
    }
    
    return 'ok';
}
sub partners {
    my ($r) = @_;
    my $qry = "";
    my $sth;
    my $save_partner;
    my $save_district; 
    if (defined $r->param('partnerid') ){
        &districts($r);
        return 'ok';
    } else {     
    $qry = "select partner_name, partner_id, state from partners order by partner_name";
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    $r->print('<p class="content"><strong>Partners:</strong></p><blockquote><span>');
    while (my $row=$sth->fetchrow_hashref) {  
        $r->print('<a href=admin?target=partners&partnerid='.$$row{'partner_id'}.'&token='.$Apache::Promse::env{'token'}.'>');
        $r->print($$row{'partner_name'}.', '.$$row{'state'}.'('.$$row{'partner_id'}.')</a><br>');
    }
    $r->print('</span></blockquote>');
    return;
    }
    $qry = "select partners.partner_name, state, district_name, school from partners, districts, locations where partners.partner_id = districts.partner_id";
    $qry .= " and locations.district_id = districts.district_id order by partner_name, district_name, school";
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    while (my $row=$sth->fetchrow_hashref) {
        if ($$row{'partner_name'} eq $save_partner) {
            if ($$row{'district_name'} eq $save_district) {
                $r->print($$row{'school'}."<br />");
            } else {
                $save_district = $$row{'district_name'};
                $r->print("<strong>District - ".$$row{'district_name'}."</strong><br />");
                $r->print($$row{'school'}."<br />");
            }
        } else {
            $save_partner = $$row{'partner_name'};
            $save_district = $$row{'district_name'};
            $r->print('<strong><font color="#990000">Partner - '.$$row{'partner_name'}.", ".$$row{'state'}."</font></strong><br />");
            $r->print("<strong>District - ".$$row{'district_name'}."</strong><br />");
            $r->print($$row{'school'}."<br />");
            
        }
    }
}
sub sidebar_options {
    my ($screen, $r) = @_;
    # --------------- admin side bar
    if ($screen eq 'admin') {
        print '<tr><td align="left" valign="top" class="sidebar"><br> ';
        print '&middot; <a href="admin?target=userroles;token='.$Apache::Promse::env{'token'}.'">User Roles</a><hr />';
        print '&middot; <a href="admin?target=partners;token='.$Apache::Promse::env{'token'}.'">Partners, etc. </a><hr />';
        print '&middot; <a href="admin?target=schedule&token='.$Apache::Promse::env{'token'}.'&menu=browse">Announcements</a></td></tr>';
    # ---------------- home side bar
    } elsif ($screen eq 'home'){
        my $url = 'home?';
        print '<tr><td align="left" valign="top" class="sidebar"><br>';
        print '&middot; <a href="home?token='.$Apache::Promse::env{'token'}.';target=message;menu=inbox;sortfield=date">Messaging</a><hr />';
        print '&middot; <a href="home?token='.$Apache::Promse::env{'token'}.';target=discussion;menu=inbox">Discussion</a><hr>';
        print '&middot; <a href="home?token='.$Apache::Promse::env{'token'}.';target=whoson;menu=inbox">Who'."'".'s on</a><hr>';
        print '&middot; <a href="home?token='.$Apache::Promse::env{'token'}.';target=preferences;menu=inbox">Preferences</a><hr>';
        print '&middot; <a href="home?token='.$Apache::Promse::env{'token'}.';target=help">Help</a></td></tr>';
    # ---------------- mentor side bar         
    } elsif ($screen eq 'mentor'){
        print '<tr><td align="left" valign="top" class="sidebar"><br>';
        print '&middot; <a href="mentor?token='.$Apache::Promse::env{'token'}.';target=questions;menu=inbox">Answer Questions</a><hr />';
        print '&middot; <a href="mentor?token='.$Apache::Promse::env{'token'}.';target=resource;menu=browse">Resources</a><hr>';
        print '&middot; <a href="mentor?token='.$Apache::Promse::env{'token'}.';target=framework;menu=browse">Framework</a><hr>';
        print '&middot; <a href="mentor?token='.$Apache::Promse::env{'token'}.';target=ohiomath;menu=browse">Ohio Math</a>';
        print '</td></tr>';
    # ---------------- default side bar         
    } elsif ($screen eq 'apprentice'){
        my $url = 'apprentice';
        print '<tr><td align="left" valign="top" class="sidebar"><br>';
        print '&middot; <a href="'.$url.'?token='.$Apache::Promse::env{'token'}.';target=search;menu=inbox">Search</a><hr>';
        print '&middot; <a href="'.$url.'?token='.$Apache::Promse::env{'token'}.';target=framework;menu=browse">Framework</a><hr>';
        print '&middot; <a href="home?token='.$Apache::Promse::env{'token'}.';target=message;menu=inbox">Messaging</a><hr>';
        print '&middot; <a href="'.$url.'?token='.$Apache::Promse::env{'token'}.';target=questions;menu=inbox">Ask a Mentor</a><hr />';
        print '&middot; <a href="'.$url.'?token='.$Apache::Promse::env{'token'}.';target=help">Help</a></td></tr>';
    } elsif ($screen eq 'editor'){
        my $url = 'editor';
        print '<tr><td align="left" valign="top" class="sidebar"><br>';
        print '&middot; <a href="'.$url.'?token='.$Apache::Promse::env{'token'}.';target=resource;menu=browse">Resources</a><hr>';
        print '&middot; <a href="'.$url.'?token='.$Apache::Promse::env{'token'}.';target=keyword;menu=browse">Keywords</a><hr>';
        print '&middot; <a href="home?token='.$Apache::Promse::env{'token'}.';target=message;menu=inbox">Messaging</a><hr />';
        print '&middot; <a href="'.$url.'?token='.$Apache::Promse::env{'token'}.';target=help">Help</a></td></tr>';
        
    } else {
        my $url = 'home';
        print '<tr><td align="left" valign="top" class="sidebar"><br>';
        print '&middot; <a href="'.$url.'?token='.$Apache::Promse::env{'token'}.';target=message;menu=inbox">Messaging</a><hr />';
        print '&middot; <a href="'.$url.'?token='.$Apache::Promse::env{'token'}.';target=help">Help</a></td></tr>';
    } 
    return "OK";    
}
sub keyword {
    my ($r) = @_;
    my $qry = "";
    my $sth;
    my $count;
    $qry = "select word from lexicon where word >= 'A' and word < 'B'";
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $count = $sth->execute();
    $r->print("found $count words");
    while (my @row = $sth->fetchrow_array) {
        $r->print($row[0].'<br />');
    }
    $r->print('Managing Keywords');
    return 'ok';
}
sub get_user_roles {
    my $user_roles;
    my $qry = "select role from roles, userroles ";
    $qry .= " where ".$Apache::Promse::env{'user_id'}." = userroles.user_id and roles.id = userroles.role_id";
    &logthis($qry);
    my $sth = $Apache::Promse::env{'dbh'}->prepare($qry) or &logthis($Mysql::db_errstr);
    $sth->execute();
    while (my @row = $sth->fetchrow_array) {
        $user_roles .= $row[0].",";
    }
     return $user_roles;
#    return $qry;
}

# reads instant messages
sub read_im {
    my ($r,$im_expire) = @_;
    my $qry = "";
    my $sth;
    $qry="select firstname, lastname, timediff(now(), time_sent) as age, content from im, users";
    $qry.=" where im.sender = users.id and (recipient =".$Apache::Promse::env{'user_id'}.") and timediff(now(), time_sent) < '$im_expire'";
    $qry.=" order by time_sent";
    $sth=$Apache::Promse::env{'dbh'}->prepare($qry);
   
    $sth->execute();
    if ($sth->rows) {
        
        $r->print('<h4>Instant Messages</h4>'."\n");
        $r->print('<div id="lookupScroller">'."\n");
        while (my $row = $sth->fetchrow_hashref()) {
            $r->print('From '.$$row{'firstname'}.' '.$$row{'lastname'});
            $r->print('<p>sent '.$$row{'age'}.' ago: '.$$row{'content'});
            $r->print('<hr>');
        }
        $r->print('</div>'."\n");
    } else {
        $r->print('<h3>Instant Messages</h3>'."\n");
        $r->print('<div id="lookupScroller">'."\n");
        $r->print('No recent instant messages have been sent.'."\n");
        $r->print('<p>Change your settings if you would rather not see Instant Messages.</p>'."\n");
        $r->print('</div>'."\n");
    }
    return 'ok';
    
}
sub purge_im {
    my ($r) = @_;
    my $qry = "";
    my $sth;
    $qry = "delete from im where ";
    return 'ok';
}

sub mark_delete_im {
    my ($r) = @_;
    my $qry = "";
    my $sth;
    $qry = "update im set deleted = 1 where recipient = ".$Apache::Promse::env{'user_id'};
    $sth=$Apache::Promse::env{'dbh'}->do($qry);
    return 'ok';
}

sub send_im {
    my ($r) = @_;
    my %fields;
    $fields{'sender'} = $Apache::Promse::env{'user_id'};
    $fields{'recipient'} = $r->param('recipient');
    $fields{'content'} = &fix_quotes($r->param('message'));
    $fields{'time_sent'} = ' now() ';
    $fields{'delivered'} = 0;
    &save_record('im',\%fields);
}
sub compose_im {
    my ($r) = @_;
    my %fields;
    $r->print('<span>Send an instant message to:</span>');
    $fields{'recipient'} = $r->param('userid');
    $fields{'target'} = 'im';
    $fields{'action'} = 'send';
    $r->print('');
    $r->print('<form method="post" action="home">');
    $r->print('<input type="text" name="message" /><br />');
    $r->print('<input type="submit" value="Send Instant Message"');
    &hidden_fields($r, \%fields);
    $r->print('</form>');
}
sub zips_within_radius {
    my ($zip, $radius) = @_;
    my $min_lat;
    my $max_lat;
    my $min_long;
    my $max_long;
    #start by computing min and max of lat and long
    
    return 'ok';
}
sub distance {
    my ($lat1, $lon1, $lat2, $lon2) = @_;
    # returns distance in miles between two points
    # latitudes and longitudes are in radians
    # my $radius = 3663.1; #constant for radius of earth in miles (polar)
    # defined in global my $radius = 3959; #constant for radius of earth in miles (mean radius)
    return acos(cos($lat1) * cos($lon1) * cos($lat2) * cos($lon2) + cos($lat1) * sin($lon1) * cos($lat2) * sin($lon2) + sin($lat1) * sin($lat2)) * $earth_radius;
}

sub who_is_close {
    my ($r) = @_;
    my $qry = "";
    my $sth;
    my %fields;
    my $max_lat;
    my $max_lon;
    my $min_lat;
    my $min_lon;
    my $center_lat;
    my $center_lon;
    $fields{'target'} = 'whosclose';
    $fields{'action'} = 'search';
    $r->print('<div id="interiorHeader">');
    $r->print('<h2>The following people are close.</h2>');
  #	$r->print('<h3>You are not alone...</h3>');
    $r->print('</div>');
    $r->print('Your zip code is: ');
    my $location = &get_user_location($Apache::Promse::env{'user_id'});
    $r->print($$location{'zip'});
    $qry = "select * from zip_codes where zip_code = $$location{'zip'}";
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    my $row = $sth->fetchrow_hashref();
    $center_lat = $$row{'latitude'};
    $center_lon = $$row{'longitude'};
    
    $r->print('<br>Your zip location is:'.$$row{'longitude'}.'-'.$$row{'latitude'});
    $r->print('<br>Select a distance:');
    $r->print('<form method=post action="home"');
    $r->print('<select name=distance>');
    $r->print('<option>5</option>');
    $r->print('<option>10</option>');
    $r->print('<option>15</option>');
    $r->print('<option>25</option>');
    
    $r->print('</select>');
    $r->print('<br><input type="submit" value="Search">');
    &hidden_fields($r, \%fields);
    $r->print('</form>');
    $r->print('Here is test stuff<br>');
    
    # Notice the 90 - latitude: phi zero is at the North Pole.
    my @L = (deg2rad(-0.5), deg2rad(90 - 51.3));
    my @T = (deg2rad(139.8),deg2rad(90 - 35.7));
    my $distance = $r->param('distance');
    my $dist_in_rads = $distance/$earth_radius;
    $qry = "select zip_code, lastname, firstname from users t1, locations t2, zip_codes t3, user_locs t4  ";
    $qry = $qry."where longitude > ".($center_lon - $dist_in_rads);
    $qry = $qry." and longitude < ".($center_lon + $dist_in_rads);
    $qry = $qry." and latitude < ".($center_lat + $dist_in_rads);
    $qry = $qry." and latitude > ".($center_lat - $dist_in_rads);
    $qry = $qry." and t4.user_id = t1.id";
    $qry = $qry." and t4.loc_id = t2.location_id";
    $qry = $qry." and t3.zip_code = t2.zip";
    $r->print('here is the query'.$qry."<br>");
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    $r->print('People within range');
    while (my $row = $sth->fetchrow_hashref()) {
        $r->print('<br>'.$$row{'lastname'}.$$row{'zip_code'});
    }
    $r->print($dist_in_rads. ' is the distance in rads<br>');
    
    my $km = great_circle_distance(@L, @T, 6378);
    $r->print($km. ' is the distance<br>');
    $r->print('<br>From other routine: '.&distance(1.1,1.1,1.0,1.0));

    return 'ok';    
}
sub who_is_on {
    my ($r) = @_;
    my $qry = "";
    # my $dbh = &db_connect();
    my $sth;
    # first, let's log off those who have been inactive for a long time
    #&logthis("timeout is $config{'timeout'}");
    $qry ="delete from log where timediff(now(),last_act) > '".$config{'timeout'}."'";
    $Apache::Promse::env{'dbh'}->do($qry);
    $qry = "select lastname, firstname, last_act, timediff(now(),last_act) as time, users.id as userid from log, users where log.user_id = users.id order by lastname";
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    $r->print('<div id="interiorHeader">');
    $r->print('<h2>The following people are on.</h2>');
  #	$r->print('<h3>You are not alone...</h3>');
    $r->print('</div>');
   
    $r->print('<table><caption>Currently Online</caption><thead><tr>');
    print '<th>Name</th>';
    print '<th>Time of Last Activity</th>';
    print '<th>Idle Time</th></tr>';
    $r->print('</thead><tbody>');
    while (my $row = $sth->fetchrow_hashref) {
        print '<tr><td><a href="home?token='.$Apache::Promse::env{'token'}.'&target=im&userid='.$$row{'userid'}.'">'.$$row{'firstname'}." ".$$row{'lastname'}.'</a></td>';
        print '<td >'.$$row{'last_act'}."</td>";
        print '<td >'.$$row{'time'}."</td></tr>";
    }
    $r->print('<tr class="bottomRow"><td colspan="3"></td></tr>');
    print '</tbody></table>';
    
    return 'ok';
}
sub profile_form {
    my ($r) = @_;
    my $profile_hashref = &get_user_profile($Apache::Promse::env{'user_id'});
    $r->print('<div id="interiorHeader">');
    $r->print('<h2>Describe your interest and expertise </h2>');
    # $r->print('<h3>Connect to your interests...</h3>');
    $r->print('</div>');
    $r->print('<h4>Profile</h4>');
    $r->print('<form method="post" action="" enctype="multipart/form-data">');
    $r->print('<fieldset>');
    $r->print('<label>Current Photo</label><img src="'.$config{'image_url'}.$$profile_hashref{'photo'}.'">');
    $r->print('<label>Upload New Photo</label><input type="file" value="Browse . . ." name="photo">');
    $r->print('<label>Password</span></label><input type="password" name="password" >');
    $r->print('<label>Password (again)</label> <input type="password" name="password2" >');
    $r->print('<label>First Name</span></label> <input type="text" name="firstname" value="'.$$profile_hashref{'firstname'}.'">');
    $r->print('<label>Last Name</label> <input type="text" name="lastname" value="'.$$profile_hashref{'lastname'}.'">');
    $r->print('<label>Email</label> <input type="text" name="email" value="'.$$profile_hashref{'email'}.'">');
    $r->print('<label>Bio</label><textarea name="bio" rows="5" cols="50">'.$$profile_hashref{'bio'}.'</textarea>');
    $r->print('<input type="submit" value="Save Changes">');
    $r->print('<input type="hidden" name="target" value="preferences">');
    $r->print('<input type="hidden" name="action" value="updateprofile">');
    $r->print('<input type="hidden" name="token" value="'.$Apache::Promse::env{'token'}.'">');
    $r->print('</fieldset>');
    $r->print('</form>');

    return 'ok';
}

sub get_user_profile {
    my $qry = "";
    my $sth;
    $qry='select photo, firstname, lastname, email, bio from users where id = '.$Apache::Promse::env{'user_id'};
    $sth=$Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    my $profile = $sth->fetchrow_hashref;
    return $profile;
}
sub update_expertise {
    my ($r) = @_;
    my %fields;
    my $subject = $r->param('subject');
    my @alltags = $r->param('tagcell');
    $fields{'subject'} = &fix_quotes($subject);
    $fields{'user_id'} = $Apache::Promse::env{'user_id'};
    foreach my $tagcell (@alltags) {
        $fields{'framework_index'} = &fix_quotes($tagcell);
        &save_record('user_expertise',\%fields);
    }
    return 'ok';
}

sub update_profile {
    my ($r) = @_;
    my %fields;
    my %id;
    my $upload_dir = "/var/www/html/images";
    my $upload_filehandle = $r->upload('photo');
    my $file_name = $r->param('photo');
    my $doit;
    my $dstw;
    my $dsth;
    my $dstx;
    my $dsty;
    $file_name = &fix_filename($file_name);
    # now handle the picture upload
    if ($file_name=~/[^\s]/) {
        open UPLOADFILE, ">$upload_dir/$file_name";
        binmode UPLOADFILE;
        while ( <$upload_filehandle> ) { 
            print UPLOADFILE; 
        } 
        close UPLOADFILE;
        # now, resize the picture
        my $imgdst = GD::Image->new(100,100) or &logthis('destination problem');
        my $imgsrc = GD::Image->new("$upload_dir/$file_name") or &logthis('source problem');
        my ($width, $height) = $imgsrc->getBounds();
        if ($width > $height) {
            &logthis('wide');
            $dstw = 99;
            $dsth = int((100/$width)*$height);
            $dstx = 0;
            $dsty = int((99 - $dsth)/2);
        } else {
            &logthis('tall');
            $dsth = 99;
            $dstw = int((100/$height) * $width);
            $dsty = 0;
            $dstx = int((99 - $dstw)/2);
        }
        print "image is $width x $height<br>";
        &logthis('scaled image');
        &logthis("$imgsrc,0,0,$dstx,$dsty,$dstw,$dsth,$width,$height");
        &logthis('got here');
        $imgdst->copyResampled($imgsrc,$dstx,$dsty,0,0,$dstw,$dsth,$width,$height);
        &logthis('resampled');
        undef $imgsrc;
        # my $jpegdata = $imgdst->jpeg();
        &logthis('assigned to data');
        open UPLOADFILE, ">$upload_dir/$file_name";
        binmode UPLOADFILE;
        print UPLOADFILE $imgdst->jpeg();
        close UPLOADFILE;
        $fields{'photo'}=&fix_quotes($file_name);
        undef $imgdst;
        #undef $jpegdata;
    }
    if ($r->param('password') eq $r->param('password2')) {
        if ($r->param('password')=~/[^\s]+/) {
            $fields{'password'}= " '".$r->param('password')."' ";
        } else {
            $r->print('Password not changed');
        }
    } else {
        $r->print('Password fields did not match. Password not changed.');
    }
    $fields{'firstname'}=&fix_quotes($r->param('firstname'));
    $fields{'lastname'}=&fix_quotes($r->param('lastname'));
    $fields{'bio'}=&fix_quotes($r->param('bio'));
    $fields{'email'}=&fix_quotes($r->param('email'));
    $id{'id'}=$Apache::Promse::env{'user_id'};
    &update_record('users',\%id,\%fields);
    return 'OK';
}

sub user_expertise {
    my ($r) = @_;
    my $profile_hashref = &get_user_profile($Apache::Promse::env{'user_id'});
    $r->print('<div id="interiorHeader">');
    $r->print('<h2>Describe your interest and expertise </h2>');
    # $r->print('<h3>Connect to your interests...</h3>');
    $r->print('</div>');
    # &content_goal_item($r);
    &framework_gizmo($r,'expertise');
    return 'ok';
}
sub content_goal_item {
    my ($r) = @_;
    $r->print('<br />do a content goal<br />');
    # create a six by 7 grid of inputs, 6x6 radio buttons, and a row of checkboxes below
    my $radio_start = '<input type="radio" name="';
    my $radio_end = '" />';
    my $name = "test";
    for (my $row = 1; $row < 6; $row ++) {
        for (my $col = 1; $col < 7; $col ++) {
            $r->print($radio_start.$name.$radio_end);
        }
        $r->print('<br />');
    }
    return 'ok';
}

sub set_preferences {
    my ($r) = @_;
    my $qry = "";
    # my $dbh = &db_connect();
    my $sth;
    my $pref_hashref = &get_preferences($r);
    $r->print('<div id="interiorHeader">');
    $r->print('<h2>Describe your interest and expertise </h2>');
    # $r->print('<h3>Connect to your interests...</h3>');
    $r->print('</div>');
    $r->print( '<h4>Preferences</h4>');
    $r->print('<form method="post" action="home">');
    $r->print('<fieldset>');
    $r->print('<label>Message Sort Field </label><select name="sortfield" ');
    if ($$pref_hashref{'sortfield'} eq 'date') {
        $r->print('SELECTED');
    }
    $r->print( '><option value="date">Date</option>');
    $r->print( '<option value="from" ');
    if ($$pref_hashref{'sortfield'} eq 'from') {
        $r->print( 'SELECTED');
    }
    print '>From</option></select>';
    $r->print('<label>Show Instant Message:</label><select name="showim"><option ');
    if ($$pref_hashref{'show_im'} eq 'Yes') {
        $r->print('SELECTED');
    }
    $r->print('>Yes</option><option ');
    if ($$pref_hashref{'show_im'} eq 'No') {
        $r->print('SELECTED');
    }
    $r->print('>No</option></select>');
    $r->print('<label>IMs expire after:</label>');
    $r->print('<select name="imexpire">');
    $r->print('<option value="00:05:00" ');
    if ($$pref_hashref{'im_expire'} eq '00:05:00') {
        $r->print('SELECTED');
    }
    $r->print('>5 minutes</option>');
    $r->print('<option value="00:10:00" ');
    if ($$pref_hashref{'im_expire'} eq '00:10:00') {
        $r->print('SELECTED');
    }
    $r->print('>10 minutes</option>');
    $r->print('</select>');
    $r->print( '<input type="hidden" name="token" value="'.$Apache::Promse::env{'token'}.'">');
    $r->print( '<input type="hidden" name="action" value="update">');
    $r->print( '<input type="hidden" name="target" value="preferences">');
    $r->print( '<tr><td>&nbsp;</td><td><input type="submit" value="Update Preferences"></td></tr>');
    $r->print('</fieldset>');
    $r->print( '</form>');
    return 'ok';
}

sub update_preferences {
    my ($r) = @_;
    # eventually, read the fields and possible values from database
    # for now, things are hard coded to prove a point
    my $qry = "";
    my $sth;
    my %fields;
    $qry = "delete from preferences where user_id = ".$Apache::Promse::env{'user_id'};
    $Apache::Promse::env{'dbh'}->do($qry);
    $fields{'field_name'} = &fix_quotes('sortfield');
    $fields{'field_value'} = &fix_quotes($r->param('sortfield'));
    $fields{'user_id'} = $Apache::Promse::env{'user_id'};
    &save_record('preferences',\%fields);
    $fields{'field_name'} = &fix_quotes('show_im');
    $fields{'field_value'} = &fix_quotes($r->param('showim'));
    $fields{'user_id'} = $Apache::Promse::env{'user_id'};
    &save_record('preferences',\%fields);
    $fields{'field_name'} = &fix_quotes('im_expire');
    $fields{'field_value'} = &fix_quotes($r->param('imexpire'));
    $fields{'user_id'} = $Apache::Promse::env{'user_id'};
    &save_record('preferences',\%fields);
    return 'ok';
}

sub finish_update_preferences {
    my ($pref_hashref);
    return 'ok';
}
sub get_preferences {
    my ($r) = @_;
    my $qry = "";
    # my $dbh = &db_connect();
    my $sth;
    my %pref_hash;
    $qry = "select * from preferences where user_id = ".$Apache::Promse::env{'user_id'};
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    while (my $row = $sth->fetchrow_hashref) {
        $pref_hash{$$row{'field_name'}} = $$row{'field_value'};
    }
    unless ($pref_hash{'show_im'}) {
       $pref_hash{'show_im'} = 'yes';
    } 
    return \%pref_hash;
}    

sub get_standards {
    my ($state, $subject) = @_;
    # my $dbh = &db_connect();
    my $qry = "select strands.description as strand, standards.description as std, standards.number as stdnum, strands.number as strandnum ";
    my $output;
    $qry .= " from strands, standards where strands.state = '$state' and strands.subject = '$subject' ";
    $qry .= " and strands.strandID = standards.strandID order by standards.number, strands.number";
    my $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    while (my $row = $sth->fetchrow_hashref) {
        $output .= $$row{'strand'}."<br >";
    }
    return $output;
}

sub update_message_props {
    my ($r) = @_;
    my $qry = "";
    # my $dbh = &db_connect();
    my $sth;
    my $action = $r->param('submit');
    my @target_messages = $r->param('messageid');
    my $menu = $r->param('menu');
    my $who;

    if ($menu eq 'outbox') {
        $who = 'sender';
    } elsif ($menu eq 'inbox') {
        $who = 'recipient';
    } elsif ($menu eq 'drafts') {        
        $who = 'sender';
    }
    # depending on inbox, outbox or draft, different flag and deleted are set
    if ($action eq 'Delete') {
        foreach my $target (@target_messages) {
            $qry = "update comms set $who"."_is_deleted = 1 where id = $target";
            $Apache::Promse::env{'dbh'}->do($qry);
        }
    } elsif ($action eq 'Mark as Read') {
        foreach my $target (@target_messages) {
            $qry = "update comms set is_read = 1 where id = $target";
            $Apache::Promse::env{'dbh'}->do($qry);
        }
    } elsif ($action eq 'Mark as Unread') {
        foreach my $target (@target_messages) {
            $qry = "update comms set is_read = 0 where id = $target";
            $Apache::Promse::env{'dbh'}->do($qry);
        }
    } elsif ($action eq 'Add Flag') {
        foreach my $target (@target_messages) {
            $qry = "update comms set $who"."_flag = 1 where id = $target";
            $Apache::Promse::env{'dbh'}->do($qry);
        }
    } elsif ($action eq 'Remove Flag') {
        foreach my $target (@target_messages) {
            $qry = "update comms set $who"."_flag = 0 where id = $target";
            $Apache::Promse::env{'dbh'}->do($qry);
        }
    } else {
        print "$action is the action";
    }
    return 'ok';
}

sub view_message {
    my ($r)= @_;
    my $message_id = $r->param('messageid');
    my $menu=$r->param('menu');
    my $qry;
    my $direction;
    if ($menu eq 'inbox') {
        $direction = "From: ";
        $qry = "select content, lastname, firstname, date, subject from comms, users where sender = users.id and comms.id = $message_id";
    } else {
        $direction = "To: ";
        $qry = "select content, lastname, firstname, date, subject from comms, users where recipient = users.id and comms.id = $message_id";
    }
    # my $dbh = &db_connect;
    my $message_content;
    my $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute;
    my $row = $sth->fetchrow_hashref;
    $message_content = $$row{'content'};
    print '<form method="post" action="home">';
    print '<table cellspacing="0" cellpadding="0" width="95%">';
    print '<tr><td>'.$direction.$$row{'firstname'}." ".$$row{'lastname'}.'</td></tr>';
    print '<tr><td>Date: '.$$row{'date'}.'</td></tr>';
    print '<tr><td>Subject: '.$$row{'subject'}.'</td></tr>';
    print '<tr><td><textarea cols="80" rows="10">';
    print $message_content;
    print '</textarea></td></tr>';
    &hidden_fields($r);
    print '<input type="hidden" name="target" value="message" />';
    print '<input type="hidden" name="menu" value="'.$menu.'" />';
    print '<input type="hidden" name="messageid" value="'.$message_id.'" />';
    if ($menu eq 'inbox') {
        print '<tr><td><input type="submit" name="action" value="Reply" /></td></tr>';
    }
    print '</table>';
    print '</form>';

    return 'ok';
}
sub view_answer {
    my ($r)= @_;
    my $message_id = $r->param('messageid');
    my $menu=$r->param('menu');
    my $qry;
    my $direction;
    $direction = "From: ";
    $qry = "select questions.content as question, answers.content as answer, lastname, firstname, questions.date, ";
    $qry .= " subject, answer_id from questions, answers, users where questions.user_id = users.id and ";
    $qry .= " questions.question_id = $message_id and answers.question_id = questions.question_id";
    # my $dbh = &db_connect;
    my $message_content;
    my $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute;
    my $row = $sth->fetchrow_hashref;
    $message_content = $$row{'answer'};
    $r->print('<div id="answer">');
    
    print '<table cellspacing="0" cellpadding="0" width="95%">';
    print '<tr><td>'.$direction.$$row{'firstname'}." ".$$row{'lastname'}.'</td></tr>';
    print '<tr><td>Date: '.$$row{'date'}.'</td></tr>';
    print '<tr><td>Subject: '.$$row{'subject'}.'</td></tr>';
    print '<tr><td>Question: '.$$row{'question'}.'</td></tr>';
    print '<tr><td><textarea cols="80" rows="5">';
    print $message_content;
    print '</textarea></td></tr>';
    $r->print('<tr><td colspan="2">Rate the answer: <br><form method="post" action="apprentice">Worse<input type="radio" name="rate" value="1" />');
    $r->print('<input type="radio" name="rate" value="2" />');
    $r->print('<input type="radio" name="rate" value="3" />');
    $r->print('<input type="radio" name="rate" value="4" />');
    $r->print('<input type="radio" name="rate" value="5" />');
    $r->print('Better</td></tr>');
    $r->print('<tr><td><input type="submit" value="Save Rating" /></td></tr>');
    my %fields;
    $fields{'target'} = 'questions';
    $fields{'action'} = 'saverating';
    $fields{'answerid'} = $$row{'answer_id'};
    &hidden_fields($r, \%fields);
    $r->print('</form>');
    $r->print('</table>');
    $r->print('</div>');
    return 'ok';
}
sub save_rating {
    my ($r) = @_;
    my %fields;
    $fields{'answer_id'} = $r->param('answerid');
    $fields{'rating'} = $r->param('rate');
    $fields{'rater_id'} = &token_to_userid($r->param('token'));
    $fields{'date'} = ' NOW() ';
    &save_record('answer_ratings', \%fields);
    return 'ok';
}

sub view_question {
    my ($r)= @_;
    my $message_id = $r->param('messageid');
    my $menu=$r->param('menu');
    my $qry;
    my $direction;
    $direction = "From: ";
    $qry = "select content, lastname, firstname, date, subject from questions, users where user_id = users.id and question_id = $message_id";
    # my $dbh = &db_connect;
    my $message_content;
    my $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute;
    my $row = $sth->fetchrow_hashref;
    $message_content = $$row{'content'};
    $r->print('<div id="viewQuestion">');
    
    print '<p><strong>'.$direction.'</strong>'.$$row{'firstname'}." ".$$row{'lastname'}.'</p>';
    print '<p><strong>Date: </strong>'.$$row{'date'}.'</p>';
    print '<p><strong>Subject: </strong>'.$$row{'subject'}.'</p>';
    print '<p><textarea cols="80" rows="5">';
    print $message_content;
    print '</textarea>';
    
    $r->print('</div>');
    return 'ok';
}

sub hidden_fields {
    my ($r, $fields_hashref) = @_;
    if (defined $fields_hashref) {
        foreach my $field_name (keys %$fields_hashref) {
            $r->print('<input type="hidden" name="'.$field_name.'" value="'.$$fields_hashref{$field_name}.'" />'."\n");
        }
    }
    $r->print ('<input type="hidden" name="token" value="'.$Apache::Promse::env{'token'}.'" />'."\n");
    return 'ok';
}

sub delete_admin_message {
    my ($r) = @_;
    my $qry = "";
    my $sth;
    my @message_id = $r->param('messageid');
    
    foreach my $message (@message_id) {
        $qry = 'update messages set deleted = 1 where id = '.$message;
        $sth = $Apache::Promse::env{'dbh'}->do($qry);
    }
    return 'ok';
    
}
sub retrieve_question {
    my ($message_id) = @_;
    # my $dbh = &db_connect();
    my $qry = "select * from questions where question_id = $message_id";
    my $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    my $message_hashref;
    $sth->execute();
    $message_hashref = $sth->fetchrow_hashref;
    return $message_hashref;
}

sub retrieve_message {
    my ($message_id) = @_;
    # my $dbh = &db_connect();
    my $qry = "select * from comms where id = $message_id";
    my $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    my $message_hashref;
    $sth->execute();
    $message_hashref = $sth->fetchrow_hashref;
    return $message_hashref;
}

sub date_pulldown {
    my ($r, $date) = @_;
    #date is either 'start' or 'end'
    
    $r->print('<select name="'.$date.'year" ><option>2005</option><option>2006</option></select>');
    $r->print('<select name="'.$date.'month" ><option value="1">January</option><option value="2">February</option>');
    $r->print('<option value="3">March</option><option value="4">April</option>');
    $r->print('<option value="5">May</option><option value="6">June</option>');
    $r->print('<option value="7">July</option><option value="8">August</option>');
    $r->print('<option value="9">September</option><option value="10">October</option>');
    $r->print('<option value="11">November</option><option value="12">December</option>');
    
    $r->print('</select>');
    $r->print('<select name="'.$date.'day" >');
    my $day = 1;
    while ($day < 32) {
        $r->print('<option>'.$day.'</option>');
        $day ++;
    }
    $r->print('</select>');
    return 'ok';
    
}
sub admin_messages {
    my ($r) = @_;
    my $messages = &get_admin_messages;
    print '<form method="post" action="admin">';
    print '<table ><caption>Scheduled Messages</caption>';
    $r->print('<thead>');
    print '<tr><th>&nbsp;</th><th>Start Date</th><th>End Date</th><th>Subject</th></tr>';
    $r->print('</thead><tbody>');
    foreach my $message (@$messages) {
        $$message{'start_date'} =~ s/ 00:00:00//;
        $$message{'end_date'} =~ s/ 00:00:00//;
        print '<tr >';
        print '<td><input type="checkbox" name="messageid" value="'.$$message{'id'}.'"></td>';
        print '<td>'.$$message{'start_date'}.'</td>';
       print '<td>'.$$message{'end_date'}.'</td>';
        print '<td>'.$$message{'subject'}.'</td>';
        print '</tr>';
    }
    $r->print('</tbody>');
    print '</table>';
    print '<input type="submit" value="Delete">';
    my %fields;
    $fields{'target'} = 'schedule';
    $fields{'action'} = 'delete';
    &hidden_fields($r, \%fields);
    print '</form>';
    return 'ok';
}
sub get_admin_messages {
    my ($r) = @_;
    my $qry = "";
    # my $dbh = &db_connect();
    my $sth;
    my @return_array;
    $qry = "select * from messages where deleted<> 1 order by start_date, end_date";
    $sth=$Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    while (my $row = $sth->fetchrow_hashref) {
        push @return_array, {%$row};
    }
    return \@return_array;
}

sub current_messages {
    my ($r) = @_;
    my $user_roles = &get_user_roles($Apache::Promse::env{'token'});
    my @roles = (split /,/, $user_roles);
    my $output;
    my $qry = "select * from messages where start_date < current_date() and end_date > current_date() and deleted = 0 order by start_date, end_date";
    my $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    # print $sth->errstr;
    
    $output.='<h4>System Messages</h4>'."\n";
    $output.='<div id="lookupScroller">'."\n";
    while (my $row = $sth->fetchrow_hashref) {
        my $print_it = 'false';
        foreach my $role (@roles) {
            &logthis($role.' is a role in '.$$row{'recipients'});
            if ($$row{'recipients'}=~/$role/) {
                &logthis('going to print');
                $print_it = 'true';
            }
            
        }
        if ($print_it eq 'true' ){
        $output.= '<p>';
        $output.= '<strong>'.$$row{'subject'}.'</strong></p>'."\n";
        $output.= '<p>';
        my $dummy = $$row{'start_date'};
        $dummy=~s/ 00:00:00//;
        $output.= '<strong>Sent: </strong>'.$dummy.'</p>';
        $output.= '<p class="content">';
        $output.=$$row{'message'}.'</p>."\n"';
        }
    }
    if ($output) {
        $output.='</div>'."\n";
        $r->print($output);
    } else {
        $r->print('<h4>There are no current system messages</h4></div>'."\n");
    }
    
    return 'ok';
}
sub get_one_message {
    my ($message_id) = @_;
    my $message;
    my $qry = "";
    # my $dbh = &db_connect();
    my $sth;
    $qry = "select * from comms where id = $message_id";
    $sth=$Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    $message = $sth->fetchrow_hashref();   
    return $message;
}

sub get_messages {
    # returns selected list of messages
    # expect this routine to change as new search features are implemented
    my ($filter, $sort_field, $sort_direction) = @_;
    my $qry;
    unless (defined $sort_field) {
        $sort_field = 'date';
    }
    if ($filter eq 'out') {
        $qry = "select comms.id, date, subject, recipient, lastname, is_read, sender_flag as flag from comms, users where is_sent = 1 and sender_is_deleted = 0 and recipient = users.id and sender = ".$Apache::Promse::env{'user_id'};
    } elsif ($filter eq 'in') {
        $qry = "select comms.id, date, subject, sender, lastname, is_read, recipient_flag as flag from comms, users where is_sent = 1 and recipient_is_deleted = 0  and sender = users.id and recipient = ".$Apache::Promse::env{'user_id'};
    } elsif ($filter eq 'draft') {
        $qry = "select comms.id, date, subject, sender, lastname, is_read, sender_flag as flag from comms, users where is_sent = 0 and sender_is_deleted = 0  and recipient = users.id and sender = ".$Apache::Promse::env{'user_id'};
    }
    $qry .= ' order by '.$sort_field.$sort_direction;
    # print "<br>".$qry."<BR>";
    my $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute;
    my %return_hash;
    my @return_array;
    while (my $row = $sth->fetchrow_hashref) {
        push @return_array, {%$row};
    }
    return \@return_array;
#    return \%return_hash;
}

sub get_questions {
    # returns selected list of questions
    # expect this routine to change as new search features are implemented
    my ($filter, $sort_field, $sort_direction) = @_;
    my $qry;
    # my $dbh = &db_connect;
    unless (defined $sort_field) {
        $sort_field = 'date';
    }
    if ($filter eq 'out') {
        $qry = "select question_id, date, subject, lastname, is_read from questions, users where questions.user_id = users.id and is_sent = 1 and user_id = ".$Apache::Promse::env{'user_id'};
    } elsif ($filter eq 'in') {
        $qry = "select question_id, date, subject, user_id, lastname, is_read from questions, users where is_sent = 1 and user_id = users.id ";
    } elsif ($filter eq 'draft') {
        $qry = "select question_id, date, subject, user_id, is_read from questions where is_sent = 0 and user_id = ".$Apache::Promse::env{'user_id'};
    }
    $qry .= ' order by '.$sort_field.$sort_direction;
    # print "<br>".$qry."<BR>";
    my $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute;
    my %return_hash;
    my @return_array;
    while (my $row = $sth->fetchrow_hashref) {
        push @return_array, {%$row};
    }
    return \@return_array;
#    return \%return_hash;
}

sub get_answers {
    # returns selected list of questions
    # expect this routine to change as new search features are implemented
    my ($filter, $sort_field, $sort_direction) = @_;
    my $qry;
    unless (defined $sort_field) {
        $sort_field = 'date';
    }
    if ($filter eq 'out') {
        $qry = "select question_id, date, subject, lastname, is_read from questions, users where questions.user_id = users.id and is_sent = 1 and user_id = ".$Apache::Promse::env{'user_id'};
    } elsif ($filter eq 'in') {
        $qry = "select questions.question_id, questions.date, subject, questions.user_id, lastname, is_read from questions, users, answers where answers.is_sent = 1 and questions.user_id = users.id and questions.user_id = ".$Apache::Promse::env{'user_id'}." and questions.question_id = answers.question_id";
    } elsif ($filter eq 'draft') {
        $qry = "select question_id, date, subject, user_id, lastname, is_read  from questions, users where is_sent = 0 and user_id = ".$Apache::Promse::env{'user_id'};
    }
    $qry .= ' order by '.$sort_field.$sort_direction;
    # print "<br>".$qry."<BR>";
    my $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute;
    my %return_hash;
    my @return_array;
    while (my $row = $sth->fetchrow_hashref) {
        push @return_array, {%$row};
    }
    return \@return_array;
#    return \%return_hash;
}

sub message_box {
    my ($r,$box_type) = @_;
    my $box_title;
    my $sort_field;
    my $sort_direction;
    my $box_records;
    my $menu;
    my $direction;
    my $url_fields;
    my $sort_image;
    $url_fields = ';token='.$Apache::Promse::env{'token'}.';target=message;menu='.$r->param('menu').';sortdirection=';
    if ($r->param('sortdirection') eq 'desc') {
        $sort_direction = ' desc ';
        $url_fields .= 'asc';
        $sort_image= "../images/descend_10x5.gif";
    } else {
        $sort_direction = ' asc ';
        $url_fields .= 'desc';
        $sort_image= "../images/ascend_10x5.gif";
    }
    $sort_field = $r->param('sortfield');
    if ($box_type eq 'inbox') {
        $box_title = "InBox";
        $box_records = &get_messages('in', $sort_field, $sort_direction);
        $direction = "From";
        $menu = 'inbox';
    } elsif ($box_type eq 'outbox') {
        $box_title = "OutBox";
        $box_records = &get_messages('out', $sort_field, $sort_direction);
        $direction = "To";
        $menu = 'outbox';
    } elsif ($box_type eq 'draftbox') {
        $box_title = "Drafts";
        $box_records = &get_messages('draft', $sort_field, $sort_direction);
        $direction = "To";
        $menu = 'drafts';
    }
    my $light_color = "#ffffff";
    my $dark_color = "#eeeeee";
    my $row_color = $light_color;
    # retrieve all the questions 
#    print '<table width="100%" border="0" cellspacing="0" cellpadding="10"><tr><td align="left" valign="top">';
#    print '<table width="100%" border="0" cellpadding="0" cellspacing="0" bgcolor="#006634">';
#    print '<tr><td align="center" valign="middle" bgcolor="#006634">';
    $r->print('<h4>'.$box_title.'</hr>');
    $r->print('<form method="post" action="home">');
    $r->print('<table><caption></caption><thead><tr>');
   
    $r->print('<th width="10"></th>');
    print '<th width="50" align="left" valign="top"><a href="home?sortfield=flag'.$url_fields.'"<strong>Flag</strong></a>&nbsp;';
    if ($sort_field eq 'flag') {
        print '<img src="'.$sort_image.'">';
    }
    print '</th>';
    print '<th align="left" valign="top"><a href="home?sortfield=lastname'.$url_fields.'"<strong>'.$direction.'</strong></a> ';
    if ($sort_field eq 'lastname') {
        print '<img src="'.$sort_image.'">';
    }
    print '</th>';
    print '<th align="left" valign="top"><a href="home?sortfield=subject'.$url_fields.'"><strong>Subject</strong></a> ';
    if ($sort_field eq 'subject') {
        print '<img src="'.$sort_image.'">';
    }
    print '</th>';
    print '<th align="center" valign="top"><a href="home?sortfield=date'.$url_fields.'"><strong>Date</strong></a> ';
    if ($sort_field eq 'date') {
        print '<img src="'.$sort_image.'">';
    }
    print '</th></tr>';
    $r->print('</thead><tbody>');
    foreach my $message (@$box_records) {
        print '<tr bgcolor="#EEEEEE" class="content">'; 
        print '<td width="10"><input type="checkbox" name="messageid" value="'.$$message{'id'}.'"</td>';
        if ($$message{'flag'} eq '1') {
            print '<td align="center" width="10"><img src="../images/star.gif"></td>';
        } else {
            print '<td align="center" width="10"><img src="../images/s.gif"></td>';
        }
        print '<td align="left" valign="top"><a href="profile">'.$$message{'lastname'}.'</a>';
        print '</td>';
        print '<td align="left" valign="top"><a href="home?token='.$Apache::Promse::env{'token'}.';target=message;menu='.$menu.';action=view;sortfield='.$sort_field.';messageid='.$$message{'id'}.'">';
        if ($$message{'is_read'} eq '1') {
            print $$message{'subject'}.'</a></td>';
        } else {
            print '<strong>'.$$message{'subject'}.'</strong></a></td>';
        }
        print '<td align="center" valign="top">'.$$message{'date'}.'</td></tr>';
       
    }
    $r->print('<tr class="bottomRow"><td colspan="5"></td></tr>');
    $r->print('</tbody></table>');
    print '<input class="buttonGroup" type="submit" name="submit" value="Delete">';
    if ($direction eq 'From') {
        print '<input class="buttonGroup" type="submit" name="submit" value="Mark as Read"';
        print '<input class="buttonGroup" type="submit" name="submit" value="Mark as Unread"';
    }        
    print '<input class="buttonGroup" type="submit" name="submit" value="Add Flag"';
    print '<input class="buttonGroup" type="submit" name="submit" value="Remove Flag"';

    print '<input type="hidden" name="token" value="'.$Apache::Promse::env{'token'}.'">';
    print '<input type="hidden" name="menu" value="'.$menu.'">';
    print '<input type="hidden" name="sortfield" value="'.$sort_field.'">';
    print '<input type="hidden" name="action" value="setprops">';
    print '<input type="hidden" name="target" value="message">';
    print '</form>'; 
    return 'ok';
}
sub framework_selector {
    my ($r, $contentarea) = @_;
    if ($r->param('contentarea')) {
        $contentarea = $r->param('contentarea');
    }
    my $table = $contentarea.'_framework';
    my $qry = "";
    my $sth;
    $qry = "select id, description, code from $table";
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    while (my $row = $sth->fetchrow_hashref) {
        $r->print('<input type="checkbox" name="frameworkcode" value="'.$$row{'id'}.'">');
        $r->print($$row{'code'}.'-'.$$row{'description'}.'<br>');
    }
    return 'ok';
}
sub topic_selector {
    my ($r, $contentarea) = @_;
    if ($r->param('contentarea')) {
        $contentarea = $r->param('contentarea');
    }
    my $table1 = $contentarea.'_topics';
    my $table2 = $contentarea.'_framework';
    my $qry = "";
    my $sth;
    $qry = "select t2.id, description, t2.code from $table1 t1, $table2 t2 where t1.code = t2.code order by t1.id";
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    while (my $row = $sth->fetchrow_hashref) {
        $r->print('<input type="checkbox" name="frameworkcode" value="'.$$row{'id'}.'">');
        $r->print($$row{'code'}.'-'.$$row{'description'}.'<br>');
    }
    return 'ok';
}
sub question_box {
    my ($r,$box_type) = @_;
    my $box_title;
    my $sort_field;
    my $sort_direction;
    my $box_records;
    my $menu;
    my $direction;
    my $url;
    my $url_fields;
    my $sort_image;
    $url = $r->self_url();
    if ($url =~ /mentor\?/) {
        $url = 'mentor';
    } else {
        $url = 'apprentice';
    }
    $url_fields = ';token='.$Apache::Promse::env{'token'}.';target=questions;menu='.$r->param('menu').';sortdirection=';
    if ($r->param('sortdirection') eq 'desc') {
        $sort_direction = ' desc ';
        $url_fields .= 'asc';
        $sort_image= "../images/descend_10x5.gif";
    } else {
        $sort_direction = ' asc ';
        $url_fields .= 'desc';
        $sort_image= "../images/ascend_10x5.gif";
    }
    $sort_field = $r->param('sortfield');
    if ($box_type eq 'inbox') {
        $box_title = "Questions asked by Associates";
        $box_records = &get_questions('in', $sort_field, $sort_direction);
        $direction = "From";
        $menu = 'inbox';
    } elsif ($box_type eq 'outbox') {
        $box_title = "Questions awaiting reply";
        $box_records = &get_questions('out', $sort_field, $sort_direction);
        $direction = "To";
        $menu = 'outbox';
    } elsif ($box_type eq 'draftbox') {
        $box_title = "Draft Questions";
        $box_records = &get_questions('draft', $sort_field, $sort_direction);
        $direction = "To";
        $menu = 'drafts';
    }
    my $light_color = "#ffffff";
    my $dark_color = "#eeeeee";
    my $row_color = $light_color;

    print '<form method="post" action="'.$url.'">';
    print '<table>';
    print '<caption>'.$box_title.'</caption>';
    print '<thead><tr>';
    print '<th width="10"><input type = "checkbox"></th>';
    print '<th width="50" align="left" valign="top"><a href="'.$url.'?sortfield=flag'.$url_fields.'"<strong>Flag</strong></a>&nbsp;';
    if ($sort_field eq 'flag') {
        print '<img src="'.$sort_image.'">';
    }
    print '</th>';
    print '<th align="left" valign="top"><a href="'.$url.'?sortfield=subject'.$url_fields.'"><strong>Subject</strong></a> ';
    if ($sort_field eq 'subject') {
        print '<img src="'.$sort_image.'">';
    }
    print '</th>';
    print '<th align="center" valign="top"><a href="'.$url.'?sortfield=date'.$url_fields.'"><strong>Date</strong></a> ';
    if ($sort_field eq 'date') {
        print '<img src="'.$sort_image.'">';
    }
    print '</th></tr></thead><tbody>';
    foreach my $message (@$box_records) {
#    foreach my $message (sort keys %$box_records) {
        print '<tr bgcolor="#EEEEEE" class="content">'; 
        print '<td width="10"><input type="checkbox" name="messageid" value="'.$$message{'id'}.'"</td>';
        if ($$message{'flag'} eq '1') {
            print '<td align="center" width="10"><img src="../images/star.gif"></td>';
        } else {
            print '<td align="center" width="10"><img src="../images/s.gif"></td>';
        }
        print '<td align="left" valign="top"><a href="'.$url.'?token='.$Apache::Promse::env{'token'}.';target=questions;menu='.$menu.';action=view;sortfield='.$sort_field.';messageid='.$$message{'question_id'}.'">';
        if ($$message{'is_read'} eq '1') {
            print $$message{'subject'}.'</a></td>';
        } else {
            print '<strong>'.$$message{'subject'}.'</strong></a></td>';
        }
        print '<td align="center" valign="middle">'.$$message{'date'}.'</td>';
        print '</tr>'
    }
    print '</tbody></table>';
    print '<input type="hidden" name="token" value="'.$Apache::Promse::env{'token'}.'">';
    print '<input type="hidden" name="menu" value="'.$menu.'">';
    print '<input type="hidden" name="sortfield" value="'.$sort_field.'">';
    print '<input type="hidden" name="action" value="setprops">';
    print '<input type="hidden" name="target" value="questions">';
    print '</form>'; #</td></tr></table></tr></table>';
    return 'ok';
}

sub answer_box {
    my ($r,$box_type) = @_;
    my $box_title;
    my $sort_field;
    my $sort_direction;
    my $box_records;
    my $menu;
    my $direction;
    my $url;
    my $url_fields;
    my $sort_image;
    $url = $r->self_url();
    if ($url =~ /mentor\?/) {
        $url = 'mentor';
    } else {
        $url = 'apprentice';
    }
    $url_fields = ';token='.$Apache::Promse::env{'token'}.';target=questions;menu='.$r->param('menu').';sortdirection=';
    if ($r->param('sortdirection') eq 'desc') {
        $sort_direction = ' desc ';
        $url_fields .= 'asc';
        $sort_image= "../images/descend_10x5.gif";
    } else {
        $sort_direction = ' asc ';
        $url_fields .= 'desc';
        $sort_image= "../images/ascend_10x5.gif";
    }
    $sort_field = $r->param('sortfield');
    $box_title = "Replies to my Questions";
    $box_records = &get_answers('in', $sort_field, $sort_direction);
    $direction = "From";
    $menu = 'inbox';
    my $light_color = "#ffffff";
    my $dark_color = "#eeeeee";
    my $row_color = $light_color;
    print '<form method="post" action="'.$url.'">';
    print '<table>';
    print '<caption>'.$box_title.'</caption><thead>';
    print '<tr>';
    print '<th ><input type = "checkbox"></th>';
    print '<th width="50" align="left" valign="top"><a href="'.$url.'?sortfield=flag'.$url_fields.'"<strong>Flag</strong></a>&nbsp;';
    if ($sort_field eq 'flag') {
        print '<img src="'.$sort_image.'">';
    }
    print '</th>';
    print '<th align="left" valign="top"><a href="'.$url.'?sortfield=lastname'.$url_fields.'"<strong>'.$direction.'</strong></a> ';
    if ($sort_field eq 'lastname') {
        print '<img src="'.$sort_image.'">';
    }
    print '</th>';
    print '<th align="left" valign="top"><a href="'.$url.'?sortfield=subject'.$url_fields.'"><strong>Subject</strong></a> ';
    if ($sort_field eq 'subject') {
        print '<img src="'.$sort_image.'">';
    }
    print '</th>';
    print '<th align="center" valign="top"><a href="'.$url.'?sortfield=date'.$url_fields.'"><strong>Date</strong></a> ';
    if ($sort_field eq 'date') {
        print '<img src="'.$sort_image.'">';
    }
    print '</th></tr></thead><tbody>';
    foreach my $message (@$box_records) {
#    foreach my $message (sort keys %$box_records) {
        print '<tr bgcolor="#EEEEEE" class="content">'; 
        print '<td width="10"><input type="checkbox" name="messageid" value="'.$$message{'id'}.'"</td>';
        if ($$message{'flag'} eq '1') {
            print '<td align="center" width="10"><img src="../images/star.gif"></td>';
        } else {
            print '<td align="center" width="10"><img src="../images/s.gif"></td>';
        }
        print '<td align="left" valign="top"><a href="profile">'.$$message{'lastname'}.'</a>';
        print '</td>';
        print '<td align="left" valign="top"><a href="'.$url.'?token='.$Apache::Promse::env{'token'}.';target=questions;menu='.$menu.';action=view;sortfield='.$sort_field.';messageid='.$$message{'question_id'}.'">';
        if ($$message{'is_read'} eq '1') {
            print $$message{'subject'}.'</a></td>';
        } else {
            print '<strong>'.$$message{'subject'}.'</strong></a></td>';
        }
        print '<td align="center" valign="middle">'.$$message{'date'}.'</td>';
        print '</tr>'
    }
    print '</tbody></table>';
    $r->print('<input class="buttonGroup" type="submit" name="submit" value="Delete">');
    $r->print('<input class="buttonGroup" type="submit" name="submit" value="Add Flag"');
    $r->print('<input class="buttonGroup" type="submit" name="submit" value="Remove Flag"</td></tr>');
    print '<input type="hidden" name="token" value="'.$Apache::Promse::env{'token'}.'">';
    print '<input type="hidden" name="menu" value="'.$menu.'">';
    print '<input type="hidden" name="sortfield" value="'.$sort_field.'">';
    print '<input type="hidden" name="action" value="setprops">';
    print '<input type="hidden" name="target" value="questions">';
    print '</form>'; 
    return 'ok';
}


sub schedule_form {
    my ($r) = @_;
print qq~    
    <form name="form1" method="post" action="admin">
    <td align="left"><strong>Recipients:</strong></td>
    <td align="left">
    <input type="checkbox" name="recipient" value="Teacher" > Teacher
    <input type="checkbox" name="recipient" value="Apprentice" > Apprentice
    <input type="checkbox" name="recipient" value="Mentor" > Mentor
    <input type="checkbox" name="recipient" value="Editor" > Editor
    <input type="checkbox" name="recipient" value="Administrator" > Administrator
    <div></div>
    <label>Start Date:</label>
~;
&date_pulldown($r, 'start');
$r->print('<label>End Date:</label>');

&date_pulldown($r, 'end');
$r->print('<div></div>');
#<input name="enddate" type="text" value="" size="40">
$r->print('<label>Subject:</label>');
$r->print('<input name="subject" type="text" value="" size="40"><div></div>');
print qq~
    <label>Message:</label>
    <textarea name="message" cols="55" rows="10"></textarea>
                      
~;                        
    print '<input type="hidden" name="token" value="'.$Apache::Promse::env{'token'}.'">';
    print '<input type="hidden" name="target" value="schedule">';
    print '<input type="hidden" name="menu" value="browse">';
    print '<input type="hidden" name="action" value="addmessage">';
    print '<input type="submit" name="Submit" value="Save Message">';    
}
sub code_to_description {
    my ($code) = @_;
    my $qry = "";
    my $sth;
    $qry = "select description from math_framework where code = '$code'";
    $sth=$Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    my $row = $sth->fetchrow_hashref();
    &logthis($qry.' retrieved '.$$row{'description'});
    return $$row{'description'};
}

sub apprentice_search_form {
    my ($r) = @_;
    my $code = $r->param('code');
    my $topic_description;
    if ($code) {
        # came from alignment link
        $topic_description = &code_to_description($code);
    }
    print '<form method="post" action="apprentice" >';
    $r->print('<fieldset>');
    $r->print('<h4>Subject</h4>');
    print '<label>Math</lable><input type="radio" name="contentarea" value="math" checked>';
    $r->print('<label>Science</lable><input type="radio" name="contentarea" value="science"> ');
    print '<label>Time Commitment:</label>';
    print '<select name="timecommitment" id="Select One">';
    print '<option>0-10 Min.</option>';
    print '<option selected>10-30 Min.</option>';
    print '<option>30-60 Min.</option>';
    print '<option>1-2 Hrs.</option>';
    print '<option>2-4 Hrs.</option>';
    print '<option>More than a day</option>';
    print '</select>';
    print '<label>Search for:</label>';
    print '<input name="searchtext" type="text" size="30" value="'.$topic_description.'">';
    print '<input name="search" type="submit" id="search" value="Search">';
    $r->print('<input type="hidden" name="code" value="'.$code.'">');
    print '<input type="hidden" name="token" value="'.$Apache::Promse::env{'token'}.'">';
    print '<input type="hidden" name="target" value="search">';
    print '<input type="hidden" name="action" value="search">';
    $r->print('</fieldset>');
    print '</form>';
    return 'ok';
}

sub apprentice_find {
    my ($r) = @_;
    my $qry = "";
    # my $dbh = &db_connect();
    our %search_results;
    my $where_clause;
    my $sth;
    my $framework_index = $r->param('code');
    my $upload_dir_url = "../resources";
    my @search_text = split / /, uc($r->param('searchtext'));
    foreach my $word (@search_text) {
        $word = substr $word, 0, 6;
        if (length($word)>5) {
            $word = &fix_quotes($word.'%');
        } else {
            $word = &fix_quotes($word);
        }
        $qry = "select * from doc_code where word like $word";
        $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
        $sth->execute();
        while (my $row = $sth->fetchrow_hashref) {
            $search_results{$$row{'doc_id'}} += $$row{'count'}
        }
        # $r->print("the search text is $word <br>");
    }
    $qry="";
    sub by_value_descending {$search_results{$b} <=> $search_results{$a}}
    foreach my $key (sort by_value_descending (keys (%search_results))) {
        #$r->print("doc $key received $search_results{$key} points<br>");
        $qry .= " select title, location, time_commitment, id, $search_results{$key} as score from resources where id = $key union";
    }
    $qry =~ s/union$//;
    
    #$qry = "select resources.title, resources.location, resources.id from resources, res_meta, tags where res_meta.tag_id = tags.id and ";
    #$qry .= " resources.id = res_meta.res_id and tags.location = '".$framework_index."'";
    $sth=$Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    if ($sth->rows == 0 ) {
        print "No resources were found that match your search. Try modifying or adding to your search phrase.";
    } else {
        print "<h4>The following resources match your search request:</h4>";
        $r->print('<table><thead><tr ><th>Resource Title</th><th>Time Commitment</th>');
        $r->print('<th>Topics Covered</th><th>User Rating</th><th>Search Rating</th></tr>');
        $r->print('</thead><tbody>');
        while (my $resource = $sth->fetchrow_hashref) {
            print '<tr><td>';
            if ($$resource{'type'} eq 'Web URL') {
                print '<a target="new" href="'.$$resource{'location'}.'">'.$$resource{'title'}."</a></td>";
            } else {
                print '<a target="new" href="'.$upload_dir_url.'/'.$$resource{'location'}.'.'.$$resource{'id'}.'">'.$$resource{'title'}."</a></td>";
            }
            $r->print('<td>'.$$resource{'time_commitment'}.'</td>');
            $r->print('<td>'.$$resource{'time_commitment'}.'</td>');
            $r->print('<td>'.$$resource{'time_commitment'}.'</td>');
            $r->print('<td>'.$$resource{'score'}.'</td>');
            $r->print('</tr>');
        }
        print '</tbody></table>';
    }
    print "";
    return 'ok';
}
sub time_to_seconds {
    my ($vid_time) = @_; # converts hh:mm:ss to total seconds
    my ($hour,$minutes,$seconds) = split /:/, $vid_time;
    
    return (($hour*3600) + ($minutes * 60) + $seconds);
}

sub video {
    my ($r) = @_;
    my $resource_id = $r->param('resource');
    my $qry = "select t1.title, location, t1.comments, start_time, end_time, t2.comments as clip_comments, 
                t2.title as clip_title from resources t1 
                left join vid_clips t2 ON t2.resource_id = t1.id
                where t1.id = $resource_id";
    my $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    my @clips;
    my @disp_clips;
    my $row = $sth->fetchrow_hashref();
    my %t_hash;
    $t_hash{'start_time'} = &time_to_seconds($$row{'start_time'});
    $t_hash{'end_time'} = &time_to_seconds($$row{'end_time'});
    $t_hash{'display'} = $$row{'start_time'}.'-'.$$row{'end_time'};
    push @clips, {%t_hash};
    while (my $clip = $sth->fetchrow_hashref()) {
        $t_hash{'start_time'} = &time_to_seconds($$clip{'start_time'});
        $t_hash{'end_time'} = &time_to_seconds($$clip{'end_time'});
        $t_hash{'display'} = $$clip{'start_time'}.'-'.$$clip{'end_time'};
        push @clips, {%t_hash};
    }
    $r->print('<div id="interiorHeader">');
    $r->print('<h2>Video Resource Management </h2>');
    $r->print('<h3>Edit and select ...</h3>');
    $r->print('</div>');
        
    $r->print('<table><tr><td>'."\n");
    $r->print('');
    $r->print('<embed src="http://banghart-3.user.msu.edu/SAMPLE.MOV" width="250" height="240"'."\n");
    $r->print('QTSRC="'.$$row{'location'}.'"'."\n");
    $r->print('controller="true"'."\n");
    $r->print('NAME="movie"'."\n");
    $r->print('bgcolor="cccccc">'."\n");
    $r->print('</td><td valign="top"><form name="form1" method="post" action="">');
    $r->print('<input size="8" type="text" name="markin"><input size="8" type="text" name="markout"><br>'."\n");
    $r->print('<input type="button" value="Mark In" onClick="grab(1)" /><input type="button" value="Mark Out" onClick="grab(2)" />'."\n");
    $r->print('<br /><input type="button" value="Reset" onClick="resetmovie()">');
    $r->print('<br /><input type="text" name="title" />');
    $r->print('<p class="content">Description:</p>');
    $r->print('<p><textarea rows="8" name="description" cols="30"></textarea></p>');
    $r->print('<input type="hidden" name="target" value="video">');
    $r->print('<input type="hidden" name="action" value="saveclip">');
    $r->print('<input type="hidden" name="resource" value="'.$resource_id.'">');
    $r->print('<input type="hidden" name="token" value="'.$Apache::Promse::env{'token'}.'">');
    $r->print('<input type="submit" value="Save Clip">'."\n");
    $r->print('</form>'."\n");
    $r->print('</td><td valign="top">');
    $r->print('<span>Existing Clips<br />');
    foreach my $clip (@clips) {
        $r->print('<input type="button" onClick="playclip('.$$clip{'start_time'}.','.$$clip{'end_time'}.')" value="'.$$clip{'display'}.' Play" /><br />');
    }
    $r->print('</span></td></tr></table>');
    return 'ok';
}
sub save_clip {
    my ($r) = @_;
    $r->print('saving clip<br>');
    # will need error checking for sensible clips
    my %fields;
    $fields{'start_time'} = &fix_quotes($r->param('markin'));
    $fields{'end_time'} = &fix_quotes($r->param('markout'));
    $fields{'comments'} = &fix_quotes($r->param('description'));
    $fields{'author_id'} = $Apache::Promse::env{'user_id'};
    $fields{'resource_id'} = $r->param('resource');
    &save_record('vid_clips', \%fields);
    return 'ok';
}
sub delete_resource {
    my ($r) = @_;
    my $qry;
    my @resources = $r->param('resourceid');
    if ($r->param('sure') eq 'Delete') {
        foreach my $id (@resources) {
            $qry = "delete from resources where id = $id";
            $Apache::Promse::env{'dbh'}->do($qry);
            $qry = "delete from res)meta where res_id = $id";
            $Apache::Promse::env{'dbh'}->do($qry);
        }
        $r->print('Resources have been deleted<br />');
    } else {
        my %fields;
        $r->print("You have requested to delete resources.<br />"); 
        $r->print('<form method="post" action="">');
        $r->print('<input name="sure" type="submit" value="Delete">');
        $r->print('<input name="sure" type="submit" value="Cancel">');
        foreach my $id (@resources) {
            $r->print('<input type="hidden" name="resourceid" value="'.$id.'">'."\n");
        }
        $fields{'action'} = 'Delete';
        $fields{'target'} = 'resource';
        &hidden_fields($r,\%fields);
        $r->print('</form>');
    }
    return;
}
sub resource_box {
    my ($r,$box_type) = @_;
    my $upload_dir_url = "../resources";
    my $box_title;
    my $box_records;
    my $menu = $r->param('menu');
    my $direction;
    my $url = &get_base_url($r);
    $box_title = "Resources";
    $box_records = &get_resources();
    $r->print('<div id="interiorHeader">');
    $r->print('<h2>Editor Workspace </h2>');
    $r->print('<h3>All work and no play ...</h3>');
    $r->print('</div>');
    &mentor_menus($r);
    
    # retrieve all the resources 
    print '<table ><caption>Resources</caption><thead>';
    print '<tr>';                             
    print '<th align="left" valign="top">Tags</th>';
    print '<th align="left" valign="top">Title</th>';
    print '<th align="left" valign="top">Contributor</th><th align="center">Reference</th></tr>';
    $r->print('</thead><tbody>');
    print '<form method="post" action="'.$url.'">';
    my $row_alt = 0;
    my $clip_count;
    foreach my $resource (@$box_records) {
        my $row_class;
        if ($row_alt eq 0) {
            $row_alt = 1;
            $row_class = "";
        } else {
            $row_alt = 0;
            $row_class = ' class="rowAlternate" ';
        }
        if ($$resource{'clips'}) {
            $clip_count = $$resource{'clips'}.' clip(s)';
        } else {
            $clip_count = "";
        }
        print '<tr '.$row_class.'>'; 
        print '<td ><input type="checkbox" name="resourceid" value="'.$$resource{'id'}.'"> ';
        print '<a href="'.$url.'?target=resource;token='.$Apache::Promse::env{'token'}.';action=view;resourceid='.$$resource{'id'}.'">'.$$resource{'tags'}.'</a></td>';
        print '<td align="left" >'.$$resource{'title'}.$clip_count.'</td>';
        print '<td align="left" ><a href="'.$url.'?token='.$Apache::Promse::env{'token'}.';target=resource;menu='.$menu.';action=profile;userid='.$$resource{'contributor'}.'">'.$$resource{'lastname'}.'</a></td>';
        if ($$resource{'type'} eq 'Video') {
            $r->print('<td align="center" valign="middle"><a href="editor?target=video&token='.$Apache::Promse::env{'token'}.'&resource='.$$resource{'id'}.'">View/Edit Video</td>');
        } elsif ($$resource{'type'} eq 'Web URL') {
            print '<td align="center" valign="middle"><a target="new" href="'.$$resource{'location'}.'">'.$$resource{'location'}.'</td>';
        } else {
            print '<td align="center" valign="middle"><a target="new" href="'.$upload_dir_url.'/'.$$resource{'location'}.'.'.$$resource{'id'}.'">'.$$resource{'location'}.'</td>';
        }
        print '</tr>';
    }
    print '<tr><td colspan="4"><input type="submit" name="action" value="Add Tag">
            <input name="action" type="submit" value="Delete">';
    print '<input type="hidden" name="token" value="'.$Apache::Promse::env{'token'}.'">';
    print '<input type="hidden" name="target" value="resource">';
    print '<input type="hidden" name="menu" value="browse">';
#    print '<input type="hidden" name="action" value="tag">';
    print '</form>';
    $r->print('</tbody>');
    print '</table>';
    return 'ok';
}

sub resource_summary {
    #retrieves summary of resources applicable to interests of user identified
    my ($r) = @_;
    my %summary;
    return \%summary;
}
sub fix_filename {
    my ($file_name) = @_;
    if ($file_name=~/\\/) { #has back-slashes
        $file_name=~/(.*\\)(.*$)/;
        $file_name=$2;
    }
    return $file_name;    
}
sub index_for_search {
    my ($row) = @_;
    my $qry;
    my %words_index;
    my @words = (split (/\s/,$$row{'title'}));
    foreach my $word(@words) {
        $words_index{uc($word)} += 1;
    }
    undef @words;
    @words = (split (/\s/,$$row{'description'})); 
    foreach my $word(@words) {
        $words_index{uc($word)} += 1;
    }
    foreach my $key (keys (%words_index)) {
        my $save_word = uc($key);
        if ($key =~ /[A-Z][A-Z]/) {
            $qry = "insert into doc_code (doc_id, word, count) values (".$$row{'id'}.",".&fix_quotes($save_word).",".$words_index{$key}.")";
            $Apache::Promse::env{'dbh'}->do($qry);
        }
    }
}
sub save_resource {
    my ($r) = @_;
    my %fields;
    my $qry;
    my $title;
    my $file_name = $r->param('resource');
    $fields{'title'} = &fix_quotes($r->param('title'));
    $fields{'author'} = &fix_quotes($r->param('author'));
    $fields{'time_commitment'} = $r->param('timecommitment');
    $fields{'comments'} = &fix_quotes($r->param('comments'));
    $fields{'contributor'} = $Apache::Promse::env{'user_id'};
    $fields{'type'} = &fix_quotes($r->param('type'));
    if ($r->param('resource') eq "") { # if no file is uploaded
        $fields{'location'} = &fix_quotes($r->param('location'));
        $r->print('Thank you for submitting this resource. No file was uploaded.');
        $fields{'id'} = &save_record ('resources',\%fields,'id');
        &index_for_search(\%fields);
    } else {
        $fields{'location'} = &fix_quotes($file_name);
        $file_name = &fix_filename($file_name);
        my $resource_id = &save_record ('resources',\%fields,'id');
        # send resource_id to append to file name, assuring unique name
        # not sure if that's smart
        &handle_upload($r, $resource_id);
    }
    return 'ok';
}

sub handle_upload {
    my ($r, $resource_id) = @_;
    my $upload_dir = "/var/www/html/resources";
    my $upload_filehandle = $r->upload('resource');
    my $file_name = $r->param('resource');
    $file_name = &fix_filename($file_name);
    #doubtless need to handle dos filenames or maybe rename with index values
    open UPLOADFILE, ">$upload_dir/$file_name.$resource_id";
    binmode UPLOADFILE;
    while ( <$upload_filehandle> ) { 
        print UPLOADFILE; 
    } 
    close UPLOADFILE;
}
sub view_edit_resource {
    my ($r) = @_;
    my $qry = "";
    # my $dbh = &db_connect();
    my $sth;
    my $resource_id = $r->param('resourceid');
    my $url = &get_base_url($r);
    $qry = "select * from resources where id = $resource_id";
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    my $resource_hashref = $sth->fetchrow_hashref;
    &update_resource_form($r, $resource_hashref);
    $qry = "select * from res_meta, tags where res_id = $resource_id and tag_id = tags.id";
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    while (my $row = $sth->fetchrow_hashref) {
        &edit_tag_form($r, $row);
    }
    return 'ok';
}

sub edit_tag_form {
    my ($r, $tag_hashref) = @_;
    my $url = &get_base_url($r);
    print '<table width="100%" border="0" cellspacing="0" cellpadding="10">';
    print '<tr><td align="left" valign="top">';
    print '<FORM ACTION="'.$url.'" METHOD="post" ENCTYPE="multipart/form-data">';
    print '<table width="100%" border="0" cellpadding="0" cellspacing="0" bgcolor="#006634">';
    print '<tr><td align="center" valign="middle" bgcolor="#006634"><table width="100%" border="0" cellspacing="1" cellpadding="2">';
    print '<tr><td colspan="2" class="header"><font color="#FFFFFF">Update Resource Tag</font></td></tr>';
    print '<tr bgcolor="#EEEEEE" class="content"><td align="left"><strong>Description:</strong></td><td align="left">';
    print '<input type="text" size="50" name="description" value="'.$$tag_hashref{'description'}.'"></tr>';
    print '<tr bgcolor="#EEEEEE" class="content"><td align="left"><strong>Location:</strong></td><td align="left">';
    print '<input type="text" size="50" name="location" value="'.$$tag_hashref{'location'}.'"></tr>';
    print '<tr align="center" valign="middle" bgcolor="#FFFFFF" class="content">';
    print '<td colspan="2">';
    print '<input type="hidden" name="token" value="'.$Apache::Promse::env{'token'}.'">';
    print '<input type="hidden" name="target" value="resource">';
    print '<input type="hidden" name="menu" value="resources">';
    print '<input type="hidden" name="action" value="update">';
    print '<input type="submit" name="Submit" value="Submit Resource"></td></tr>';
    print '</table></td></tr></table></form>';
    print '<p class="content"><span class="content"><br>';
    print '</p></td></tr></table>';
    return 'ok';
}

sub get_resources {
    my ($r) = @_;
    my $qry = "select t1.title, type, t1.location, lastname, firstname, t1.contributor, t1.id, 
                count(res_id) as tags, count(resource_id) as clips from resources t1
                LEFT JOIN vid_clips t4 ON t4.resource_id = t1.id
                LEFT JOIN users t2 ON t2.id = t1.contributor
                LEFT JOIN res_meta t3 on t3.res_id = t1.id
                group by t1.id;";
    my $sth;
    my @all_resources;
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    while (my $resource = $sth->fetchrow_hashref) {
        push @all_resources, {%$resource};
    }
    return \@all_resources;
}

sub browse_resources {
    my ($r) = @_;
    my $qry = "select * from resources";
    my $sth;
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    while (my $resource = $sth->fetchrow_hashref) {
        print $$resource{'title'}."<br>";
    }
    return 'ok';
}
sub update_resource {
    my ($r) = @_;
    my %fields;
    my %id;
    $id{'id'} = $r->param('resourceid');
    $fields{'title'} = &fix_quotes($r->param('title'));
    $fields{'author'} = &fix_quotes($r->param('author'));
    $fields{'time_commitment'} = $r->param('timecommitment');
    $fields{'comments'} = &fix_quotes($r->param('comments'));
    &update_record('resources', \%id, \%fields); 
    return 'ok';
}

sub update_resource_form {
    my ($r, $resource_hashref) = @_;
    my $url = &get_base_url($r);
    print '<table width="100%" border="0" cellspacing="0" cellpadding="10">';
    print '<tr><td align="left" valign="top">';
    print '<FORM ACTION="'.$url.'" METHOD="post" ENCTYPE="multipart/form-data">';
    print '<table width="100%" border="0" cellpadding="0" cellspacing="0" bgcolor="#006634">';
    print '<tr><td align="center" valign="middle" bgcolor="#006634"><table width="100%" border="0" cellspacing="1" cellpadding="2">';
    print '<tr><td colspan="2" class="header"><font color="#FFFFFF">Update a Resource</font></td></tr>';
    print '<tr bgcolor="#D9EAE4" class="content"><td align="left" valign="top"><strong>Field</strong></td>';
    print '<td align="left" valign="top"><strong>Data</strong><strong></strong></td></tr>';
    print '<tr bgcolor="#EEEEEE" class="content"><td align="left"><strong>Title:</strong></td><td align="left">';
    print '<input type="text" size="50" name="title" value="'.$$resource_hashref{'title'}.'"></tr>';
    print '<tr bgcolor="#EEEEEE" class="content"><td align="left"><strong>Author:</strong></td><td align="left">';
    print '<input type="text" size="50" name="author" value="'.$$resource_hashref{'author'}.'"></tr>';
    print '<tr bgcolor="#EEEEEE" class="content"><td align="left"><strong>Time Commitment:</strong></td><td align="left">';
    print '<select name="timecommitment"><option value="1">0-10 Min.</option><option value="2">10-30 Min.</option>';
    print '<option value="3">30-60 Min.</option><option value="4">1-2 Hrs.</option><option value="5">2-4 Hrs.</option>';
    print '<option value="6">1-2 Days</option><option value="7">2-5 Days</option></select></tr>';
    print '<tr bgcolor="#EEEEEE" class="content"><td align="left"><strong>Comments:</strong></td>';
    print '<td align="left" valign="top"><textarea name="comments" cols="55" rows="10">'.$$resource_hashref{'comments'}.'</textarea></td></tr>';
#    print '<tr valign="middle" bgcolor="#FFFFFF" class="content"><td align="left"><strong>Select File:</strong></td>';
#    print '<td align="left"> <INPUT TYPE="file" NAME="resource"></td></tr>';
#    print '<tr bgcolor="#EEEEEE" class="content"><td align="left" valign="top"><strong>Message:</strong></td>';
    print '<tr align="center" valign="middle" bgcolor="#FFFFFF" class="content">';
    print '<td colspan="2">';
    print '<input type="hidden" name="token" value="'.$Apache::Promse::env{'token'}.'">';
    print '<input type="hidden" name="target" value="resource">';
    print '<input type="hidden" name="resourceid" value="'.$$resource_hashref{'id'}.'">';
    print '<input type="hidden" name="menu" value="resources">';
    print '<input type="hidden" name="action" value="update">';
    print '<input type="submit" name="Submit" value="Update Resource"></td></tr>';
    print '</table></td></tr></table></form>';
    print '<p class="content"><span class="content"><br>';
    print '</p></td></tr></table>';
    return 'ok';   
}

sub upload_resource_form {
    my ($r) = @_;
    my $url = &get_base_url($r);
    $r->print('<div id="interiorHeader">');
    $r->print('<h2>Editor Workspace </h2>');
    $r->print('<h3>All work and no play ...</h3>');
    $r->print('</div>');
    &mentor_menus($r);
    print '<FORM ACTION="'.$url.'" METHOD="post" ENCTYPE="multipart/form-data">';
    print '<h4>Add a Resource</h4>';
    $r->print('<fieldset>');
    $r->print('<label>Resource Type:</label>');
    $r->print('<select name="type">');
    $r->print('<option>Document</option><option>Web URL</option><option>Video</option></select>');
    $r->print('<label>Location (URL):</label>');
    $r->print('<input type="text" size="50" name="location">');
    print '<label>Title:</label>';
    print '<input type="text" size="50" name="title">';
    print '<label>Author:</label>';
    print '<input type="text" size="50" name="author">';
    print '<label>Time Commitment:</label>';
    print '<select name="timecommitment"><option value="1">&lt;10 Min.</option><option value="2">10-30 Min.</option>';
    print '<option value="3">30-60 Min.</option><option value="4">1-2 Hrs.</option><option value="5">2-4 Hrs.</option>';
    print '<option value="6">1-2 Days</option><option value="7">2-5 Days</option></select>';
    print '<label>Comments:</label>';
    print '<textarea name="comments" cols="55" rows="10"></textarea>';
    print '<label>Select File:</label>';
    print ' <INPUT TYPE="file" NAME="resource">';
#    print '<tr bgcolor="#EEEEEE" class="content"><td align="left" valign="top"><strong>Message:</strong></td>';
   
    print '<input type="hidden" name="token" value="'.$Apache::Promse::env{'token'}.'">';
    print '<input type="hidden" name="target" value="resource">';
    print '<input type="hidden" name="menu" value="resources">';
    print '<input type="hidden" name="action" value="upload">';
    print '<input type="submit" name="Submit" value="Submit Resource">';
    $r->print('</fieldset>');
    print '</form>';
    print '<p class="content"><span class="content"><br>';
    
    return 'ok';   
}

sub framework_grabber_form {
    my ($r) = @_;
    print '<form method="post" action="mentor">';
    print '<input type="text" name="level">';
    print '<input type="text" name="level">';
    print '<select name="subject"><option value="science">Science</option><option value="math">Math</option></select>';
    print '<input type="hidden" name="token" value="'.$Apache::Promse::env{'token'}.'">';
    print '<input type="hidden" name="target" value="framework">';
    print '<input type="hidden" name="menu" value="browse">';   
    print '<input type="submit" name="Submit" value="Submit Resource">';

    print '</form>';
    return 'ok';
}
sub standard_gizmo {
    my ($r)= @_;
    my $tag = $r->param('action');
    my $target = $r->param('target');
    my $resource_id = $r->param('resourceid');
    my $click_cell;
    my $subject;
    my $url = &get_base_url;
    my $qry = "";
    my $sth;
    my @benchmark_grades;
    my @indicator_grades;
    my @strands;
    $qry = 'select * from ohio_math_strands';
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    while (my $row = $sth->fetchrow_hashref){
       push @strands, $$row{'description'};  
    }
    
    $qry = 'select distinct grade from ohio_math_benchmarks';
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    while (my $row = $sth->fetchrow_hashref){
       push @benchmark_grades, $$row{'grade'};  
    }
    $qry = 'select distinct grade from ohio_math_indicators';
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    while (my $row = $sth->fetchrow_hashref){
       push @indicator_grades, $$row{'grade'};  
    }
    $r->print ('<form method="post" action="mentor">');
    $r->print('<select name="benchmarkgrade">');
    foreach my $disp_grade(@benchmark_grades) {
        $r->print('<option>'.$disp_grade.'</option>');
    }
    $r->print('</select>');
    $r->print('<select name="strand">');
    foreach my $disp_grade(@strands) {
        $r->print('<option value="'.$disp_grade.'">'.$disp_grade.'</option>');
    }
    $r->print('</select>');
    $r->print('<input type="submit" value="Show Benchmarks">');
    $r->print('<input type="hidden" value="'.$Apache::Promse::env{'token'}.'" name="token">');
    $r->print('<input type="hidden" value="ohiomath" name="target">');
    $r->print('</form>');
    
    my $java_script = qq ~
    <script language="JavaScript1.1">
    
    </script>
    ~;
    $r->print($java_script);
    $qry = 'select * from ohio_math_benchmarks';
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    $r->print('<div id="standards">');
    while (my $row = $sth->fetchrow_hashref){
        $r->print($$row{'description'}.'<br>');
        
    }
    $r->print('</div>');
    return 'ok';
}

sub get_user_expertise {
    my ($r) = @_;
    my $qry = "";
    my $sth;
    my %expertise;
    $qry = "select * from user_expertise where user_id = ".$Apache::Promse::env{'user_id'};
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    while (my $row = $sth->fetchrow_hashref()) {
        $expertise{$$row{'subject'}.$$row{'framework_index'}} = $$row{'level'};
    }
    return \%expertise;
}
sub framework_gizmo {
    my ($r, $context)= @_;
    my $expertise;
    my $tag;
    if ($r->param('action')) {
        $tag = $r->param('action');
    } else {
        $tag = $context;
    }
    if ($context eq 'expertise') {
        # returns hash ref where key is subject.index and value is level
        $expertise = &get_user_expertise($r);
    }
    my $target = $r->param('target');
    my $resource_id = $r->param('resourceid');
    my $click_cell;
    my $subject;
    my $url = &get_base_url;
    if (defined ($r->param('code'))) {
        $click_cell = $r->param('code');
    } else {
        $click_cell = '1';
    }
    if (defined ($r->param('subject'))) {
        $subject = $r->param('subject');
    } else {
        $subject = 'math';
    }
    my @parent_cell;
    #click sell has the form 1.2.3.4, from this we want to create
    # 1 1.2 1.2.3 1.2.3.4 and 1.2.3.4.*
    $click_cell .= '.n';
    my @mess = split /\./, $click_cell;
    my $build;
    foreach my $seg (@mess) {
        $build .= $seg.'.';
        my $save = $build;
        $save =~ s/\.$//;
        #print "saving $save <br>";
        push @parent_cell, $save;
    }
    if (@parent_cell) {
    } else {
         $parent_cell[0] = '1';
         $parent_cell[1] = '1.1';
    }
    if (defined $subject) {
    } else {
        $subject = 'math'
    }
    if ($tag eq 'tag' || $tag eq 'expertise') {
        print '<form method="post" action="'.$url.'">';
    }
    print '<span><a href="'.$url.'?token='.$Apache::Promse::env{'token'}.';action='.$tag.';resourceid='.$resource_id.';target='.$target.';subject=math;code=1">';
    if ($subject eq 'math') {
        print '<strong>[ Math ]</strong></a>';
    } else {
        print '[ Math ]</a>';
    }
    print '<a href="'.$url.'?token='.$Apache::Promse::env{'token'}.';action='.$tag.';resourceid='.$resource_id.';target='.$target.';subject=science;code=1">';
    if ($subject eq 'science') {
        print '<strong>[ Science ]</strong></a>';
    } else {
        print '[ Science ]</a>';
    }
    print '</span>';
    
    print '<table><tr>';
    foreach my $column (@parent_cell) {
        # this will print a table intended to occupy a column in table outside this loop
        print '<td valign="top">';
        &framework_grabber($r, $subject, $column, $context, $expertise);
        print '</td>';
    }
    print '</tr></table>';
    if ($tag eq 'tag') {
        print '<input type="submit" name="submit" value="Tag Resource">';
        print '<input type="hidden" name="token" value="'.$Apache::Promse::env{'token'}.'">';
        print '<input type="hidden" name="subject" value="'.$subject.'">';
        print '<input type="hidden" name="target" value="resource">';
        print '<input type="hidden" name="resourceid" value="'.$r->param('resourceid').'">';
        print '<input type="hidden" name="menu" value="browse">';
        print '<input type="hidden" name="action" value="tag">';
        print '</form>';
    } elsif ($tag eq 'expertise') {
        print '<input type="submit" name="submit" value="Save Interests">';
        print '<input type="hidden" name="token" value="'.$Apache::Promse::env{'token'}.'">';
        print '<input type="hidden" name="subject" value="'.$subject.'">';
        print '<input type="hidden" name="target" value="preferences">';
        print '<input type="hidden" name="action" value="expertise">';
        print '</form>';
    }
    return 'ok';
}


sub framework_reporter_grabber {
    my ($r, $subject, $level, $context, $expertise) = @_;
    my $district_id = $r->param('district');
    my $grade = $r->param('grade');
    my $tag;
    if ($r->param('action')) {
        $tag = $r->param('action');
    } else {
        $tag = $context;
    }
    my $resourceid = $r->param('resourceid');
    my $target = $r->param('target');
    # lots to do here!
    # @levels has to be a legit index of a framework element
    # assume to 0 element is highest of hierarchy if only one element
    # then only the top title is shown
    my $table = $subject.'_framework';
    my $bg_color_class;
    my $sql_regexp_sibs;
    my $sql_regexp_child;
    my @return_framework;
    my $url = &get_base_url($r);
    #have to build regexp in form ^level\\.level\\.[0-9]*$
    #first case is no periods in $level (which is the "parent cell")
    #in that case, we select the entire top level stuff
    my @levels = split /\./,$level;
    $sql_regexp_child = '^';
    $sql_regexp_sibs = '^';
    foreach my $sub_level (@levels) {
        $sql_regexp_child .= $sub_level.'\\.';
    }
    $sql_regexp_child .= '[0-9]*$';
    pop @levels; #this removes one of the levels, so we can retrieve the siblings
    foreach my $sub_level (@levels) {
        $sql_regexp_sibs .= $sub_level.'\\.';
    }
    $sql_regexp_sibs .= '[0-9]*$';
    
    my $qry = "select description, code, id, framework_id from $table ";
    $qry .= " LEFT JOIN dist_intended_curriculum as t2 on id = framework_id ";
    $qry .= " and t2.subject = '$subject' and t2.grade = $grade and t2.district_id = $district_id ";
    $qry .= " where code REGEXP '$sql_regexp_sibs' ";
    # print "<br>$qry</br>";
    my $sth;
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    print "<table>";
    while (my $framework_description = $sth->fetchrow_hashref) {
        if ($$framework_description{'code'} eq $level) {
            $bg_color_class = 'highlight';
        } else {
            $bg_color_class = 'lowlight';
        }
        print '<tr class="'.$bg_color_class.'"><td colspan="4">';
      
        if ($tag eq 'tag' || $tag eq 'expertise') {
            $r->print('<select name="level"><option>1</option><option>2</option><option>3</option></select>');
            $r->print('<input type="checkbox" name="tagcell" value="'.$$framework_description{'code'}.'" ');
            if (exists $$expertise{$subject.$$framework_description{'code'}}) {
                $r->print(' CHECKED');
            }
            $r->print(' />');
        } 
        print '<span><a href="'.$url.'?token='.$Apache::Promse::env{'token'}.';action='.$tag.';resourceid='.$resourceid.';target='.$target.';subject='.$subject.';district='.$district_id.';grade='.$grade.';code='.$$framework_description{'code'}.'">'.$$framework_description{'code'}."<br>".$$framework_description{'description'}."</a></span></td></tr>";
        if ($$framework_description{'framework_id'}) {
            $r->print('<tr class="background-color:#c00;" ><td style="background-color:#c00;">&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>');
        }
    }
    print "</table>";
    return 'ok';
}
sub get_districts {
    my ($r) = @_;
    my $qry = "";
    my $sth;
    my @return_array;
    $qry = "select district_id, district_name from districts order by district_name";
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    while (my $row = $sth->fetchrow_hashref) {
        my $rec={};
        push @return_array, $row;
    }
    return @return_array;
}
sub get_user_location {
    my $qry = "";
    my $sth;
    $qry = "select school, district_name, t1.district_id, t1.location_id, t1.zip from locations t1, user_locs t2, districts t3";
    $qry .=" where t1.location_id = t2.loc_id and t1.district_id = t3.district_id and ".$Apache::Promse::env{'user_id'}." = t2.user_id";
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    my $row = $sth->fetchrow_hashref;
    
    return $row;
}
sub survey_link {
    my ($r) = @_;
    #  need to read survey_id from user record somehow.
    $r->print('We are currently conducting surveys for all teachers. We hope you can spend some time in completing the surveys. ');
    $r->print('There are a total of three sets of surveys for each teacher. The first set is the same set for both Mathematics and Science teachers.');
    $r->print('The remaining sets are different. Please click on the links below to begin.<br>');
    $r->print('Thank you for your time.<br>');
    $r->print('<a href="apprentice?target=survey&token='.$Apache::Promse::env{'token'}.'&survey_id=1">For all teachers</a> <br />');
    $r->print('<a href="apprentice?target=survey&token='.$Apache::Promse::env{'token'}.'&survey_id=2">2nd set for Mathematics teachers</a> <br />');
    $r->print('<a href="apprentice?target=survey&token='.$Apache::Promse::env{'token'}.'&survey_id=3">3rd set for Mathematics teachers</a> <br />');
    $r->print('<a href="apprentice?target=survey&token='.$Apache::Promse::env{'token'}.'&survey_id=4">2nd set for Science teachers</a> <br />');
    $r->print('<a href="apprentice?target=survey&token='.$Apache::Promse::env{'token'}.'&survey_id=5">3rd set for Science teachers</a> <br />');
    
    return 'ok';
}
sub survey_save_answer {
    my ($r) = @_;
    my $q_num = $r->param('q_num');
    my $survey_id = $r->param('survey_id');
    my $qry;
    my %fields;
    my $save_flag;
    my $field_name;
    # need to replace existing answers, or add as needed
    # check if progress shows q_num answered
    $qry = "select * from survey_progress where user_id = ".$Apache::Promse::env{'user_id'}." and survey_id = $survey_id and q_num = $q_num";
    my $sth=$Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();

    # $r->print('Saving an answer <br />');
    foreach my $field ($r->param()) {
        if ($field =~ /surv_(.+)/) {
            $field_name = $1;
            # now check if it's an array of values
            my @stuff = $r->param($field);
            foreach my $value(@stuff) {
                if ($value =~ m/.+/) {
                    $fields{'answer'} = &fix_quotes($value);
                    $fields{'field_name'} = &fix_quotes($field_name);
                    $fields{'q_num'} = $q_num;
                    $fields{'user_id'} = $Apache::Promse::env{'user_id'};
                    $fields{'survey_id'} = $survey_id;
                    &save_record('survey_answers',\%fields);
                }
            }
            $save_flag = 'true';
        }
    }
    if ($save_flag eq 'true') {
        $qry = "delete from survey_answers where answer=''";
        #$Apache::Promse::env{'dbh'}->do($qry);
        $qry = "delete from survey_progress where user_id = ".$Apache::Promse::env{'user_id'}." and survey_id = $survey_id and q_num = $q_num";
        $Apache::Promse::env{'dbh'}->do($qry);
        undef (%fields);
        $fields{'user_id'} = $Apache::Promse::env{'user_id'};
        $fields{'survey_id'} = $survey_id;
        $fields{'q_num'} = $q_num;
        &save_record('survey_progress',\%fields);
    }
    
    
    # if yes, blow away old answers, and insert new ones
    # if no, then just insert new ones
    return 'ok';
}
sub survey {
    my ($r) = @_;
    # first, will save answer, then display progress, finally offer next question.
    # could enter with no question set, with question answered, or with NEXT question set
    if ($r->param('save_answer')) {
        &survey_save_answer($r);
    }
    my $strong_on;
    my $strong_off;
    my $q_num = 1;
    my $progress = &survey_progress($r);
    foreach my $p (@$progress) {
        if ($$p{'done'}) {
            $q_num = $$p{'q_num'} + 1;
            $strong_on = '<strong>';
            $strong_off = '</strong>';
        } else {
            $strong_on = '';
            $strong_off = '';
        }
        $r->print($strong_on.'['.$$p{'q_num'}.']'.$strong_off);
        if ($$p{'q_num'} == 20) {
            $r->print('<br />');
        }
    }
    
    $r->print('<p>');
    my $qpath = "/var/www/html/questions/";
    my $q_txt = $$progress[$q_num - 1]{'q_txt'};
    open (QIN, "< $qpath"."$q_txt") || $r->print("can't open file $q_txt");
    $r->print('<form method="post" action="">');
    while (<QIN>) {
        $r->print($_);
    }
    $r->print('');
    my %hidden_fields;
    $hidden_fields{'survey_id'} = $r->param('survey_id');
    $hidden_fields{'q_num'} = $q_num;
    $hidden_fields{'target'} = 'survey';
    $hidden_fields{'save_answer'} = 'true';
    &hidden_fields($r, \%hidden_fields);
    $r->print('<br /><input type="submit" value="Submit Answer"');
    $r->print('</form>');
    close QIN;
    
    return 'ok';
}
sub survey_progress {
    my ($r) = @_;
    my $survey_id = $r->param('survey_id');
    my $i = 0;
    my @survey_path;
    my $qry = "select t1.q_txt, t1.q_num,  t2.q_num as done from survey_defs t1";
    $qry.= " LEFT JOIN survey_progress t2 on t2.user_id = ".$Apache::Promse::env{'user_id'}." and t1.survey_id = t2.survey_id and t1.q_num = t2.q_num";
    $qry.= " where t1.survey_id = $survey_id order by t1.q_num";
    # $r->print('<br>'.$qry.'<br>');
    my $sth=$Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    while (my $row = $sth->fetchrow_hashref()) {
        push (@survey_path, {%$row});
    }
    #return an array of hashes with keys of q_num, 'done' if done
    return (\@survey_path);
}
sub get_survey_def {
    my ($r) = @_;
    my $survey_id = $r->param('survey_id');
    my $qry = "select * from survey_defs where survey_id = $survey_id order by q_num";
    my $sth=$Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    my @return_array;
    while (my $row = $sth->fetchrow_hashref()) {
        $return_array[$$row{'q_num'}] = {%$row};
    }
    return (\@return_array);
}
sub check_node {
    my ($district, $code, $children) = @_;
    my $qry = "";
    my $sth;
    my $selected;
    my $below;
    my %grades;
    my %grades_below;
    $qry = "select grade, code, framework_id from dist_intended_curriculum t1, math_framework t2";
    $qry .= " where t1.framework_id = t2.id and $district = district_id and code like '%".$code."' ";
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    
    while (my  $row = $sth->fetchrow_hashref) {
        # &logthis("the code is ".$$row{'code'}.' and '.$code);
        if ($$row{'code'} eq $code) {
            $selected=1;
            $grades{$$row{'grade'}} = 1;
        } else {
            $below=1;
            $grades_below{$$row{'grade'}} = 1;
        }
        
    }
    return ($selected, $below, \%grades, \%grades_below);
}
sub get_curriculum {
    my ($district, $state, $location_id) = @_;
    # returns @all_info, each element contains a hash %row_info
    my $qry = "";
    my $sth;
    my @all_info;
    my %row_info;
    my %grades;
    my %grades_below;
    $qry = "select t2.code as topic_code, t1.code as dist_code, t1.description, t3.grade as dist_grade, ";
    $qry .= " t4.grade as state_grade, t5.grade as intended_grade, t6.grade as achieved_grade "; 
    $qry .= " from math_framework t1, math_topics t2 ";
    $qry .= " LEFT JOIN dist_intended_curriculum t3 on t1.id = t3.framework_id and t3.subject = 'math' and t3.district_id = $district ";
    $qry .= " LEFT JOIN intended_curriculum t4 on t4.framework_id = t1.id and t4.state = '$state' ";
    $qry .= " LEFT JOIN implemented_curriculum t5 on t5.framework_id = t1.id and t5.location_id = $location_id ";
    $qry .= " LEFT JOIN achieved_curriculum t6 on t6.framework_id = t1.id and t6.location_id = $location_id ";
    $qry .= "where t1.code like concat(t2.code,'%')  ";
    $qry .= "order by t2.id, t1.id";
    &logthis($qry);
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    return ($sth);
}
sub get_math_topics {
    my $qry = "";
    my $sth;
    my @return_array;
    $qry = "select t1.id, t1.code, description from math_topics t1, math_framework t2 where t1.code = t2.code order by id";
    #&logthis($qry);
    $sth=$Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    while (my $row = $sth->fetchrow_hashref()) {
        push @return_array, $row;
    }
    return \@return_array;
}
sub districtid_to_name {
    my ($district_id) = @_;
    my $qry = "";
    my $sth;
    $qry = "select district_name from districts where district_id = $district_id";
    #&logthis($qry);
    $sth=$Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    my $row=$sth->fetchrow_hashref();
    
    return $$row{'district_name'};
}
 sub display_23 {
    my ($r) = @_;
    my $loc_dist_hashref = &get_user_location($Apache::Promse::env{'user_id'});
    my $state_id;
    my $state_name;
    my $district_id;
    my $location_id = $$loc_dist_hashref{'location_id'};
    &logthis('the users id is'.$Apache::Promse::env{'user_id'});
    &logthis('the location id is'.$location_id);
    my $district_name;
    if ($r->param('district')) {
        $district_id = $r->param('district');
        $district_name = &districtid_to_name($district_id);
    } else {
        $district_id = $$loc_dist_hashref{'district_id'};
        $district_name = $$loc_dist_hashref{'district_name'};
    }
    if ($r->param('state')) {
        $state_id = $r->param('state');
        if ($state_id eq 'MI') {
            $state_name = 'Michigan';
        } elsif ($state_id eq 'OH') {
            $state_name = 'Ohio';
        }
    } else {
        $state_id = 'AP';
        $state_name = 'Top Achieving Countries';
    }
    my @grades = (1,2,3,4,5,6,7,8);
    my @districts = &get_districts();
    my %fields;
<<<<<<< Promse.pm
    $r->print('</div>');
    $r->print('Your district is '.$$loc_dist_hashref{'district_name'}.'<br>');
    $r->print('Your school is '.$$loc_dist_hashref{'school'}.'<br>');
=======
    $r->print('Your district is '.$$loc_dist_hashref{'district_name'}.' and ');
    $r->print('school is '.$$loc_dist_hashref{'school'}.'<br>');
>>>>>>> 1.32
    $r->print('<form method="post" action="apprentice">');
    $r->print('<select name="district">');
    foreach my $district (@districts) {
        $r->print('<option value="'.$$district{'district_id'}.'" ');
        if ($district_id eq $$district{'district_id'}){
            $r->print('SELECTED');
        }
        $r->print('>'.$$district{'district_name'}.'</option>');
    }
    $r->print('</select>');
    $r->print('<select name="state">');
    $r->print('<option ');
    if ($state_id eq "MI") {
        $r->print('SELECTED');
    }
    $r->print('>MI</option>');
    $r->print('<option ');
    if ($state_id eq "OH") {
        $r->print('SELECTED');
    }
    $r->print('>OH</option>');
    $r->print('<option value="AP" ');
    if ($state_id eq "AP") {
        $r->print('SELECTED');
    }
    $r->print('>Top Achieving Countries</option>');
    $r->print('</select>');
    $fields{'target'} = 'frameworkreporter';
    $r->print('<input type="submit" value="Change District and State/A+">');
    &hidden_fields($r, \%fields);
    $r->print('</form>');
    $r->print('Here is the intended curriculum of district <strong>'.$district_name.'('.$district_id.')</strong>:<br>');
    $r->print('The blue squares are the '.$state_name.' curriculum.');
    if ($state_id eq "AP") {
        $r->print('<br>Note that this alignment is based on the comparison of the overlapping content areas of the curricula.');
    }    
    my $sth = &get_curriculum($district_id, $state_id, $location_id);
    $r->print('<div>');
    $r->print('<table id="tableCurriculum">');
    $r->print('<tr><th></th><th colspan="8" align="center">Grade</th></tr>');
    $r->print('<tr><th align="center">Topic</th><th align="center">');
    $r->print('1</th><th align="center">2</th><th align="center">');
    $r->print('3</th><th align="center">4</th><th align="center">');
    $r->print('5</th><th align="center">6</th><th align="center">');
    $r->print('7</th><th align="center">8</th></tr><tbody id="tbodyCurriculum">');
    my $save_topic_code;
    my $save_sub_code;
    my %row_info;
    my %state_grade_cells;
    my %dist_grade_cells;
    my %intended_grade_cells;
    my %achieved_grade_cells;
    while (my $row=$sth->fetchrow_hashref()) {
        if ($save_topic_code eq $$row{'topic_code'}) {
            if ($$row{'topic_code'} eq $$row{'dist_code'}) {
               if ($$row{'dist_grade'}) {
                    $dist_grade_cells{$$row{'dist_grade'}} = 'true';
                } 
                if ($$row{'state_grade'}) {
                    $state_grade_cells{$$row{'state_grade'}} = 'true';
                }
                if ($$row{'intended_grade'}) {
                    $intended_grade_cells{$$row{'intended_grade'}} = 'true';
                } 
                if ($$row{'achieved_grade'}) {
                    $achieved_grade_cells{$$row{'achieved_grade'}} = 'true';
                }
                
            }
        } else {
            if ($row_info{'description'}) {
                &write_curriculum_row($r, \%row_info, \%state_grade_cells, \%dist_grade_cells, \%intended_grade_cells, \%achieved_grade_cells);
                undef %dist_grade_cells;
                undef %state_grade_cells;
                undef %intended_grade_cells;
                undef %achieved_grade_cells;
                delete $row_info{'description'};
            }
            $save_topic_code = $$row{'topic_code'};
            $row_info{'description'} = $$row{'description'};
            $row_info{'topic_code'} = $$row{'topic_code'};
            if ($$row{'topic_code'} eq $$row{'dist_code'}) {
                # need to pick the district or state grade info
                if ($$row{'dist_grade'}) {
                    $dist_grade_cells{$$row{'dist_grade'}} = 'true';
                } 
                if ($$row{'state_grade'}) {
                    $state_grade_cells{$$row{'state_grade'}} = 'true';
                }
                if ($$row{'intended_grade'}) {
                    $intended_grade_cells{$$row{'intended_grade'}} = 'true';
                } 
                if ($$row{'achieved_grade'}) {
                    $achieved_grade_cells{$$row{'achieved_grade'}} = 'true';
                }
            }
            # new topic, so new row of table begins
        }
    }
    if ($row_info{'description'}) {
       &write_curriculum_row($r, \%row_info, \%state_grade_cells, \%dist_grade_cells,\%intended_grade_cells,\%achieved_grade_cells);
    }
    
    $r->print('</tbody></table>');
    $r->print('</div>');
    return 'ok';
}

sub write_curriculum_row {
    my ($r, $row_info, $state_grade_cells, $dist_grade_cells, $intended_grade_cells, $achieved_grade_cells) = @_;
    my $loc_dist_hashref = &get_user_location($Apache::Promse::env{'user_id'});
    my $district_id;
    my $district_name;
    if ($r->param('district')) {
        $district_id = $r->param('district');
        $district_name = &districtid_to_name($district_id);
    } else {
        $district_id = $$loc_dist_hashref{'district_id'};
        $district_name = $$loc_dist_hashref{'district_name'};
    }
    my @grades = (1,2,3,4,5,6,7,8);
    $r->print('<tr><td>');
    $r->print('<a href="apprentice?token='.$r->param('token').'&target=search&district='.$district_id.'&code='.$$row_info{'topic_code'}.'">');
    $r->print($$row_info{'description'}.'</a></td>');
    foreach my $grade (@grades) {
        my $cell_name = '0000';
        if ($$state_grade_cells{$grade}) {
            $cell_name = $cell_name | '1000';
        }
        if ($$dist_grade_cells{$grade}) {
            $cell_name = $cell_name | '0100';
        }
        if ($$intended_grade_cells{$grade}) {
            $cell_name = $cell_name | '0010';  
        }
        if ($$achieved_grade_cells{$grade}){
            $cell_name = $cell_name | '0001';
        }
        $r->print('<td><img src="../images/'.$cell_name.'.gif" /></td>');
    }
    $r->print('</tr>');
    return 'ok';
}


sub framework_reporter {
    my ($r, $context)= @_;
    my $step = $r->param('step');
    my %hidden_fields;
    my @districts = &get_districts();
    my $url;
    $url = "apprentice?token=".$Apache::Promse::env{'token'}.";target=frameworkreporter";
    $r->print('<div id="interiorHeader">');
    $r->print('<h2>The big picture</h2>');
    $r->print('<h3>District, state, and exemplary curricula . . . </h3');
    $r->print('<div>');
    if ($Apache::Promse::env{'menu'} eq 'overall') {
        print '<a href="'.$url.'&menu=overall" ><strong style="content">[ Over Framework ]</strong></a>';
    } else {
        print '<a href="'.$url.'&menu=overall">[ Over Framework ]</a>';
    }
    if ($Apache::Promse::env{'menu'} eq 'topiccompare') {
        print '<a href="'.$url.'&menu=topiccompare"><strong>[ Topic Compare ]</strong></a>';
    } else {
        print '<a href="'.$url.'&menu=topiccompare">[ Topic Compare ]</a>';
    }
    $r->print('</div>');
    if ($Apache::Promse::env{'menu'} eq 'overall') {
        &display_23($r);
    }
    if ($Apache::Promse::env{'menu'} eq 'topiccompare') {
        &topic_compare($r);
    }
    return 'ok';
}
<<<<<<< Promse.pm
sub topic_compare {
    my ($r)= @_;
    $r->print('this is topic compare');
    return 'ok';
}
=======

sub topic_compare {
    my ($r)= @_;
    $r->print('this is topic compare');
    return 'ok';
}

>>>>>>> 1.32
sub save_meta_data {
    my ($r) = @_;
    # first have to see if the tag already exists.
    my %fields;
    my $subject = $r->param('subject');
    $fields{'description'} = &fix_quotes($subject." Framework");
    $fields{'location'} = &fix_quotes($r->param('tagcell'));
    $fields{'contributor'} = $Apache::Promse::env{'user_id'};
    my $new_record_id = &save_record('tags', \%fields, 'id');
    undef %fields;
    $fields{'res_id'} = $r->param('resourceid');
    $fields{'tag_id'} = $new_record_id;
    &save_record('res_meta',\%fields);
    return 'ok';
}
sub get_base_url {
    my ($r) = @_;
    my $url = $r->self_url();
    if ($url=~/mentor\?/) {
        $url = 'mentor';
    } elsif ($url=~/apprentice\?/) {
        $url = 'apprentice';
    } elsif ($url=~/editor\?/) {
        $url = 'editor';
    } elsif ($url=~/home\?/) {
        $url = 'home';
    }
    return $url;
}

sub framework_grabber {
    my ($r, $subject, $level, $context, $expertise) = @_;
    my $tag;
    if ($r->param('action')) {
        $tag = $r->param('action');
    } else {
        $tag = $context;
    }
    my $resourceid = $r->param('resourceid');
    my $target = $r->param('target');
    # lots to do here!
    # @levels has to be a legit index of a framework element
    # assume to 0 element is highest of hierarchy if only one element
    # then only the top title is shown
    my $table = $subject.'_framework';
    my $bg_color_class;
    my $sql_regexp_sibs;
    my $sql_regexp_child;
    my @return_framework;
    my $url = &get_base_url($r);
    #have to build regexp in form ^level\\.level\\.[0-9]*$
    #first case is no periods in $level (which is the "parent cell")
    #in that case, we select the entire top level stuff
    my @levels = split /\./,$level;
    $sql_regexp_child = '^';
    $sql_regexp_sibs = '^';
    foreach my $sub_level (@levels) {
        $sql_regexp_child .= $sub_level.'\\.';
    }
    $sql_regexp_child .= '[0-9]*$';
    pop @levels; #this removes one of the levels, so we can retrieve the siblings
    foreach my $sub_level (@levels) {
        $sql_regexp_sibs .= $sub_level.'\\.';
    }
    $sql_regexp_sibs .= '[0-9]*$';
    
    my $qry = "select description, code from $table where code REGEXP '$sql_regexp_sibs'";
    #print "<br>$qry</br>";
    # my $dbh = &db_connect();
    my $sth;
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    $r->print('<table>');
    while (my $framework_description = $sth->fetchrow_hashref) {
        if ($$framework_description{'code'} eq $level) {
            $bg_color_class = 'highlight';
        } else {
            $bg_color_class = 'lowlight';
        }
        $r->print('<tr class="'.$bg_color_class.'"><td>');
      
        if ($tag eq 'tag' || $tag eq 'expertise') {
            $r->print('<select name="level"><option>1</option><option>2</option><option>3</option></select>');
            $r->print('<input type="checkbox" name="tagcell" value="'.$$framework_description{'code'}.'" ');
            if (exists $$expertise{$subject.$$framework_description{'code'}}) {
                $r->print(' CHECKED');
            }
            $r->print(' />');
        } 
        $r->print('<span><a href="'.$url.'?token='.$Apache::Promse::env{'token'});
        $r->print(';action='.$tag.';resourceid='.$resourceid.';target='.$target);
        $r->print(';subject='.$subject.';code='.$$framework_description{'code'}.'">');   
        $r->print($$framework_description{'code'}."<br>".$$framework_description{'description'}); 
        $r->print('</a></span></td></tr>');
    }
    $r->print('</table>');
    return 'ok';
}
sub mentor_top_questions {
    my ($r) = @_;
    my $qry = "";
    my $mentor_id = $r->param('mentorid');
    my $sth;
    my $text;
    my $firstname;
    my $lastname;
    my $bio;
    $qry = "select t1.content, t2.content as question, firstname, lastname, bio from answers t1
        LEFT JOIN questions t2 on t1.question_id = t2.question_id 
        LEFT JOIN users t3 on t3.id = t1.user_id
        where t1.user_id = $mentor_id";
    &logthis($qry);
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    $r->print('<div id="interiorHeader">');
    $r->print('<h2>Mentor Top Responses</h2>');
    $r->print('<h3>Great ideas are just a click away...</h3>');
    $r->print('</div>');
    $r->print('<h4>Top Mentor Responses</h4>');
    $r->print('<div class="floatLeft">');
    $r->print('<div id="lookupScroller">');
    while (my $row = $sth->fetchrow_hashref()) {
        $firstname = $$row{'firstname'};
        $lastname = $$row{'lastname'};
        $bio = $$row{'bio'};
        $r->print('<strong>Question:</strong><br>');
        $text=$$row{'question'};
        $text=~ s/\n/<br>/g;
        $r->print('<p class="content">'.$text.'</p>');
        $r->print('<strong>Answer:</strong><br>');
        $text=$$row{'content'};
        $text=~ s/\n/<br>/g;
        $r->print('<p class="content">'.$text.'</p>');
    }
    $r->print('</div></div>');
    $r->print('<div class="floatLeft">');
    $r->print('<h4>About the Top Mentor</h4>');
    $r->print('<div id="lookupScroller">');
    $r->print('<strong>'.$firstname.' '.$lastname.'</strong>');
    $bio =~ s/\n/<br>/g;
    $r->print('<p class="content">'.$bio.'</p>');
    $r->print('</div>');
    $r->print('</div>');
    
    return 'ok';
}

sub user_preferences_menu {
    my ($r) = @_;
    my $url = $r->self_url();
    if ($url =~ /apprentice\?/) {
        $url = "aprentice?token=".$Apache::Promse::env{'token'}.";target=preferences";
    } else {
        $url = "home?token=".$Apache::Promse::env{'token'}.";target=preferences";
    }
    my $menu = $r->param('menu');
    print '<p >';
    if ($menu eq 'profile') {
        print '<a href="'.$url.'&menu=profile"><strong>[ Profile ]</strong></a>';
    } else {
        print '<a href="'.$url.'&menu=profile">[ Profile ]</a>';
    }
    if ($menu eq 'interests') {
        print '<a href="'.$url.'&menu=interests" ><strong style="content">[ Professional Interests ]</strong></a>';
    } else {
        print '<a href="'.$url.'&menu=interests">[ Professional Interests ]</a>';
    }
    if ($menu eq 'settings') {
        print '<a href="'.$url.'&menu=settings"><strong>[ Preferences ]</strong></a>';
    } else {
        print '<a href="'.$url.'&menu=settings">[ Preferences ]</a>';
    }
    
    print '</p>';    
    return 'ok';
}

sub framework_grabber_old {
    my ($r) = @_;
    # lots to do here!
    # @levels has to be a legit index of a framework element
    # assume to 0 element is highest of hierarchy if only one element
    # then only the top title is shown
    my @levels = $r->param('level');
    my $subject = $r->param('subject');
    my $table = $subject.'_framework';
    my $table_index = $table.'_index ';
    my $where_clause;
    my $num_levels = scalar @levels;
    for (my $i = 1; $i < $num_levels; $i++) {
        $where_clause .= 'level_val = '.$levels[($i-1)].' and ';
        $where_clause .= 'level = '.$i.' and ';
    }
    $where_clause .= 'level <> '.($num_levels + 1);
    my $qry = "select description from $table where id in (select id from $table_index where $where_clause)";
    print "<br>$qry</br>";
    # my $dbh = &db_connect();
    my $sth;
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    while (my $framework_description = $sth->fetchrow_hashref) {
        print $$framework_description{'description'}."<br>";
    }
    return 'ok';
}

sub ohio_standard_grabber {
    my ($r) = @_;
    # lots to do here!
    # @levels has to be a legit index of a framework element
    # assume to 0 element is highest of hierarchy if only one element
    # then only the top title is shown
    my @levels = $r->param('level');
    my $subject = $r->param('subject');
    my $table = $subject.'_framework';
    my $table_index = $table.'_index ';
    my $where_clause;
    my $num_levels = scalar @levels;
    for (my $i = 1; $i < $num_levels; $i++) {
        $where_clause .= 'level_val = '.$levels[($i-1)].' and ';
        $where_clause .= 'level = '.$i.' and ';
    }
    $where_clause .= 'level <> '.($num_levels + 1);
    my $qry = "select description from $table where id in (select id from $table_index where $where_clause)";
    print "<br>$qry</br>";
    # my $dbh = &db_connect();
    my $sth;
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    while (my $framework_description = $sth->fetchrow_hashref) {
        print $$framework_description{'description'}."<br>";
    }
    return 'ok';
}
sub fix_quotes {
    my ($fixed) = @_;
    $fixed =~ s/'/''/g;
    return " '".$fixed."' ";
}

sub send_message {
    my ($r, $draft) = @_;
    my %fields;
    my $message_id;
    if ($r->param('reply') eq 'true') {
        my $reply_id = $r->param('replyid');
        $fields{'reply'} = $reply_id;
    }
    if ($draft eq 'draft') {
        my %id;
        $id{'id'} = $r->param('messageid');
        if ($r->param('Submit') eq 'Save Message') {
            $fields{'is_sent'} = '0';
        } else {
            $fields{'is_sent'} = '1';
        }
        $fields{'recipient'} = $r->param('recipient');
        $fields{'subject'} = &fix_quotes($r->param('subject'));
        $fields{'content'} = &fix_quotes($r->param('content'));
        &update_record('comms',\%id,\%fields);
    } else {
        $fields{'date'} = ' now() ';
        if ($r->param('Submit') eq 'Save Message') {
            $fields{'is_sent'} = '0';
        } else {
            $fields{'is_sent'} = '1';
        }
        $fields{'is_read'} = '0';
        $fields{'sender_is_deleted'} = '0';
        $fields{'recipient_is_deleted'} = '0';
        $fields{'type'} =  '1';
        $fields{'sender'} = "$Apache::Promse::env{'user_id'}";
        $fields{'recipient'} = $r->param('recipient');
        $fields{'subject'} = &fix_quotes($r->param('subject'));
        $fields{'content'} = &fix_quotes($r->param('content'));
        &save_record('comms',\%fields);
    }    
    return 'ok';
}

sub send_question {
    my ($r, $draft) = @_;
    my %fields;
    my $message_id;
    if ($draft eq 'draft') {
        my %id;
        $id{'question_id'} = $r->param('messageid');
        if ($r->param('Submit') eq 'Save Question') {
            $fields{'is_sent'} = '0';
        } else {
            $fields{'is_sent'} = '1';
        }
        $fields{'subject'} = &fix_quotes($r->param('subject'));
        $fields{'content'} = &fix_quotes($r->param('content'));
        $fields{'standard'} = &fix_quotes($r->param('contentarea'));
        &update_record('questions',\%id,\%fields);
    } else {
        $fields{'date'} = ' now() ';
        if ($r->param('Submit') eq 'Save Question') {
            $fields{'is_sent'} = '0';
        } else {
            $fields{'is_sent'} = '1';
        }
        $fields{'is_read'} = '0';
        $fields{'user_id'} = $Apache::Promse::env{'user_id'};
        $fields{'subject'} = &fix_quotes($r->param('subject'));
        $fields{'content'} = &fix_quotes($r->param('content'));
        $fields{'standard'} = &fix_quotes($r->param('contentarea'));
        my $question_id = &save_record('questions',\%fields, 'id');
        my @framework_codes = $r->param('frameworkcode');
        foreach my $check (@framework_codes) {
            my $qry = "insert into question_framework (question_id, framework_id) values ($question_id, $check)";
            $Apache::Promse::env{'dbh'}->do($qry);
            
        }
    }    
    return 'ok';
}

sub send_answer {
    #$r->param('messageid') refers to the original question id number
    my ($r, $draft) = @_;
    my %fields;
    my $message_id;
    if ($draft eq 'draft') {
        my %id;
        $id{'id'} = $r->param('messageid');
        if ($r->param('Submit') eq 'Save Answer') {
            $fields{'is_sent'} = '0';
        } else {
            $fields{'is_sent'} = '1';
        }
        $fields{'content'} = &fix_quotes($r->param('content'));
        &update_record('answers',\%id,\%fields);
    } else {
        $fields{'date'} = ' now() ';
        if ($r->param('Submit') eq 'Save Answer') {
            $fields{'is_sent'} = '0';
        } else {
            $fields{'is_sent'} = '1';
        }
        $fields{'user_id'} = $Apache::Promse::env{'user_id'};
        $fields{'question_id'} = $r->param('messageid');
        $fields{'content'} = &fix_quotes($r->param('content'));
        &save_record('answers',\%fields);
    }    
    return 'ok';
}


sub mentor_question_alert {
    my ($r) = @_;
    my $qry = "";
    # my $dbh = &db_connect();
    my $sth;
    $qry = "select * from questions where is_read = 0";
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    if ($sth->rows == 1) {
        print "<span>There is ".$sth->rows." unread question for mentors.</span>";
    } else {
        print "<span>There are ".$sth->rows." unread questions for mentors.</span>";
    }
    return 'ok';
}

sub apprentice_question_form {
my ($r) = @_;    
print qq~
      <table width="100%" border="0" cellspacing="0" cellpadding="10">
        <tr>
          <td align="left" valign="top"> 
            <p><span class="header">Associate Workspace</span><br>
              <span class="subheader">What do you want to learn today?</span></p>
            <p class="content">Please use the form below to ask a Mentor a question:</p>
            <form name="form1" method="post" action="apprentice-question">
              <table width="100%" border="0" cellpadding="0" cellspacing="0" bgcolor="#006634">
                <tr> 
                  <td align="center" valign="middle" bgcolor="#006634"><table width="100%" border="0" cellspacing="1" cellpadding="2">
                      <tr> 
                        <td colspan="2" class="header"><font color="#FFFFFF">Ask 
                          A Question</font></td>
                      </tr>
                      <tr bgcolor="#D9EAE4" class="content"> 
                        <td align="left" valign="top"><strong>Field</strong></td>
                        <td align="left" valign="top"><strong>Data</strong><strong></strong></td>
                      </tr>
                      <tr valign="middle" bgcolor="#EEEEEE" class="content">
                        <td align="left"><strong>Response Time (Days)</strong></td>
                        <td align="left"><select name="select" id="select">
                            <option value="1" selected>1</option>
                            <option value="2">2 </option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="16">16</option>
                            <option value="17">17</option>
                            <option value="18">18</option>
                            <option value="19">19</option>
                            <option value="20">20</option>
                            <option value="21">21</option>
                          </select></td>
                      </tr>
                      <tr valign="middle" bgcolor="#EEEEEE" class="content"> 
                        <td align="left"><strong>Standard:</strong></td>
                        <td align="left"> <select name="standard" id="standard">
                            <option value="1">1.1.1.1</option>
                            <option value="2" selected>1.1.1.2</option>
                          </select> </td>
                      </tr>
                      <tr valign="middle" bgcolor="#FFFFFF" class="content"> 
                        <td align="left"><strong>Subject:</strong></td>
                        <td align="left"> <input name="subject" type="text" id="subject" value="" size="60"></td>
                      </tr>
                      <tr bgcolor="#EEEEEE" class="content"> 
                        <td align="left" valign="top"><strong>Question:</strong></td>
                        <td align="left" valign="top"><textarea name="question" cols="55" rows="10"></textarea></td>
                      </tr>
                      <tr align="center" valign="middle" bgcolor="#FFFFFF" class="content"> 
                        <td colspan="2"><input name="Submit" type="submit" id="Save Question" value="Save Question">
~;                        
print                        '<input type="hidden" name="token" value="'.$Apache::Promse::env{'token'}.'">';
print qq~
                          <input type="submit" name="Submit" value="Submit Question"> 
                          </td>
                      </tr>
                    </table></td>
                </tr>
              </table>
            </form>
            <p class="content"><span class="content"><br>
~;
print    '     &lt; <a href="apprentice?token='.$Apache::Promse::env{'token'}.'">Return to your Inbox</a> </span></p></td>';
print qq~        </tr>
      </table>
~;
}

sub compose_message_form {
    my ($r) = @_;    
    my $message_id = $r->param('messageid');
    my $reply_id;
    my $destination_menu;
    my $sender;
    my $recipient;
    my $subject;
    my $content;
    my $selected;
    my $message_hashref;
    my $action = $r->param('action');
    $destination_menu = 'outbox';
    if ($r->param('menu') eq 'drafts') {
        print "<h4>Editing a draft</h4>";
        $message_hashref = &retrieve_message($r->param('messageid'));
        $subject = $$message_hashref{'subject'};
        $content = $$message_hashref{'content'};
        $recipient = $$message_hashref{'recipient'};
        $destination_menu = 'drafts';
    }
    my $url = "home";
    print '<h4>Compose A Message</h4>'."\n";          
    print '<form name="form1" method="post" action="'.$url.'">';
    print '<fieldset><label>To:</label><br>'."\n";
    my $address_book_hashref = &get_address_book($r);
    if ($action eq 'Reply') {
        $message_hashref = &retrieve_message($message_id);
        $subject = $$message_hashref{'subject'};
        $subject = 'Re: '.$subject;
        $content = $$message_hashref{'content'};
        $recipient = $$message_hashref{'sender'};
        $sender = $$message_hashref{'recipient'};
        $reply_id = $message_id;
        print &userid_to_display_name($recipient);
    } else {
        print '<select name="recipient">'."\n";
        foreach my $row (sort keys %$address_book_hashref) {
            if ($$address_book_hashref{$row}{'id'} eq $recipient) {
                $selected = "selected";
            } else {
                $selected = "";
            }
            print '<option '.$selected.' value="'.$$address_book_hashref{$row}{'id'}.'">'.$$address_book_hashref{$row}{'lastname'}.'</option>'."\n";
        }
        print '</select>'."\n";
    }
    print '<div><label>Subject:</label>'."\n";
    print '<input name="subject" type="text" id="subject" value="'.$subject.'" size="60" /></div>'."\n";
    $r->print('<div><label>Message:</label></div>'."\n");
    $r->print('<div><textarea name="content" cols="55" rows="10">'.$content.'</textarea></div>'."\n");
    $r->print('</fieldset>'."\n");
    print '<input class="buttonGroup" name="Submit" type="submit" id="Save Message" value="Save Message" />'."\n";
    print '<input type="hidden" name="token" value="'.$Apache::Promse::env{'token'}.'" />'."\n";
    if ($action eq 'Reply') {
        print '<input type="hidden" name="reply" value="true" />'."\n";
    }
    print '<input type="hidden" name="messageid" value="'.$message_id.'" />'."\n";
    print '<input type="hidden" name="replyid" value="'.$reply_id.'">';
    print '<input type="hidden" name="recipient" value="'.$recipient.'" />'."\n";
    print '<input type="hidden" name="target" value="message" />'."\n";
    print '<input type="hidden" name="menu" value="'.$destination_menu.'" />'."\n";
    print '<input type="hidden" name="action" value="send" />'."\n";
    print '<input type="submit" name="Submit" value="Submit Message" />'."\n";
    $r->print('</form>');
    return 'ok';
}
sub question_progress {
    my ($r) = @_;
    $r->print('<strong>Subject Area: </strong>'.$r->param('contentarea').'<br>');
    $r->print('<strong>Question Summary: </strong>'.$r->param('subject').'<br>');
    $r->print('<strong>Question: </strong>'.$r->param('content').'<br>');
    return 'ok';
}

sub compose_question_form {
    my ($r) = @_;    
    my $message_id = $r->param('messageid');
    my %hidden_fields;
    my $subject;
    my $content;
    my $content_area;
    my $action = $r->param('action');
    my $step = $r->param('step');
    $r->print('<div id="composeQuestion"><h5>');
    #if ($step eq 1) {
    #    $r->print('<p>Step 1 of 4</p>');
    #    $r->print('Subject area of your question');
        $r->print('<table><tr valign=baseline ><td height ="40"><form name="form1" method="post" action="apprentice">');
        $r->print('Subject area         <input type="radio" name="contentarea" value="math" />');
        $r->print('Math | <input type="radio" name="contentarea" value="science" /> Science</td></tr></table>');
        $hidden_fields{'target'} = 'questions';
        $hidden_fields{'menu'} = 'compose';
    #   $hidden_fields{'step'} = 2;
        &hidden_fields($r, \%hidden_fields);
    #    $r->print('<hr align="center" width="100%" />');
    #   $r->print('<p>&nbsp;<input type="submit" value="Next->">&nbsp;</p>');
        $r->print('</form>');
   	#} elsif ($step eq 2) {
    #   $r->print('<p>Step 2 of 4</p>');
    #   &question_progress($r);
    #   $r->print('Subject of your question.');
				$r->print('<p></p>');
        $r->print('Title<form name="form1" method="post" action="apprentice">');
        $r->print('<input type="text" maxlength="150" size="30" name="subject" /><br />');
    #   $r->print('<input type="submit" value="Next->">');
    #   $hidden_fields{'contentarea'} = $r->param('contentarea');
    #   $hidden_fields{'target'} = 'questions';
    #   $hidden_fields{'menu'} = 'compose';
    #   $hidden_fields{'step'} = 3;
    #   &hidden_fields($r, \%hidden_fields);
        $r->print('</form>');
    #} elsif ($step eq 3) {
    #   $r->print('<p>Step 3 of 4</p>');
    #   &question_progress($r);
        
        $r->print('Write your question below. ');
        $r->print('<form name="form1" method="post" action="apprentice">');
        $r->print('<textarea name="content" rows="10" cols="80" /></textarea><br>');
        $r->print('<input type="Submit" name="Submit" value="Send Question!"><br />');
    #    $r->print('<input type="submit" value="Next->">');
    #   $hidden_fields{'subject'} = $r->param('subject');
    #   $hidden_fields{'contentarea'} = $r->param('contentarea');
    #   $hidden_fields{'target'} = 'questions';
    #   $hidden_fields{'menu'} = 'compose';
    #   $hidden_fields{'step'} = 4;
    #   &hidden_fields($r, \%hidden_fields);
    #   $r->print('</form>');
    #} elsif ($step eq 4) {
    #   $r->print('<p>Step 4 of 4</p>');
    #    &question_progress($r);
        
        $r->print('<br>Select the areas of the '.$r->param('contentarea').' framework that this question involves.<br>');
        $r->print('<h6 align="center"><form name="form1" method="post" action="apprentice">');
        $r->print('<div id="frameworkSelector" align = "right">');
        &framework_selector($r, 'math');
        $r->print('</h6></div>');
        
  #     my $content = $r->param('content');
        $content =~ s/"/&quot;/g;
        $hidden_fields{'action'} = 'send';
        $hidden_fields{'content'} = $content;
        $hidden_fields{'contentarea'} = $r->param('contentarea');
        $hidden_fields{'subject'} = $r->param('subject');
        $hidden_fields{'target'} = 'questions';
        $hidden_fields{'menu'} = 'outbox';
        $hidden_fields{'step'} = 4;
        &hidden_fields($r, \%hidden_fields);
        $r->print('</form>');
        
    #}
    $r->print('</h5></div>');
    return 'ok';
    
}
sub lesson_lab_page {
    my ($r) = @_;
    $r->print('<div id="interiorHeader">');
    $r->print('<h2>Welcome to the PROM/SE LessonLab page</h2>');
  #	$r->print('<h3>Don'."'".'t Panic! You are not alone...</h3>');
    $r->print('</div>');
    
  #	$r->print('<a href="http://zuma.lessonlab.com:8080/remoteUserService/visibilityProxy?userName='.$Apache::Promse::env{'username'}.'&customerId=MISU001&destination=new3.lessonlab.com/llport.nsf?OpenDatabase%26login">Click Here</a>Once you have registered for your classes.');
		$r->print('<a href="http://zuma.lessonlab.com:8080/visibilityProxy?userName='.$Apache::Promse::env{'username'}.'&customerId=MISU001&destination=new3.lessonlab.com/llport.nsf?OpenDatabase%26login"><h6 align="right">Access LessonLab courses</h6></a><br>');
	# just a try	$r->print('<a href="http://zuma.lessonlab.com:8080/portal/main.do?userName='.$Apache::Promse::env{'username'}.'&password=password"><h4 align="right">Access LessonLab courses</h4></a><br>');
	  $r->print('<div>');
    $r->print('<div>');
    $r->print('To register for a course, navigate to the following URL:');
    $r->print('</div>');
    $r->print('<div>');
    $r->print('<a href="http://orders.lessonlab.com/msu.htm">Order lesson from LessonLab</a>');
    $r->print('</div><br>');    
    $r->print('Registering for a Break Through Math Course');
    $r->print('</div>');
    $r->print('<div>');
  #	$r->print('COURSE DEADLINES: ');    
    $r->print('</div>');
    $r->print('<table><tr><td colspan="3">COURSE DEADLINES: </td></tr>');
    $r->print('<tr><td>REGISTRATION DEADLINE</td><td>COURSE START DATE</td><td>COURSE COMPLETION DATE</td></tr>');
    $r->print('<tr><td>November 7, 2005</td><td>November 15, 2005</td><td>December 23, 2005</td></tr>');
    $r->print('<tr><td>December 28, 2005 </td><td>January 5, 2006</td><td>February 15, 2006</td></tr>');
    $r->print('<tr><td>February 10, 2006</td><td>February 15, 2006</td><td>March 30, 2006</td></tr>');
    $r->print('<tr><td>March 25, 2006</td><td>March 30, 2006</td><td>May 5, 2006</td></tr>');
    $r->print('<tr><td>April 25, 2006</td><td>May 5, 2006</td><td>June 15, 2006</td></tr>');
    $r->print('</table>');                 

    $r->print('<div>');
    $r->print('At this registration website, you will be able to select the course you wish to participate in and will also be asked to supply a mailing address (you must supply a street address, not a P.O. Box) and phone number so that LessonLab can ship you the course materials you will need before the online course begins.');
    $r->print('</div>');
    $r->print('<div>');
    $r->print('Please note: The course selections will not be available on the website after the registration deadline, so you must register by the registration deadline in order to take the course.');
    $r->print('</div>');
    $r->print('</frameset>');
    return;
}

sub compose_answer_form {
    my ($r) = @_;    
    my $message_id = $r->param('messageid');
    my $reply_id;
    my $destination_menu;
    my $sender;
    my $recipient;
    my $subject;
    my $content;
    my $selected;
    my $message_hashref;
    my $action = $r->param('action');
    $destination_menu = 'outbox';
    if ($r->param('menu') eq 'drafts') {
        print "<span>Editing a draft</span>";
        $message_hashref = &retrieve_message($r->param('messageid'));
        $subject = $$message_hashref{'subject'};
        $content = $$message_hashref{'content'};
        $recipient = $$message_hashref{'recipient'};
        $destination_menu = 'drafts';
    }
    my $url = "mentor";    
    $r->print('<div id="composeAnswer">');  
    $r->print('<p><strong>Compose Answer:</strong></p>');    
    print '<form name="form1" method="post" action="'.$url.'">';

    print '<p><textarea name="content" cols="55" rows="10">'.$content.'</textarea></p>';
    print '';
    print '<p><input name="Submit" type="submit" id="Save Answer" value="Save Answer">';
    print '<input type="hidden" name="token" value="'.$Apache::Promse::env{'token'}.'">';
    if ($action eq 'Reply') {
        print '<input type="hidden" name="reply" value="true">';
    }
    print '<input type="hidden" name="messageid" value="'.$message_id.'">';
    print '<input type="hidden" name="replyid" value="'.$reply_id.'">';
    print '<input type="hidden" name="target" value="questions">';
    print '<input type="hidden" name="menu" value="'.$destination_menu.'">';
    print '<input type="hidden" name="action" value="send">';
    print '<input type="submit" name="Submit" value="Submit Answer"></form></p>';
    print '</div>';
#    $r->print('</td></tr></table>');
}

sub add_address_book {
    my ($r) = @_;
    my @add_users = $r->param('adduser');
    # my $dbh = &db_connect();
    my $qry;
    foreach my $recipient_id (@add_users) {
        $qry = "insert into address_book (user_id, recipient_id) values (".$Apache::Promse::env{'user_id'}.", $recipient_id)";
        my $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
        $sth->execute();
    }
    return 'ok';
}
sub delete_address_book {
    my ($r) = @_;
    my @del_users = $r->param('deluser');
    # my $dbh = &db_connect();
    my $qry;
    my $where_clause;
    foreach my $recipient_id (@del_users) {
        $where_clause .= " recipient_id = $recipient_id or";
    }
    $where_clause =~ m/(.*)(or$)/;
    $qry = "delete from address_book where user_id = ".$Apache::Promse::env{'user_id'}." and (".$1.")";
    my $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    return 'ok';
}
sub get_address_book {
    my ($r) = @_;
    my %address_book_hash;
    my $qry = "select id, lastname, firstname from users, address_book where user_id = ".$Apache::Promse::env{'user_id'}." and id = recipient_id order by lastname, firstname";
    my $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    while (my $row = $sth->fetchrow_hashref) {
       $address_book_hash{$$row{'lastname'}.$$row{'firstname'}.$$row{'id'}}={%$row};
    }
    return \%address_book_hash;
}
sub address_book {
    my ($r) = @_;
    # start by showing all users, will need to filter later (soon, I hope!)
    my $qry = "select id, lastname, firstname from users where id <> ALL ";
    $qry.= "(select recipient_id from address_book where user_id = ".$Apache::Promse::env{'user_id'}." ) order by lastname, firstname";
    my $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    $r->print('<h4>Address Book</h4>'."\n");
    $r->print('<div class="floatLeft">'."\n");
    $r->print('<div id="addressScroller">'."\n");
    $r->print('<table><caption>All Users</caption>'."\n");
    $r->print('<thead><tr><th scope="col">Select</th>'."\n");
    $r->print('<th scope="col">Name to Add</th>'."\n");
    $r->print('</tr>'."\n");
    $r->print('</thead>'."\n");
    $r->print('<tbody>'."\n");
    while (my $row = $sth->fetchrow_hashref) {
        print '<tr><td scope="row"><a href="home?token='.$Apache::Promse::env{'token'}.'&menu=address&action=addname&target=message&adduser='.$$row{'id'}.'">Add</a></td>';
        print '<td>'.$$row{'firstname'}." ".$$row{'lastname'}."</td></tr>";
    }
    $r->print('<tr class="bottomRow"><td colspan="2"></td></tr>'."\n");
    $r->print('</tbody></table>'."\n");
    $r->print('</div></div>'."\n");
    $qry = "select id, lastname, firstname from users, address_book where user_id = ".$Apache::Promse::env{'user_id'}." and id = recipient_id order by lastname, firstname";
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    $r->print('<div class="floatLeft">');
    $r->print('<div id="addressScroller">'."\n");
    $r->print('<table><caption>My Address Book</caption>'."\n");
    $r->print('<thead><tr><th scope="col">Select</th>'."\n");
    $r->print('<th scope="col">Name to Remove</th>'."\n");
    $r->print('</tr>'."\n");
    $r->print('</thead>'."\n");
    $r->print('<tbody>'."\n");
    if ($sth->rows) {
        
        while (my $row = $sth->fetchrow_hashref) {
            print '<tr><td scope="row"><a href="home?token='.$Apache::Promse::env{'token'}.'&menu=address&action=delname&target=message&deluser='.$$row{'id'}.'">Delete</a></td>';
            print '<td>'.$$row{'firstname'}." ".$$row{'lastname'}."</td></tr>";
        }
       
        
    } else {
        print "<span>There are no names in your address book</span>";
    }
    $r->print('<tr class="bottomRow"><td colspan="2"></td></tr>'."\n");
    $r->print('</tbody></table>'."\n");
    $r->print('</div></div>'."\n");
    $r->print('<div class="clear"></div>');
    return ;
}

sub admin_form {
    my ($r) = @_;
    my $offset;
    my $records = 50;
    my $where_clause;
    my $previous_offset;
    my $next_offset;
    my $start_letter;
    if ($r->param('offset')) {
        $offset = $r->param('offset');
        $next_offset = $offset + 50;
        $previous_offset = $offset - 50;
        if ($previous_offset < 0) {$previous_offset = 0;}
    } else {
        $offset = 0;
        $next_offset = 50;
        $previous_offset = 0;
    }
    if ($r->param('letter')) {
        $start_letter = $r->param('letter');
        $where_clause = " where lastname >= '".$r->param('letter')."' ";
        
    } else {
        $start_letter = 'A';
        $where_clause = " where lastname >= 'A' ";
    }
    my @alpha = qw(A B C D E F G H I J K L M N O P Q R S T U V W X Y Z);
    
    # my $dbh = &db_connect();
    my $light_color = "";
    my $dark_color = ' class="rowAlternate" ';
    my $row_color = $light_color;
    foreach my $letter(@alpha) {
        $r->print('<span>[<a href="admin?token='.$Apache::Promse::env{'token'}.'&target=userroles&letter='.$letter.'">'.$letter.'</a>]</span>');
    }
        $r->print('<br><span>[ <a href="admin?token='.$Apache::Promse::env{'token'}.'&target=userroles&letter='.$start_letter.'&offset='.$previous_offset.'">Previous Page</a> ]</span>');
        $r->print('<span>[ <a href="admin?token='.$Apache::Promse::env{'token'}.'&target=userroles&letter='.$start_letter.'&offset='.$next_offset.'">Next Page</a> ]</span>');
        $r->print('<table><caption>Please use the form below to set user permissions:</caption>');
	$r->print('<thead>');
        $r->print('<tr>');
        $r->print('<th scope="col">Name</th>');
        $r->print('<th scope="col">Teacher</th>');
        $r->print('<th scope="col">Associate</th>');
        $r->print('<th scope="col">Mentor</th>');
        $r->print('<th scope="col">Editor</th>');
        $r->print('<th scope="col">Admin</th>');
        $r->print('<th scope="col">Update</th>');
        $r->print('<th scope="col">Delete</th>');
        $r->print('</tr>');
	$r->print('</thead>');
	$r->print('<tbody>');

my $qry = "select users.id, lastname, firstname, ";
$qry .= "(select group_concat(roles.role) from userroles, roles where userroles.user_id  = users.id and roles.id = userroles.role_id) as roles from users ";
$qry .= $where_clause." order by lastname, firstname LIMIT $offset, $records";
#print "<tr> $qry</tr>";
my $sth = $Apache::Promse::env{'dbh'}->prepare($qry) or &logthis($Mysql::db_errstr);
$sth->execute();

while (my $row = $sth->fetchrow_hashref) {
    #foreach my $name_key (sort keys %names_hash) {
    my $user_id = $$row{'id'};
    my $roles = $$row{'roles'};
    my $display_name = $$row{'lastname'}.', '.$$row{'firstname'};
    
    print '<form name="form1" method="post" action="admin"> ';
    print '<tr valign="middle" '.$row_color.'> ';
    print '<td align="left"><a href="admin?userid='.$user_id.'&target=password&token='.$Apache::Promse::env{'token'}.'"><span>'.$display_name.'</span></a></td>';
    print '<td align="center"> ';    
    print '<input name="role" type="checkbox" value="Teacher" ';
    if ($roles =~ m/Teacher/){
        print ' checked></td>';
    } else {
        print '></td>';
    }
    print '<td align="center"> ';    
    print '<input name="role" type="checkbox" value="Apprentice" ';
    if ($roles =~ m/Apprentice/){
        print ' checked></td>';
    } else {
        print '></td>';
    }
    print '<td align="center"> ';
    print '<input type="checkbox" name="role" value="Mentor" ';
    if ($roles =~ m/Mentor/){
        print ' checked></td>';
    } else {
        print '></td>';
    }
    print '<td align="center"> ';
    print '<input type="checkbox" name="role" value="Editor" ';
    if ($roles =~ m/Editor/){
        print ' checked></td>';
    } else {
        print '></td>';
    }
    print '<td align="center"> ';
    print '<input type="checkbox" name="role" value="Administrator" ';
    if ($roles =~ m/Administrator/){
        print ' checked></td>';
    } else {
        print '></td>';
    }
    print '<td align="center"> <input type="submit" name="action" value="update"></td>';
    print '<td align="center"> <input type="submit" name="action" value="delete"></td>';
    print '</tr>';
    print '<input type="hidden" name="userid" value="'.$user_id.'">';
    print '<input type="hidden" name="token" value="'.$Apache::Promse::env{'token'}.'">';
    print '<input type="hidden" name="target" value="userroles"></form>';
    if ($row_color eq $light_color){
        $row_color = $dark_color;
    } else {
        $row_color = $light_color;
    }
}
    
print '</td></tr></table></table>';
}
sub log_visit {
    my ($resource_id) = @_;
    unless (defined $resource_id) {
        $resource_id = 0;
    }
    my %fields;
    $fields{'user_id'} = $Apache::Promse::env{'user_id'};
    $fields{'date'} = ' now() ';
    $fields{'resource_id'} = $resource_id;
    &save_record ('activity_log', \%fields);
    return 'ok';
}

sub reset_password {
    my ($r) = @_;
    my $target_user_id = $r->param('userid');
    $r->print('resetting password');
    my %id;
    my %fields;
    $id{'id'}=$target_user_id;
    $fields{'password'}= " 'password' ";
    &update_record('users', \%id, \%fields);
    
    return 'ok';
}

sub validate_user {
    # validates user and sets environment variables
    # user_id, username, token, target, action, etc.
    my ($r) = @_;
    my $qry;
    my $sth;
    my @row_ary;
    my $row_hashref;
    undef %Apache::Promse::env;
    $Apache::Promse::env{'dbh'} = &db_connect();
    if ($r->param('token')) {
        # assumption is we're maintaining a connection
        $qry = "select * from log where token = '".$r->param('token')."'";
        $sth = $Apache::Promse::env{'dbh'}->prepare($qry);  
        $sth->execute;
        &logthis($sth->rows.' rows found');
        if ($sth->rows) {
            # for now, simply finding the token is sufficient
            # later we'll check how old it is
            $row_hashref = $sth->fetchrow_hashref;
            $Apache::Promse::env{'user_id'} = $$row_hashref{'user_id'};
            $Apache::Promse::env{'token'} = $r->param('token');
            $Apache::Promse::env{'username'} = &token_to_username($Apache::Promse::env{'token'});
            # update the log table with current time
            $qry = "update log set last_act = now() where token = '".$r->param('token')."'";
            $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
            $sth->execute;
            &logthis($qry);
        }
        if ($r->param('action')) {
            $Apache::Promse::env{'action'} = $r->param('action');
        } else {
            $Apache::Promse::env{'action'} = 'undefined';
        }
        if ($r->param('target')) {
            $Apache::Promse::env{'target'} = $r->param('target');
        } else {
            $Apache::Promse::env{'target'} = 'undefined';
        }
        if ($r->param('menu')) {
            $Apache::Promse::env{'menu'} = $r->param('menu');
        } else {
            $Apache::Promse::env{'menu'} = 'undefined';
        }
        
        # set the environment variables
    } elsif ($r->param('password')) {
        # it's a login situation
        # experimental at this point, lessonlab login
        #my $response = &Apache::Authenticate::login($r->param('username'),$r->param('password'));
        #if ($$response{'status'} ne '0') {
        #    &logthis('failed response from lessonlab');
        #    $Apache::Promse::env{'username'} = 'not_found';
        #} else {
            # if no token, check username and password for registered user
            $qry = "select Firstname, Lastname, username, id from users where username = ".
                &fix_quotes($r->param('username'))." and password = ".&fix_quotes($r->param('password'));
            $sth = $Apache::Promse::env{'dbh'}->prepare($qry);  
            $sth->execute;
            if ($sth->rows) {
                # grab the info from the users table and save it
                $row_hashref = $sth->fetchrow_hashref;
                my $user_id = $$row_hashref{'id'};
                $Apache::Promse::env{'username'} = $$row_hashref{'username'};
                $Apache::Promse::env{'user_id'} = $$row_hashref{'id'};
                # use the username address to create the token through md5
                # later we'll add a random element to the token to avoid hackers
                $qry = "select md5('".$Apache::Promse::env{'username'}."')";
                $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
                $sth->execute;
                @row_ary = $sth->fetchrow_array;
                $Apache::Promse::env{'token'} = $row_ary[0];
                # add record to log table
                my %fields;
                $qry = "delete from log where user_id = ".$user_id;
                $Apache::Promse::env{'dbh'}->do($qry);
                $fields{'login'} = " now() ";
                $fields{'user_id'} = " ".$user_id." ";
                $fields{'token'} = "'".$Apache::Promse::env{'token'}."'";
                $fields{'last_act'} = " now() ";
                &save_record('log', \%fields);
            } else {
                # no match with username and password
                $Apache::Promse::env{'username'} = 'not_found';
            }
        #}
    } else {
        # no idea why it would get here
        $Apache::Promse::env{'username'} = 'not_found';
    }
    return;
}

sub delete_user {
    my ($r) = @_;
    my $return_message;
    my $user_id = $r->param('userid');
    my $qry = "delete from users where id = $user_id";
    # my $dbh = &db_connect();
    my $sth = $Apache::Promse::env{'dbh'}->prepare($qry);  
    $sth->execute;
    $return_message .= $sth->errstr;
    $qry = "delete from userroles where user_id = $user_id";
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);  
    $sth->execute;
    $return_message .= $sth->errstr;
    return $return_message;
}
sub update_user_roles {
    my ($r, $user_id) = @_;
    unless ($user_id) {
        $user_id = $r->param('userid');
    }
    my @roles = $r->param('role');
    # my $dbh = &db_connect();
    my $qry;
    my $sth;
    my $where_clause;
    # first we will get rid of existing roles
    $qry = "delete from userroles where user_id = $user_id";
    $Apache::Promse::env{'dbh'}->do($qry);
    # now need to retrieve the role id numbers from userroles
    foreach my $role (@roles) {
        $where_clause .= " role = '".$role."' or";
    }
    $where_clause =~ m/(.*)(or$)/;
    $qry = "select * from roles where ".$1;
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute;
    while (my @roleids = $sth->fetchrow_array) {
        $qry = "insert into userroles (user_id, role_id) values ('".$user_id."',".$roleids[0].")";
        $Apache::Promse::env{'dbh'}->do($qry);
        #$r->print ("adding".$roleids[0]."<br />");
    }
    return $qry;
}
sub retrieve_users {
    my $qry = "select * from users t1,"; 
    return 'ok';
}
sub authenticate {
    my ($role) = @_;
    # my $dbh = &db_connect();
    my $qry;
    my $sth;
    # check if user has authority to access this role function
    $qry = "select * from userroles, roles where user_id = '".$Apache::Promse::env{'user_id'}."' and userroles.role_id = roles.id and roles.role = '$role'";
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute;
    my $num_rows = $sth->rows;
    if ($num_rows > 0) {
        return 'ok';
    } else {
        return 'not ok';
    }
}
sub llab_authenticate {
    my ($role) = @_;
    &Apache::Authenticate::llab_;
    return;
}
sub username_to_userid {
    my ($username) = @_;
    my $user_id;
    # my $dbh = &db_connect();
    my $sth;
    my $qry = "select id from users where username = '$username'";
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute;
    my @row = $sth->fetchrow_array;
    $user_id = $row[0];
    return $user_id;
}

sub add_new_user {
    my ($r) = @_;
    my $qry;
    my $sth;
    my %fields;
    my $email=$r->param("email");
    my $upload_dir = "/var/www/html/images";
    my $upload_filehandle = $r->upload('photo');
    my $file_name = $r->param('photo');
    $file_name = &fix_filename($file_name);
    # this get the user into the MySQL database
    $fields{'firstname'}=&fix_quotes($r->param("firstname"));
    $fields{'lastname'}=&fix_quotes($r->param("lastname"));
    $fields{'email'}=&fix_quotes($r->param('email'));
    $fields{'state'}=&fix_quotes($r->param("state"));
    $fields{'username'}=&fix_quotes($r->param("username"));
    $fields{'photo'}=&fix_quotes($file_name);
    $fields{'password'}= &fix_quotes($r->param("password"));
    $fields{'bio'}=&fix_quotes($r->param("textarea"));
    my $user_id = &save_record('users',\%fields, 'id');
    # next, create the entry in the LessonLab LDAP
    
    # now handle the picture upload
    open UPLOADFILE, ">$upload_dir/$file_name";
    binmode UPLOADFILE;
    while ( <$upload_filehandle> ) { 
        print UPLOADFILE; 
    } 
    close UPLOADFILE;
    $qry = "select id from roles where role = 'Apprentice'";
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute;
    if (my @roleids = $sth->fetchrow_array) {
        undef %fields;
        $fields{'user_id'}=$user_id;
        $fields{'role_id'}=$roleids[0];
        &save_record('userroles',\%fields);
    }
    # now we read record from database for absolute confirmation that record was stored
    $qry = "select * from users where username ='".$Apache::Promse::env{'username'}."'";
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute;
    my $saved_record = $sth->fetchrow_hashref;
    return $saved_record;
}
sub user_name_exist {
    my ($username) = @_;
    my $status = 1; # 0 is ok, 1 is name exists
    my %fields;
    $fields{'llab_cn'} = &fix_quotes($username);
    # checks if username is available both in ldap and users table;
    if (@{&Apache::Promse::record_exist('users', \%fields)}==0) {
        # here if record doesnt' exist in MySQL
        # now check LDAP
        undef %fields;
        $fields {'cn'} = $username;
        if (&Apache::Authenticate::llab_ldap_search(\%fields) == 0) {
            $status = 0;
        } else {
            $status = 2;
        }
    }
    return $status;
}
sub record_exist {
    # currently handles only one field, later multiple fields
    my ($table, $fields) = @_;
    my $where_clause;
    my $qry = "select * from $table where ";
    foreach my $field_name (keys(%{$fields})){
        $where_clause .= $field_name."=".${$fields}{$field_name}.' and ';
    }
    $where_clause =~ s/ and $//;
    $qry .= $where_clause;
    # my $dbh = &db_connect();
    my $sth = $Apache::Promse::env{'dbh'}->prepare($qry);  
    $sth->execute;
    my @found_record = $sth->fetchrow_array;
    return (\@found_record);
}
sub token_to_userid {
    my ($token) = @_;
    my $user_id;
    my $qry;
    # my $dbh = &db_connect();
    $qry = "select user_id from log where token = '".$token."'";
    my $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute;
    my @rs_userid = $sth->fetchrow_array;
    $user_id = $rs_userid[0];
    return $user_id;
}
sub userid_to_display_name {
    my ($user_id) = @_;
    my $display_name;
    my $qry = "select lastname, firstname from users where id = $user_id.";
    # my $dbh = &db_connect();
    my $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute;
    my $row = $sth->fetchrow_hashref;
    $display_name = $$row{'firstname'}." ".$$row{'lastname'};
    return $display_name;    
}
sub username_to_display_name {
    my ($username)=@_;
    my $display_name;
    my $qry = "select lastname, firstname from users where username = '".$username."'";
    # my $dbh = &db_connect();
    my $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute;
    my $row = $sth->fetchrow_hashref;
    $display_name = $$row{'firstname'}." ".$$row{'lastname'};
    return $display_name;    
}
sub token_to_username {
    my ($token)=@_;
    my $username;
    my $qry;
    # my $dbh = &db_connect();
    my $user_id = &token_to_userid($token);
    $qry = "select username from users where id = '".$user_id."'";
    my $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute;
    my @rs_username = $sth->fetchrow_array;
    $username = $rs_username[0];
    return $username;
}

sub top_of_page_menus {
    my ($r, $screen) = @_;
    my $display_name = &username_to_display_name($Apache::Promse::env{'username'});
    my $user_roles = &get_user_roles($Apache::Promse::env{'token'});
    my $teacher_associate;
    if (($user_roles =~ m/Teacher/)  && ($user_roles !~ m/Apprentice/)) {
        $teacher_associate = "Teacher";
    } elsif ($user_roles =~ m/Apprentice/) {
        $teacher_associate = "Associate";
    }
    print $r->header();
    my $output = q~
    <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
    <html lang="en" xml:lang="en">
    <!-- Above is the Doctype for strict xhtml -->
    <head>
    <!-- Unicode encoding -->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>PROMSE</title>
    <meta name="description" content="PROM/SE - Promoting rigorous outcomes in K-12 mathematics and science education" />
    <meta name="keywords" content="prom/se, PROM/SE, promse, PROMSE, K-12, K-12 mathematics, K-12 science, K-12 education, math, science" />
    <!-- Use the import to use more sophisticated css. Lower browsers (less then 5.0) do not process the import instruction, will default to structural markup -->
    <style type="text/css" media="all">@import "../_stylesheets/advanced.css";</style>
    <script src="../_scripts/general.js" type="text/javascript" charset="utf-8"></script>
    <script src="../_scripts/video.js" type="text/javascript" charset="utf-8"></script>
    <SCRIPT language="JavaScript">
    //Redirect if Mac IE
    if (navigator.appVersion.indexOf("Mac")!=-1 && navigator.appName.substring(0,9) == "Microsoft") {
    	window.location="mac_ie_note.html";
    }
    
    </SCRIPT>
    </head>
    ~;
    $r->print($output);
    $output = q~
    <body id="M" onload="onloadFunctions('Home','NULL');">
    <div id="wrapper">
	<div id="wrapperNavLogoBar">
            <div id="barTop">
                <h3 id="skip">
       ~;
                $r->print($output);
                $r->print ($display_name.' Currently Logged In | <a href="logout?token='.$Apache::Promse::env{'token'}.'">Logout</a>');
    $output=q~
                </h3>
		<span class="noShow">PROM/SE: Promoting Rigorous Outcomes in Mathematics and Science Education</span>
            </div>
            <div id="barContent">
                <ul id="navPersistent">
            ~;
  
    $r->print($output);
    $r->print('<li id="liNavHome"><span class="nav"><a href="home?token='.$Apache::Promse::env{'token'}.'" id="navHome" title="Home">Home <img src="../_images/BannerDnArrow.gif" width="7" height="4" alt="" /></a></span>'."\n");
    $r->print('<ul id="navPersistent">'."\n");
    $r->print('<li id ="navPersistent"><span class="nav"><a href="home?token='.$Apache::Promse::env{'token'}.';target=message;menu=inbox;sortfield=date" title="Messaging">Messaging</a></span></li>'."\n");
    $r->print('<li><span class="nav"><a href="home?token='.$Apache::Promse::env{'token'}.';target=discussion;menu=inbox" title="Discussion">Discussion</a></span></li>'."\n");
    $r->print('<li><span class="nav"><a href="home?token='.$Apache::Promse::env{'token'}.';target=whoson;menu=inbox" title="Who&#39s On">Who&#39s On</a></span></li>'."\n");
    $r->print('<li><span class="nav"><a href="home?token='.$Apache::Promse::env{'token'}.';target=whosclose;menu=inbox" title="Who&#39s Close">Who&#39s Close</a></span></li>'."\n");
    $r->print('<li><span class="nav"><a href="home?token='.$Apache::Promse::env{'token'}.';target=preferences;menu=inbox" title="Preferences">User Setting</a></span></li>'."\n");
    $r->print('<li><span class="nav"><a href="home?token='.$Apache::Promse::env{'token'}.';target=help" title="Help">Help</a></span></li>'."\n");
    $r->print('</ul>'."\n");
    $r->print('</li>'."\n");
    $r->print('<li id="liNavAssociates"><span class="nav"><a href="apprentice?token='.$Apache::Promse::env{'token'}.'" id="navAssociates" title="'.$teacher_associate.'">'.$teacher_associate.'<img src="../_images/BannerDnArrow.gif" width="7" height="4" alt="" /></a></span>'."\n");
    $r->print('<ul>'."\n");
    $r->print('<li><span class="nav"><a href="apprentice?token='.$Apache::Promse::env{'token'}.';target=search;menu=inbox" title="Search">Search</a></span></li>'."\n");
    $r->print('<li><span class="nav"><a href="apprentice?token='.$Apache::Promse::env{'token'}.';target=framework;menu=browse" title="Framework">Framework</a></span></li>'."\n");
    $r->print('<li><span class="nav"><a href="apprentice?token='.$Apache::Promse::env{'token'}.';target=frameworkreporter;step=1" title="Framework">Alignment</a></span></li>'."\n");
    $r->print('<li><span class="nav"><a href="apprentice?token='.$Apache::Promse::env{'token'}.';target=questions;menu=inbox" title="Questions">Questions</a></span></li>'."\n");
    $r->print('</ul>'."\n");
 
    
    $r->print('</li>'."\n");
    if ($user_roles =~ m/Mentor/) {  
        $r->print('<li id="liNavMentors"><span class="nav"><a href="mentor?token='.$Apache::Promse::env{'token'}.'" id="navMentor" title="Mentors">Mentors <img src="../_images/BannerDnArrow.gif" width="7" height="4" alt="" /></a></span>'."\n");
        $r->print('<ul >'."\n");
        $r->print('<li><span class="nav"><a href="mentor?token='.$Apache::Promse::env{'token'}.';target=questions;menu=inbox" title="Answer Questions">Answer Questions</a></span>'."\n");
        $r->print('<li><span class="nav"><a href="mentor?token='.$Apache::Promse::env{'token'}.';target=resource;menu=browse" title="Resources">Resources</a></span></li>'."\n");
        $r->print('<li><span class="nav"><a href="mentor?token='.$Apache::Promse::env{'token'}.';target=framework;menu=browse" title="Framework">Framework</a></span></li>'."\n");
        $r->print('<li><span class="nav"><a href="mentor?token='.$Apache::Promse::env{'token'}.';target=ohiomath;menu=browse" title="Ohio Math">Ohio Math</a></span></li>'."\n");
        $r->print('</ul>'."\n");
        $r->print('</li>'."\n");
      
    }
    if ($user_roles =~ m/Editor/) {  
        $r->print('<li id="liNavEditor"><span class="nav"><a href="editor?token='.$Apache::Promse::env{'token'}.'" id="navEditor" title="Editor">Editor <img src="../_images/BannerDnArrow.gif" width="7" height="4" alt="" /></a></span>'."\n");
        $r->print('<ul>'."\n");
        $r->print('<li><span class="nav"><a href="editor?token='.$Apache::Promse::env{'token'}.';target=resource;menu=browse" title="Resources">Resources</a></span></li>'."\n");
        $r->print('<li><span class="nav"><a href="editor?token='.$Apache::Promse::env{'token'}.';target=keyword;menu=browse" title="Keywords">Keywords</a></span></li>'."\n");
        $r->print('<li><span class="nav"><a href="editor?token='.$Apache::Promse::env{'token'}.';target=curriculum;step=1" title="Keywords">Curriculum</a></span></li>'."\n");
        $r->print('</ul>'."\n");
        $r->print('</li>'."\n");
    }
    if ($user_roles =~ m/Admin/) {  
        $r->print('<li id="liNavAdmin"><span class="nav"><a href="admin?token='.$Apache::Promse::env{'token'}.'" id="navAdmin" title="Admin">Admin <img src="../_images/BannerDnArrow.gif" width="7" height="4" alt="" /></a></span>'."\n");
        $r->print('<ul>'."\n");
        $r->print('<li><span class="nav"><a href="admin?target=userroles;token='.$Apache::Promse::env{'token'}.'" title="User Roles">User Roles</a></span>'."\n");
        $r->print('<li><span class="nav"><a href="admin?target=partners;token='.$Apache::Promse::env{'token'}.'" title="Partners, etc">Partners, etc.</a></li></span>'."\n");
        $r->print('<li><span class="nav"><a href="admin?target=schedule&token='.$Apache::Promse::env{'token'}.'&menu=browse" title="Announcements">Announcements</a></span></li>'."\n");
        $r->print('</ul>'."\n");
        $r->print('</li>'."\n");
     }
    $output = q~  
            </ul>
            </div>
            <div id="barBottom">
            <img src="../_images/BannerBot.jpg" width="770" height="12" alt="" />
            </div>
            
    ~;
    $r->print($output);
    $r->print ('</div>'."\n");
    $r->print('<div id="wrapperColumn">'."\n");
    $r->print('<div id="mainColumn">'."\n");
    $r->print('<div id="interiorContent">'."\n");
    return 'ok';
}

sub footer {
    my ($r) = @_;
    $r->print('</div>'."\n".'</div>'."\n");
    my $output = q~
        <div id="wrapperFooter">
        
        <hr />
        <ul id="footerPartnerList">
        <li id="footerLiNSF"><a href="overview/partners.html#NSF" title="National Science Foundation"><span>National Science Foundation</span></a></li>
        <li id="footerLiSMART"><a href="overview/partners.html#SMART" title="SMART Consortium"><span>SMART Consortium</span></a></li>
        <li id="footerLiAIMS"><a href="overview/partners.html#AIMS" title="High AIMS Consortium"><span>High AIMS Consortium</span></a></li>
        <li id="footerLiIngham"><a href="overview/partners.html#Ingham" title="Ingham County Intermediate School District"><span>Ingham County Intermediate School District</span></a></li>
        <li id="footerLiCalhoun"><a href="overview/partners.html#Calhoun" title="Calhoun County Intermediate School District"><span>Calhoun County Intermediate School District</span></a></li>
        <li id="footerLiStClair"><a href="overview/partners.html#StClair" title="St. Clair County Regional Educational Service Agency"><span>St. Clair County Regional Educational Service Agency</span></a></li>
        <li id="footerLiMSU"><a href="overview/partners.html#MSU" title="MSU PROM/SE Project"><span>MSU PROM/SE Project</span></a></li>
        <li id="footerLiMSUInfo"> MSU PROM/SE Project, Michigan State University, 236 Erickson Hall, East Lansing, MI 48824, phone 517/353-4884, fax 517/432-0132.</li>
        </ul>
        <p>
        www.promse.msu.edu. PROM/SE is funded by the National Science Foundation under Cooperative Agreement Grant No. EHR-0314866.
        </p>
        </div>
        </div>
        </div>
    </div>
</div>
</body>
</html>
~;
$r->print($output);
# print $r->end_html();
return ();
}

sub top_of_page {
    my ($r) = @_;
    print $r->header();
    my $output = q~
    <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
    <html lang="en" xml:lang="en">
    <!-- Above is the Doctype for strict xhtml -->
    <head>
    <!-- Unicode encoding -->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>PROMSE</title>
    <meta name="description" content="PROM/SE - Promoting rigorous outcomes in K-12 mathematics and science education" />
    <meta name="keywords" content="prom/se, PROM/SE, promse, PROMSE, K-12, K-12 mathematics, K-12 science, K-12 education, math, science" />
    <!-- Use the import to use more sophisticated css. Lower browsers (less then 5.0) do not process the import instruction, will default to structural markup -->
    <style type="text/css" media="all">@import "../_stylesheets/advanced.css";</style>
    <script src="../_scripts/general.js" type="text/javascript" charset="utf-8"></script>
    <SCRIPT language="JavaScript">
    //Redirect if Mac IE
    if (navigator.appVersion.indexOf("Mac")!=-1 && navigator.appName.substring(0,9) == "Microsoft") {
    	window.location="mac_ie_note.html";
    }
     </SCRIPT>
    </head>
    ~;
    $r->print($output);
    $output = q~
    <body id="M" onload="onloadFunctions('Home','NULL');">
    <div id="wrapper">
	<div id="wrapperNavLogoBar">
            <div id="barTop">
                <h3 id="skip"></h3>
		<span class="noShow">PROM/SE: Promoting Rigorous Outcomes in Mathematics and Science Education</span>
            </div>
            <div id="barContent">
                <ul id="navPersistent" >
                <li id="liNavHome"><a href="login" id="navHome" title="Login">Login</a></li>
                <li id="liNavRegister"><a href="register?target=new" id="navRegister" title="Register">New User Registration</a></li>
                </ul>
            </div>
            <div id="barBottom">
                <img src="../_images/BannerBot.jpg" width="770" height="12" alt="" />
            </div>
        </div>
    
    ~;
    $r->print ($output);
    my $screen = 'home';
    $r->print('<div id="wrapperColumn">');
    $r->print('<div id="mainColumn">');
    $r->print('<div id="interiorContent">');
    return ();
}
sub get_locations {
    my ($r) = @_;
    my $qry = "";
    my $sth;
    $qry = "select location_id, school, Grade_range from locations order by school";
    $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute();
    return $sth;
}


sub curriculum {
    my ($r) = @_;
    my $step = $r->param('step');
    my %hidden_fields;
    $r->print('Build curriculum<br />');
    if ($step eq 1) {
        my $sth = &get_locations();
        $r->print('Select the Location<br />');
        $r->print('<form method="post" action="editor">');
        $r->print('<select name="location">');
        while (my $row = $sth->fetchrow_hashref()) {
            $r->print('<option value="'.$$row{'location_id'}.'">'.$$row{'school'}.'</option>');
        }
        $r->print('</select>');
        $hidden_fields{'target'} = 'curriculum';
        $hidden_fields{'step'} = 2;
        &hidden_fields($r, \%hidden_fields);
        $r->print('<hr align="center" width="100%" />');
        $r->print('<p>&nbsp;<input type="submit" value="Next->">&nbsp;</p>');
        $r->print('</form>');
         
    } elsif ($step eq 2) {
        $r->print('Select the Subject<br />');
        $r->print('<form method="post" action="editor">');
        $r->print('<select name="subject"><option>Math</option><option>Science</option></select>');
        $hidden_fields{'target'} = 'curriculum';
        $hidden_fields{'step'} = 3;
        $hidden_fields{'location'} = $r->param('location');
        &hidden_fields($r, \%hidden_fields);
        $r->print('<hr align="center" width="100%" />');
        $r->print('<p>&nbsp;<input type="submit" value="Next->">&nbsp;</p>');
        $r->print('</form>');
       
    }   elsif ($step eq 3) {
        $r->print('Select the Grade<br />');
        $r->print('<form method="post" action="editor">');
        $r->print('<select name="grade"><option>1</option><option>2</option><option>3</option><option>4</option>');
        $r->print('<option>5</option><option>6</option><option>7</option><option>8</option>');
        $r->print('<option>9</option><option>10</option><option>11</option><option>12</option></select>');
        $hidden_fields{'target'} = 'curriculum';
        $hidden_fields{'step'} = 4;
        $hidden_fields{'location'} = $r->param('location');
        $hidden_fields{'subject'} = $r->param('subject');
        &hidden_fields($r, \%hidden_fields);
        $r->print('<hr align="center" width="100%" />');
        $r->print('<p>&nbsp;<input type="submit" value="Next->">&nbsp;</p>');
        $r->print('</form>');
    }   elsif ($step eq 4) {  
        $r->print('Last step');
        $r->print('<form method="post" action="editor">');
        $r->print('<select name="curriculum"><option>Implemented</option><option>Achieved</option></select>');
        $hidden_fields{'target'} = 'curriculum';
        $hidden_fields{'step'} = 5;
        $hidden_fields{'location'} = $r->param('location');
        $hidden_fields{'subject'} = $r->param('subject');
        $hidden_fields{'grade'} = $r->param('grade');
        &hidden_fields($r, \%hidden_fields);
        $r->print('<hr align="center" width="100%" />');
        $r->print('<p>&nbsp;<input type="submit" value="Next->">&nbsp;</p>');
        $r->print('</form>');
    }   elsif ($step eq 5) {
        $r->print('Select the Framework Elements<br />');
        $r->print('<form method="post" action="editor">');
        $r->print('<div id="frameworkSelector">');
        &topic_selector($r, 'math');
        $r->print('</div><br>');
        $hidden_fields{'action'} = 'save';
        $hidden_fields{'target'} = 'curriculum';
        $hidden_fields{'step'} = 1;
        $hidden_fields{'curriculum'} = $r->param('curriculum');
        $hidden_fields{'location'} = $r->param('location');
        $hidden_fields{'subject'} = $r->param('subject');
        $hidden_fields{'grade'} = $r->param('grade');
        &hidden_fields($r, \%hidden_fields);
        $r->print('<hr align="center" width="100%" />');
        $r->print('<p>&nbsp;<input type="submit" value="Next->">&nbsp;</p>');
        $r->print('</form>'); 

    }
    return 'ok';
}
sub save_curriculum {
    my ($r) = @_;
    my @framework_codes = $r->param('frameworkcode');
    my $subject = $r->param('subject');
    my $location = $r->param('location');
    my $grade = $r->param('grade');
    my $curriculum = lc($r->param('curriculum'));
    my %fields;
    $fields{'subject'} = &fix_quotes($subject);
    $fields{'location_id'} = $location;
    $fields{'grade'} = $grade;
    foreach my $check (@framework_codes) {
        $fields{'framework_id'} = $check;
        &save_record($curriculum.'_curriculum', \%fields);
    }
    return 'ok';
}

sub add_user_form {
    my ($r) = @_;
    $r->print('<div id="interiorHeader">');
    $r->print('<h2>Professional Development: Virtual Professional Development</h2>');
    $r->print('<h3>PROM/SE New User Registration</h3>');
    $r->print('</div>');
    $r->print('<form name="form1" method="post" action="register">'."\n");
    $r->print('<fieldset>');
    $r->print('<label>First Name</label>');
    $r->print('<input name="firstname" type="text" id="firstname" value="" size="35">');
    $r->print('<label>Last Name</label>');
    $r->print('<input name="lastname" type="text" id="lastname" value="" size="35">');
    $r->print('<label>Email Address</label>');
    $r->print('<input name="email" type="text" id="email" value="" size="25">');
    $r->print('<label>Please check all that apply.</label>');
    $r->print('<label>I teach 6th grade</label><input type="checkbox" name="checkbox" value="6">');
    $r->print('<label>I teach 7th grade</label><input type="checkbox" name="checkbox" value="7">');
    $r->print('<label>I teach 8th grade</label><input type="checkbox" name="checkbox" value="8">');
    $r->print('<label>User Name (e.g., MarySmith) </label>');
    $r->print('<input name="username" type="text" id="username" value="" size="25">');
    $r->print('<label>Password</label>');
    $r->print('<input name="password" type="password" id="password2" value="" size="25">');
    $r->print('<label>Bio</label>');
    $r->print('');
    $r->print('<textarea name="textarea" cols="55" rows="10"> </textarea>');
    $r->print('</fieldset>');
    $r->print('<input type="hidden" name="target" value="addrecord">');
    $r->print('<input name="Button" type="submit"  value="Register New Member">');
    $r->print('</form> ');
    return 'ok';
}

    
sub old_footer {
    my ($r) = @_;
    my $output;
$output = qq~   
        </td>  
    <tr align="left"> 
        <td width="5%" valign="top" background="../images/background_sidebar.jpg">
            <table width="100%" border="0" cellspacing="0" cellpadding="10">
                <tr>
                    <td class="sidebarcopyright">This material is based upon work supported 
                            by the National Science Foundation under Cooperative Agreement No. 
                            EHR-0314866. 
                    </td>
                </tr>
            </table> 
        </td>
        <td width="95%" valign="bottom">
            <table width="100%" border="0" cellspacing="0" cellpadding="10">
                <tr>
                    <td class="sidebarcopyright">This website is currently under development. You
                    are invited to offer suggestions to <a href="mailto:banghart\@msu.edu">Rick Banghart</a>.
                    </td>
                </tr>
                <tr>
                    <td class="copyright">&copy; MSU PROM/SE Project. <a href="http://www.msu.edu/">Michigan 
                          State University</a>. 516 Erickson Hall. East Lansing, MI 48824<br>
                          Phone: 517.353.4884. Fax: 517.432.0132. <a href="http://www.promse.msu.edu/">http://www.promse.msu.edu/</a>
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</body>
</html>
~;
$r-> print ($output);

}

sub user_not_valid {
    print qq~
    <table width="100%" border="0" cellspacing="0" cellpadding="10">
    <tr>
    <td align="left" valign="top">
    <p class="header">You are not logged in.</p>
    <p class="content">You can receive this page for any of several reasons. 
    <p class="content">You may have mis-typed your user name or your password, you may 
    have reached this page after logging out (by using your browser's back button) or you 
    may have been inactive on the site and were automatically logged out. 
    <p class="content">If you are registered you may wish to go back and <a href=promse>log in.</a></p>
    <p class="content">If you have not registered, you can do that by 
        <a href="register?target=new">clicking here.</a></p>
    </td>
    </tr>
    </table>
    ~;
}
sub mentor_rating {
print qq~                    <p class="content"><strong>RATING</strong></p>
                    <p class="content">You have a current rating of 8. You are in the 
                      top 95% of mentors based on your question/answer ratio. </p>
~;
return 'ok';                      
}
sub last_login {
    print '<br><span>last login info to go here</span><br>';
    return 'ok';
}

sub mentor_messages {
    print '<BR>Mentor messages to go here<br>';
    return 'ok';
}
sub logout {
    my ($r) = @_;
    my $qry;
    $qry = "delete from log where token = '".$Apache::Promse::env{'token'}."'";
    my $sth = $Apache::Promse::env{'dbh'}->prepare($qry);
    $sth->execute;
    return $qry;
}

sub help_system {
    my ($r) = @_;
    my $topic = $r->param('topic');
    if ($topic eq 'preferences') {
        print qq~
        <h4>Setting Preferences</h4>
        <div class="floatLeft">
        <div id="lookupScroller">
        <p class="content">The VPD has three kinds of preferences that you will want to set.
        You can set all three by going to the <strong>Home</strong> menu, and clicking on 
        <strong>Preferences</strong>. At the top of the page is a sub-menu where you can select 
        each of the three kinds of preferences: <strong>Profile, Interests,</strong> and <strong>Settings</strong></p>
        <strong>Profile</strong>
        <p class="content">Your profile describes you to others in the PROM/SE community. Be sure to 
        fill out your profile with information about what and where you teach. You can also update your
        email address, password, and your name, as it will be shown to others.</p>
        <p class="content">Be sure to click <strong>Save Changes</strong> when you are done making changes.</p>
        <strong>Note:</strong>
        <p class="content">If your browser is set to remember your password, you may find that the password field
        has asterisks in it. If you do not wish to change your password, you can still make other changes. When you
        click <strong>Save Changes</strong> changes in your Bio, name and email will be saved, but you will see
        a message indicating that the two password fields did not match, and the password was not changed.</p>
        </div>
        </div>
        <div class="floatLeft">
        <div id="lookupScroller">
        <strong>Interests</strong>
        <p class="content">Check the subject area topics that are of particular interest to you. 
        Remember that PROM/SE is about both giving and receiving support in teaching. When you click a 
        topic area of interest, enter a level of 1 (low), 2 (med), or 3 (high). </p>
        <p class="content">The VPD will use this information to help target resources and people. Where you 
        are strong (where you entered 3), you may receive questions about an area. Where you are less strong,
        you may receive messages recommending materials to support your understanding.</p>
        </div>
        </div>
        <div class="floatLeft">
        <div id="lookupScroller">
        <strong>Settings</strong>
        <p class="content">A number of features of the VPD are customizable. <strong>Settings</strong>
         allows you to change the way the PROM/SE environment works for you.</p>
         <p>As the VPD system is used, new customizable features will be added to the settings page.
         be sure to check back at the settings page to be sure that you have the settings that you prefer.</p>
        </div>
        </div>
         ~;
    } elsif ($topic eq 'finding'){
        print qq~
        <h4>Finding Resources</h4>
        <div id="lookupScroller">
        <p class="content">You can find resources to meet your learning and teaching needs by using the
        resource <strong>Search</strong> function. This is under the <strong>Teacher</strong> or <strong>
        Associate</strong> menu item.</p>
        <p>Here you can specify the <strong>subject area</strong>, the <strong>time commitment</strong> of
        the resources you are seeking.
        <p>In the <strong>Search for:</strong> box, you should type as much information as you can to 
        describe the content of your desired resources. For example, a good search phrase might be: <strong>
        teaching fractions using manipulatives with third graders</strong>.</p>
        <p class="content">After you click <strong>Search</strong> you will receive a list of the resources 
        available that most closely meet your criteria. Note the scores offered that show both how closely
        the resources meet your criteria, as well as how others who have used the resources rated them.</p>
        </div>
        ~;
    } elsif ($topic eq 'requirements'){
        print qq~
        <h4>System Requirements</h4>
        <div id="lookupScroller">
        <p class="content">The PROMSE VPD was developed using Firefox, on a PC platform.
        It is intended to be fully supported using any recent browser (e.g., Internet
        Explorer, Netscape, Firefox, Safari) on any computer (e.g., Windows, Mac, Linux). 
        If you encounter problems, please contact us and we will work to correct
        the problem.</p>
        
        </div>
        ~;
    } elsif ($topic eq 'passwords'){
        print qq~
        <h4>Forgotten Password</h4>
        <div id="lookupScroller">
        <p class="content">Passwords on the PROMSE VPD system are stored in clear text
        on our database. All reasonable efforts are made to keep passwords secure,
        but the VPD is not a "secure" website. That means that you should not use
        passwords that you may currently use for high-security situations. For example,
        it would be unwise to use your online banking password on the PROMSE VPD.</p>
        </div>
        ~;
    } elsif ($topic eq 'answering'){
        print qq~
        <h4>Answering Questions</h4>
        <div id="lookupScroller">
        <p class="content">The PROMSE VPD is intended to provide <strong>just in
        time</strong> answers to questions. If you are given a question to answer,
        it's very important to respond as quickly as possible to encourage new
        teachers to take advantage of this resource.</p>
        </div>
        ~;
    } else {
    print '<h4>Help Center</h4>';
    print '<p class="content">';
    print qq~
    <strong> Tagging resources </strong> means assigning descriptors and relationships to a teaching resource. for example,
    a lesson plan intended to teach 3rd grade students addition facts would be tagged as <strong>3rd grade</strong>, <strong>
    math</strong> (as its subject), and perhaps 1.1.2.3 as the index from the math framework.</p>
    <p class="content"><span>It is possible to assign any number of tags to a resource, and a tag can be just about anything that is found
    in the PROM/SE Virtual Professional Development environment. This includes keywords, framework cells, other resources,
    individuals, etc.</p>
    <p style="content">This is a dynamic system, being developed exclusively for PROMSE. The system is dynamic in several ways:</p>
    <ul><li class="content">It is tightly coupled with an underlying database, and responds dynamically based on the content of the database.
    <li class="content">The system is designed for the users, and its design changes dynamically (through programming changes) as users voice their concerns.
    </ul>
    <p class="content">A primary goal of this Professional Development environment is to be dynamically responsive to the needs
    of the users.
    <p class="content">
    ~;
    print '</p>';
}
    return();
}

1; 